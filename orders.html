<link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>

  <style>

    .orders-card,
.table-card,
.order-card,
.search-box,
.filter-select,
.orders-modal,
.orders-view .filters-row {
  background: #fff !important;
}

.table-wrapper,
.orders-table,
.orders-table td,
.orders-table th {
  background: #fff !important;
}

.filter-select {
  background: #fff !important;
}

.search-box {
  background: #fff !important;
  border: 1px solid var(--border);
}

.orders-modal .modal-header,
.orders-modal .modal-body,
.orders-modal .modal-footer {
  background: #fff !important;
}

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
     
.orders-view {
  padding:22px;
  background:transparent;
  min-height:100vh;
}

.orders-modal .modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}


.orders-top {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:16px;
  margin-bottom:18px;
  flex-wrap:wrap;
}

.orders-title {
  font-family:'Outfit',sans-serif;
  font-size:1.2rem;
  font-weight:700;
  color:var(--dark);
}

.orders-sub {
  font-size:0.9rem;
  color:var(--muted);
  margin-top:4px;
}

.orders-controls {
  display:flex;
  gap:12px;
  align-items:center;
  flex-wrap:wrap;
}

.orders-card {
  background:var(--card-bg);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:14px;
  border:1px solid var(--border);
  display:flex;
  gap:12px;
  align-items:center;
  flex-wrap:wrap;
}

.filter-select,
.search-box {
  padding:10px 14px;
  border-radius:10px;
  border:1px solid var(--border);
  background:transparent;
  font-size:0.95rem;
  min-width:160px;
}

.search-box {
  display:flex;
  gap:8px;
  align-items:center;
  min-width:260px;
  max-width:420px;
}

.search-box input {
  border:0;
  outline:none;
  background:transparent;
  width:100%;
  font-size:0.95rem;
}

.btn-primary {
  background:var(--dark);
  color:var(--secondary);
  border-radius:10px;
  padding:9px 14px;
  border:none;
  cursor:pointer;
  font-weight:700;
}

.btn-ghost {
  background:transparent;
  border:1px solid var(--border);
  padding:8px 12px;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
}

.table-card {
  margin-top:16px;
  background:var(--card-bg);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:16px;
  border:1px solid var(--border);
}

.table-wrapper {
  overflow:auto;
}

.orders-table {
  width:100%;
  border-collapse:collapse;
  min-width:900px;
  font-size:0.95rem;
}

.orders-table thead th {
  text-align:left;
  padding:12px 16px;
  font-weight:700;
  color:var(--dark);
  border-bottom:1px solid var(--border);
}

.orders-table td {
  padding:12px 16px;
  border-bottom:1px solid var(--border);
  vertical-align:middle;
  color:var(--dark);
}

.status-pill {
  display:inline-block;
  padding:6px 10px;
  border-radius:999px;
  font-weight:700;
  font-size:0.75rem;
}

.status-pending {background:rgba(245,158,11,0.08); color:#f59e0b; border:1px solid rgba(245,158,11,0.12);}
.status-confirmed {background:rgba(59,130,246,0.08); color:#3b82f6; border:1px solid rgba(59,130,246,0.12);}
.status-shipped {background:rgba(16,185,129,0.08); color:#10b981; border:1px solid rgba(16,185,129,0.12);}
.status-delivered {background:rgba(101,163,13,0.08); color:#65a30d; border:1px solid rgba(101,163,13,0.12);}
.status-cancelled {background:rgba(239,68,68,0.08); color:#ef4444; border:1px solid rgba(239,68,68,0.12);}

.action-btn {
  border-radius:8px;
  border:0;
  padding:8px;
  background:transparent;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  font-size:0.95rem;
}

.action-btn .fa-eye {color:var(--dark);}
.action-btn .fa-edit {color:var(--success);}

.mobile-cards {
  display:none;
  gap:12px;
  margin-top:12px;
}

.order-card {
  background:var(--card-bg);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:14px;
  border:1px solid var(--border);
}

.card-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}

.customer-name {
  font-weight:600;
  color:var(--dark);
}

.card-meta {
  color:var(--muted);
  font-size:0.85rem;
}

.orders-modal-bg {
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(6,8,15,0.6);
  z-index:1200;
  padding:20px;
}

.orders-modal-bg.show {
  display:flex;
}

.orders-modal {
  width:100%;
  max-width:760px;
  border-radius:12px;
  overflow:hidden;
  background:var(--card-bg);
  box-shadow:var(--shadow);
  border:1px solid var(--border);
}

.orders-modal .modal-header,
.orders-modal .modal-body,
.orders-modal .modal-footer {
  padding:14px 16px;
}

.empty-state {
  text-align:center;
  padding:36px 12px;
  color:var(--muted);
}

.oh-toast {
  position:fixed;
  right:22px;
  bottom:22px;
  padding:12px 16px;
  background:var(--card-bg);
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  border-left:4px solid var(--success);
  z-index:1400;
  display:flex;
  gap:10px;
  align-items:center;
  transform:translateY(10px);
  opacity:0;
  transition:all .2s ease;
}

.oh-toast.show {
  opacity:1;
  transform:translateY(0);
}

@media (max-width:1023px) {
  .table-wrapper { display:none; }
  .mobile-cards { display:flex; flex-direction:column; }
  .orders-controls { width:100%; flex-direction:column; }
  .orders-card { width:100%; flex-direction:column; }
  .search-box, .filter-select {
    width:100%;
    max-width:100%;
  }
}

@media (max-width:768px) {
  .orders-title { font-size:1.1rem; }
  .orders-sub { font-size:0.85rem; }
  .orders-card { padding:12px; }
  .orders-modal { width:100%; max-width:90%; }
}

@media (max-width:480px) {
  .orders-view { padding:14px; }
  .orders-card { padding:10px; }
  .orders-table td, 
  .orders-table th {
    padding:8px 10px;
  }
  .orders-modal {
    width:calc(100% - 20px);
  }
}

  </style>

</head>
<body>
  <div class="page-container">
    <div class="orders-view fade-in">

      <div class="orders-top">
        <div>
          <div class="orders-title">Order Management</div>
          <div class="orders-sub muted">Manage and track customer orders</div>
        </div>

        <div class="orders-controls">
          <div class="orders-card filters-row">
            <select id="ov-status" class="filter-select" title="Filter by status">
              <option value="all">All Orders</option>
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="shipped">Shipped</option>
              <option value="delivered">Delivered</option>
              <option value="cancelled">Cancelled</option>
            </select>

            <select id="ov-date" class="filter-select" title="Filter by date">
              <option value="all">All Time</option>
              <option value="today">Today</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
            </select>

            <div class="search-box">
              <i class="fas fa-search muted"></i>
              <input id="ov-search" placeholder="Search order ID, customer, email">
            </div>
          </div>

          <button id="ov-refresh" class="btn-ghost" title="Refresh"><i class="fas fa-sync-alt"></i></button>
          <button id="ov-export" class="btn-primary" title="Export visible orders"><i class="fas fa-download" style="margin-right:8px"></i> Export</button>
        </div>
      </div>

      <div class="table-card">
        <div class="table-wrapper">
          <table class="orders-table" aria-label="Orders table">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Date</th>
                <th>Items</th>
                <th>Total</th>
                <th>Status</th>
                <th style="text-align:right">Actions</th>
              </tr>
            </thead>
            <tbody id="ov-tbody">
              <tr><td colspan="7" class="muted">Loading orders…</td></tr>
            </tbody>
          </table>
        </div>

        <div class="mobile-cards" id="ov-cards" aria-hidden="true"></div>
      </div>

      <div class="orders-modal-bg" id="ov-modal-bg" role="dialog" aria-hidden="true">
        <div class="orders-modal" role="document" aria-modal="true">
          <div class="modal-header">
            <div style="font-weight:700" id="ov-modal-title">Order Details</div>
            <button id="ov-modal-close" class="btn-ghost" aria-label="Close"><i class="fas fa-times"></i></button>
          </div>

          <div class="modal-body" id="ov-modal-body"></div>

          <div class="modal-footer">
            <button id="ov-modal-cancel" class="btn-ghost">Close</button>
            <button id="ov-modal-save" class="btn-primary"><i class="fas fa-save" style="margin-right:8px"></i> Save</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div id="oh-toast" class="oh-toast" role="status" aria-live="polite">
    <i class="fas fa-check-circle" style="color:var(--success)"></i>
    <div id="oh-toast-text">Saved</div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="activityLogger.js?v=1"></script>


 <script>
(function () {
  const config = {
    apiKey: "AIzaSyDuF6bdqprddsE871GuOablXPYqXI_HJxc",
    authDomain: "hexahoney-96aed.firebaseapp.com",
    projectId: "hexahoney-96aed",
    storageBucket: "hexahoney-96aed.firebasestorage.app",
    messagingSenderId: "700458850837",
    appId: "1:700458850837:web:0eb4fca98a5f4acc2d0c1c",
    measurementId: "G-MQGKK9709H",
  };

  if (window.firebase) {
    if (!firebase.apps.length) firebase.initializeApp(config);
  }

  const db = firebase.firestore();

  const t = document.getElementById("ov-tbody"),
    c = document.getElementById("ov-cards"),
    m = document.getElementById("ov-modal-bg"),
    mc = document.getElementById("ov-modal-close"),
    mca = document.getElementById("ov-modal-cancel"),
    ms = document.getElementById("ov-modal-save"),
    mb = document.getElementById("ov-modal-body"),
    fs = document.getElementById("ov-status"),
    fd = document.getElementById("ov-date"),
    si = document.getElementById("ov-search"),
    rb = document.getElementById("ov-refresh"),
    xb = document.getElementById("ov-export"),
    tw = document.getElementById("oh-toast"),
    tt = document.getElementById("oh-toast-text");

  let orders = [],
    filtered = [],
    editing = null;

  function toast(m, y = "success") {
    tt.textContent = m;
    tw.classList.add("show");
    setTimeout(() => tw.classList.remove("show"), 2600);
  }

  function esc(s) {
    return String(s || "").replace(/[&<>"']/g, (a) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;",
    }[a]));
  }

  function sid(x) {
    return x ? x.substring(0, 8) : "—";
  }

  function fdn(d) {
    if (!d) return "—";
    const x = d.toDate ? d.toDate() : new Date(d);
    return x.toLocaleDateString("en-IN");
  }

  function sc(s) {
    return "status-" + s;
  }

 function load() {
  t.innerHTML = `<tr><td colspan="7" class="muted">Loading orders…</td></tr>`;
  c.innerHTML = "";

  db.collection("orders")
    .orderBy("createdAt", "desc")
    .get()
    .then((q) => {
      orders = q.docs.map((d) => {
        const o = d.data();
        return {
          ...o,
          id: d.id,

          // Precomputed fields for FAST filtering
          _name:
            (o.shippingAddress?.firstName || "") +
            " " +
            (o.shippingAddress?.lastName || ""),

          _email: (o.email || "").toLowerCase(),

          _created: o.createdAt?.toDate
            ? o.createdAt.toDate().getTime()
            : 0,

          items: o.items || [],
        };
      });

      requestAnimationFrame(apply);
    })
    .catch(() => {
      empty();
      toast("Error loading orders", "error");
    });
}

  function empty() {
    t.innerHTML = `<tr><td colspan="7"><div class="empty-state">No Orders Found</div></td></tr>`;
    c.innerHTML = `<div class="order-card muted">No orders</div>`;
  }

  function list(x) {
    if (!x.length) {
      empty();
      return;
    }

    t.innerHTML = x
      .map((o) => {
        const it = (o.items || []).length,
          tot = o.total || 0;
        const cu = o.shippingAddress
          ? o.shippingAddress.firstName + " " + o.shippingAddress.lastName
          : o.email || "Customer";

        return `
          <tr data-id="${esc(o.id)}">
            <td>#${esc(sid(o.id))}</td>
            <td>
              <div style="display:flex;gap:10px;align-items:center">
                <div style="width:36px;height:36px;border-radius:8px;background:#000;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600">
                  ${esc(cu.slice(0, 2).toUpperCase())}
                </div>
                <div>
                  <div style="font-weight:600">${esc(cu)}</div>
                  <div class="muted">${esc(o.email || "—")}</div>
                </div>
              </div>
            </td>
            <td class="muted">${fdn(o.createdAt)}</td>
            <td class="muted">${it} item${it !== 1 ? "s" : ""}</td>
            <td>₹${Number(tot).toFixed(2)}</td>
            <td>
              <span class="status-pill ${sc(o.status)}">${esc(o.status || "pending")}</span>
            </td>
            <td style="text-align:right">
              <button class="action-btn view-btn" data-id="${o.id}">
                <i class="fas fa-eye"></i>
              </button>
              <button class="action-btn edit-btn" data-id="${o.id}">
                <i class="fas fa-edit"></i>
              </button>
            </td>
          </tr>
        `;
      })
      .join("");

    bind();
  }

  function bind() {
    document.querySelectorAll(".view-btn").forEach((b) => {
      b.onclick = (e) => open(e.currentTarget.dataset.id);
    });

    document.querySelectorAll(".edit-btn").forEach((b) => {
      b.onclick = (e) => open(e.currentTarget.dataset.id);
    });
  }

  function open(id) {
    const o = orders.find((x) => x.id === id);
    if (!o) return;

    editing = id;

    const ad = o.shippingAddress
      ? [
          o.shippingAddress.address,
          o.shippingAddress.city,
          o.shippingAddress.state,
          o.shippingAddress.zipCode,
          o.shippingAddress.country,
        ]
          .filter(Boolean)
          .join(", ")
      : "No address";

    const it =
      (o.items || [])
        .map(
          (i) => `
        <div style="display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid var(--border)">
          <div style="width:40px;height:40px;border-radius:8px;background:#f5f5f5;display:flex;align-items:center;justify-content:center">
            <i class="fas fa-jar"></i>
          </div>
          <div style="flex:1">
            <div style="font-weight:600">${esc(i.name)}</div>
            <div class="muted">${esc(i.weight || "")}</div>
          </div>
          <div style="font-weight:700">x${i.quantity}</div>
          <div style="font-weight:700">₹${(i.price * i.quantity).toFixed(2)}</div>
        </div>
      `
        )
        .join("") || "<div class='muted'>No items</div>";

    mb.innerHTML = `
      <div style="display:grid;gap:10px">
        <div>
          <div class="muted">Order ID</div>
          <div style="font-weight:700">#${esc(sid(id))}</div>
        </div>

        <div>
          <div class="muted">Customer</div>
          <div>${esc(
            o.shippingAddress
              ? o.shippingAddress.firstName + " " + o.shippingAddress.lastName
              : o.email
          )}</div>
        </div>

        <div style="display:flex;gap:12px">
          <div style="flex:1">
            <div class="muted">Email</div>
            <div>${esc(o.email || "—")}</div>
          </div>
          <div style="flex:1">
            <div class="muted">Phone</div>
            <div>${esc(o.shippingAddress?.phone || "—")}</div>
          </div>
        </div>

        <div style="display:flex;gap:12px">
          <div style="flex:1">
            <div class="muted">Date</div>
            <div>${fdn(o.createdAt)}</div>
          </div>
          <div style="flex:1">
            <div class="muted">Total</div>
            <div style="font-weight:700">₹${Number(o.total || 0).toFixed(
              2
            )}</div>
          </div>
        </div>

        <div>
          <div class="muted">Status</div>
          <select id="ov-modal-status" style="padding:8px;border:1px solid var(--border);border-radius:8px;width:100%">
            <option value="pending">Pending</option>
            <option value="confirmed">Confirmed</option>
            <option value="shipped">Shipped</option>
            <option value="delivered">Delivered</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>

        <div>
          <div class="muted">Shipping Address</div>
          <div>${esc(ad)}</div>
        </div>

        <div class="muted">Items</div>

        <div style="max-height:220px;overflow:auto;border:1px solid var(--border);border-radius:8px">
          ${it}
        </div>
      </div>
    `;

    document.getElementById("ov-modal-status").value =
      o.status || "pending";

    m.classList.add("show");
  }

  function close() {
    m.classList.remove("show");
    editing = null;
  }

  // --------------------------------------------------------
  //  ** FIXED SAVE FUNCTION — AUTO UPDATE ROOT + USER ORDER **
  // --------------------------------------------------------
  function save() {
  if (!editing) return;

  const st = document.getElementById("ov-modal-status").value;
  ms.disabled = true;

  const ot = ms.innerHTML;
  ms.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

  const rootRef = db.collection("orders").doc(editing);

  rootRef.get().then(doc => {
    if (doc.exists) {
      // Order exists in /orders → update here
      return rootRef.update({
        status: st,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    // Not in /orders → search inside all users
    return db.collection("users").get().then(users => {
      let found = false;
      const promises = [];

      users.forEach(u => {
        const subRef = db.collection("users").doc(u.id).collection("orders").doc(editing);
        promises.push(
          subRef.get().then(snap => {
            if (snap.exists) {
              found = true;
              return subRef.update({
                status: st,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
              });
            }
          })
        );
      });

      return Promise.all(promises).then(() => {
        if (!found) throw new Error("Order not found in any path");
      });
    });
  })
  .then(() => {
    ms.disabled = false;
    ms.innerHTML = ot;
    toast("Order updated");
    m.classList.remove("show");
  })
  .catch((err) => {
    ms.disabled = false;
    ms.innerHTML = ot;
    console.error(err);
    toast("Save failed", "error");
  });
}


function apply() {
  let x = [...orders];
  const st = fs.value;
  const d = fd.value;
  const q = si.value.toLowerCase();

  // STATUS filter
  if (st !== "all") {
    x = x.filter(o => (o.status || "").toLowerCase() === st);
  }

  // DATE filter
  if (d !== "all") {
    const now = Date.now();
    let start = null;

if (d === "today") {
  const today = new Date();
  today.setHours(0,0,0,0);
  start = today.getTime();
}

if (d === "week") start = now - 7 * 864e5;
if (d === "month") start = now - 30 * 864e5;

    if (start !== null) {
      x = x.filter(o => o._created >= start);
    }
  }

  // SEARCH filter → now uses FAST precomputed fields
  if (q) {
    x = x.filter(o => 
      o.id.toLowerCase().includes(q) ||
      o._name.toLowerCase().includes(q) ||
      o._email.includes(q)
    );
  }

  filtered = x;
  requestAnimationFrame(() => list(x)); 
}

  function csv(x) {
    if (!x.length) {
      toast("No orders to export", "info");
      return;
    }

    const rows = [["Order ID", "Customer", "Email", "Date", "Items", "Total", "Status"]];

    x.forEach((o) => {
      const cu =
        (o.shippingAddress?.firstName || "") +
        " " +
        (o.shippingAddress?.lastName || "");

      rows.push([
        `#${sid(o.id)}`,
        cu.trim(),
        o.email || "",
        fdn(o.createdAt),
        (o.items || []).length,
        o.total || 0,
        o.status || "",
      ]);
    });

    const out = rows
      .map((r) => r.map((c) => `"${String(c).replace(/"/g, '""')}"`).join(","))
      .join("\n");

    const B = new Blob([out], { type: "text/csv" }),
      u = URL.createObjectURL(B),
      a = document.createElement("a");

    a.href = u;
    a.download = "orders.csv";
    a.click();

    URL.revokeObjectURL(u);
    toast("Export started");
  }

  document.addEventListener("click", (e) => {
    if (e.target === m) close();
  });

  mc.onclick = close;
  mca.onclick = close;
  ms.onclick = save;
  fs.onchange = apply;
  fd.onchange = apply;
  si.oninput = () => setTimeout(apply, 100);
  rb.onclick = () => {
    load();
    toast("Refreshing...", "info");
  };
  xb.onclick = () => csv(filtered.length ? filtered : orders);

  load();
})();
</script>

