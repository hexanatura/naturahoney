<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* ------------------------------
   Orders Page – Dashboard Matched
   ------------------------------ */

:root {
    --primary: #0f172a;
    --secondary: #ffffff;
    --accent: #22c55e;
    --accent-soft: #bbf7d0;
    --dark: #020617;
    --light: #f8fafc;
    --gray: #64748b;
    --muted: #94a3b8;
    --success: #16a34a;
    --danger: #dc2626;
    --border: rgba(15, 23, 42, 0.12);

    --radius-lg: 22px;
    --radius-md: 16px;
    --radius-sm: 12px;

    --shadow-lg: 0 18px 45px rgba(15, 23, 42, 0.25);
    --shadow-md: 0 12px 30px rgba(15, 23, 42, 0.18);
    --shadow-sm: 0 8px 20px rgba(15, 23, 42, 0.15);
}

/* Global reset */
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Inter', sans-serif;
    background: transparent;
    color: var(--primary);
}

/* Page container flattened for dynamicPage */
.orders-view {
    width: 100%;
    padding: 20px;
}

/* Header block */
.orders-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 18px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.orders-title {
    font-family: 'Outfit', sans-serif;
    font-size: 1.45rem;
    font-weight: 700;
    color: var(--primary);
}

.orders-sub {
    font-size: 0.9rem;
    color: var(--muted);
}

/* Filters row */
.orders-controls {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.orders-card {
    display: flex;
    gap: 12px;
    align-items: center;
    padding: 14px;
    background: #ffffff;
    border-radius: var(--radius-md);
    border: 1px solid var(--border);
    box-shadow: var(--shadow-sm);
}

/* Inputs */
.filter-select,
.search-box input {
    font-size: 0.92rem;
}

.filter-select {
    padding: 10px 14px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: #ffffff;
    min-width: 150px;
}

.search-box {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    min-width: 260px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: #ffffff;
}

.search-box i { color: var(--gray); }

.search-box input {
    width: 100%;
    border: none;
    outline: none;
    background: transparent;
    font-size: 0.92rem;
}

/* Buttons */
.btn-ghost {
    padding: 8px 12px;
    border-radius: var(--radius-sm);
    background: #ffffff;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-sm);
    cursor: pointer;
}

.btn-ghost:hover {
    background: rgba(34, 197, 94, 0.08);
}

.btn-primary {
    padding: 10px 16px;
    border-radius: var(--radius-sm);
    background: var(--accent);
    border: 1px solid rgba(22,163,74,0.7);
    color: white;
    font-weight: 600;
    cursor: pointer;
    box-shadow: var(--shadow-sm);
}

.btn-primary:hover {
    box-shadow: var(--shadow-md);
}

/* Table container */
.table-card {
    background: #ffffff;
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 18px;
    box-shadow: var(--shadow-md);
}

.table-wrapper {
    overflow-x: auto;
}

/* Orders table */
.orders-table {
    width: 100%;
    border-collapse: collapse;
}

.orders-table th {
    padding: 12px 16px;
    text-align: left;
    font-size: 0.88rem;
    font-weight: 700;
    color: var(--primary);
    border-bottom: 1px solid var(--border);
}

.orders-table td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 0.88rem;
    color: var(--primary);
}

/* Status pills (matches dashboard colors) */
.status-pill {
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
    border: 1px solid transparent;
}

.status-pending    { background: #fff7d6; color: #854d0e; }
.status-confirmed  { background: #e0f2fe; color: #075985; }
.status-shipped    { background: #dbeafe; color: #1d4ed8; }
.status-delivered  { background: #dcfce7; color: #166534; }
.status-cancelled  { background: rgba(239,68,68,0.08); color: #b91c1c; }

/* Mobile cards */
@media(max-width:1023px) {
    .table-wrapper { display: none; }
    .mobile-cards { display: flex; flex-direction: column; gap: 12px; }
}

.mobile-cards { display: none; }

.order-card {
    background: #ffffff;
    border-radius: var(--radius-md);
    border: 1px solid var(--border);
    padding: 14px;
    box-shadow: var(--shadow-sm);
}

/* Modal */
.orders-modal-bg {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(2, 6, 23, 0.55);
    z-index: 1400;
}

.orders-modal-bg.show { display: flex; }

.orders-modal {
    background: #ffffff;
    border-radius: var(--radius-lg);
    width: 100%;
    max-width: 760px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-lg);
    overflow: hidden;
}

.orders-modal .modal-header,
.orders-modal .modal-body,
.orders-modal .modal-footer {
    padding: 18px 20px;
}

/* Toast */
.oh-toast {
    position: fixed;
    right: 22px;
    bottom: 22px;
    background: #ffffff;
    border-left: 4px solid var(--success);
    border: 1px solid var(--border);
    box-shadow: var(--shadow-md);
    padding: 12px 16px;
    display: flex;
    gap: 10px;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.2s ease;
    z-index: 2000;
}

.oh-toast.show {
    opacity: 1;
    transform: translateY(0);
}
</style>

<div class="orders-view fade-in">

    <div class="orders-top">
        <div>
            <div class="orders-title">Order Management</div>
            <div class="orders-sub">Manage and track customer orders</div>
        </div>

        <div class="orders-controls">
            <div class="orders-card">
                <select id="ov-status" class="filter-select">
                    <option value="all">All Orders</option>
                    <option value="pending">Pending</option>
                    <option value="confirmed">Confirmed</option>
                    <option value="shipped">Shipped</option>
                    <option value="delivered">Delivered</option>
                    <option value="cancelled">Cancelled</option>
                </select>

                <select id="ov-date" class="filter-select">
                    <option value="all">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                </select>

                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input id="ov-search" placeholder="Search order ID, customer, email">
                </div>
            </div>

            <button id="ov-refresh" class="btn-ghost"><i class="fas fa-sync"></i></button>
            <button id="ov-export" class="btn-primary"><i class="fas fa-download" style="margin-right:8px"></i> Export</button>
        </div>
    </div>

    <div class="table-card">
        <div class="table-wrapper">
            <table class="orders-table">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Date</th>
                        <th>Items</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th style="text-align:right;">Actions</th>
                    </tr>
                </thead>
                <tbody id="ov-tbody">
                    <tr><td colspan="7" class="muted">Loading orders…</td></tr>
                </tbody>
            </table>
        </div>

        <div class="mobile-cards" id="ov-cards"></div>
    </div>

    <div class="orders-modal-bg" id="ov-modal-bg">
        <div class="orders-modal">
            <div class="modal-header">
                <div style="font-weight:700" id="ov-modal-title">Order Details</div>
                <button id="ov-modal-close" class="btn-ghost"><i class="fas fa-times"></i></button>
            </div>

            <div class="modal-body" id="ov-modal-body"></div>

            <div class="modal-footer">
                <button id="ov-modal-cancel" class="btn-ghost">Close</button>
                <button id="ov-modal-save" class="btn-primary"><i class="fas fa-save" style="margin-right:8px"></i> Save</button>
            </div>
        </div>
    </div>
</div>

<div id="oh-toast" class="oh-toast">
    <i class="fas fa-check-circle" style="color:var(--success)"></i>
    <div id="oh-toast-text">Saved</div>
</div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="activityLogger.js?v=1"></script>


  <script>
   (function(){
const config={apiKey:"AIzaSyDuF6bdqprddsE871GuOablXPYqXI_HJxc",authDomain:"hexahoney-96aed.firebaseapp.com",projectId:"hexahoney-96aed",storageBucket:"hexahoney-96aed.firebasestorage.app",messagingSenderId:"700458850837",appId:"1:700458850837:web:0eb4fca98a5f4acc2d0c1c",measurementId:"G-MQGKK9709H"};
if(window.firebase){if(!firebase.apps.length)firebase.initializeApp(config);}
const t=document.getElementById("ov-tbody"),c=document.getElementById("ov-cards"),m=document.getElementById("ov-modal-bg"),mc=document.getElementById("ov-modal-close"),mca=document.getElementById("ov-modal-cancel"),ms=document.getElementById("ov-modal-save"),mb=document.getElementById("ov-modal-body"),fs=document.getElementById("ov-status"),fd=document.getElementById("ov-date"),si=document.getElementById("ov-search"),rb=document.getElementById("ov-refresh"),xb=document.getElementById("ov-export"),tw=document.getElementById("oh-toast"),tt=document.getElementById("oh-toast-text");
let orders=[],filtered=[],editing=null,db=window.db||firebase.firestore();
function toast(m,y="success"){tt.textContent=m;tw.classList.add("show");if(y==="error"){tw.style.borderLeftColor="#ef4444";tw.querySelector("i").className="fas fa-exclamation-circle";tw.querySelector("i").style.color="#ef4444"}else if(y==="info"){tw.style.borderLeftColor="#3b82f6";tw.querySelector("i").className="fas fa-info-circle";tw.querySelector("i").style.color="#3b82f6"}else{tw.style.borderLeftColor="#10b981";tw.querySelector("i").className="fas fa-check-circle";tw.querySelector("i").style.color="#10b981"}setTimeout(()=>tw.classList.remove("show"),2600)}
function esc(s){return String(s||"").replace(/[&<>"']/g,a=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[a]))}
function sid(x){return x?x.substring(0,8):"—"}
function fdn(d){if(!d)return"—";const x=d.toDate?d.toDate():new Date(d);return x.toLocaleDateString("en-IN")}
function sc(s){return"status-"+s}
function load(){t.innerHTML='<tr><td colspan="7" class="muted">Loading orders…</td></tr>';c.innerHTML="";db.collection("orders").orderBy("createdAt","desc").onSnapshot(q=>{orders=q.docs.map(d=>({id:d.id,...d.data()}));apply()},e=>{orders=[];empty();toast("Error loading orders","error")})}
function empty(){t.innerHTML='<tr><td colspan="7"><div class="empty-state">No Orders Found</div></td></tr>';c.innerHTML='<div class="order-card muted">No orders</div>'}
function list(x){if(!x.length){empty();return}t.innerHTML=x.map(o=>{const it=(o.items||[]).length,tot=o.total||0,cu=o.shippingAddress?(o.shippingAddress.firstName||"")+" "+(o.shippingAddress.lastName||""):o.email||"Customer";return`<tr data-id="${esc(o.id)}"><td>#${esc(sid(o.id))}</td><td><div style="display:flex;gap:10px;align-items:center"><div style="width:36px;height:36px;border-radius:8px;background:#000;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600">${esc(cu.slice(0,2).toUpperCase())}</div><div><div style="font-weight:600">${esc(cu)}</div><div class="muted">${esc(o.email||"—")}</div></div></div></td><td class="muted">${fdn(o.createdAt)}</td><td class="muted">${it} item${it!==1?"s":""}</td><td>₹${Number(tot).toFixed(2)}</td><td><span class="status-pill ${sc(o.status)}">${esc(o.status||"pending")}</span></td><td style="text-align:right"><button class="action-btn view-btn" data-id="${o.id}"><i class="fas fa-eye"></i></button><button class="action-btn edit-btn" data-id="${o.id}"><i class="fas fa-edit"></i></button></td></tr>`}).join("");
c.innerHTML=x.map(o=>{const it=(o.items||[]).length,tot=o.total||0,cu=o.shippingAddress?(o.shippingAddress.firstName||"")+" "+(o.shippingAddress.lastName||""):o.email||"Customer";return`<div class="order-card"><div class="card-header"><div><div class="customer-name">${esc(cu)}</div><div class="card-meta muted">${fdn(o.createdAt)} • ${it} item${it!==1?"s":""}</div></div><span class="status-pill ${sc(o.status)}">${esc(o.status||"pending")}</span></div><div style="margin:8px 0">${(o.items||[]).slice(0,2).map(i=>`<div style="display:flex;gap:8px;align-items:center;margin-bottom:6px"><div style="width:30px;height:30px;border-radius:6px;background:#f5f5f5;display:flex;align-items:center;justify-content:center"><i class="fas fa-jar"></i></div><div style="flex:1">${esc(i.name)}</div><div class="muted">x${i.quantity}</div></div>`).join("")}${it>2?`<div class="muted">+${it-2} more</div>`:""}</div><div style="display:flex;justify-content:space-between"><div style="font-weight:700">₹${Number(tot).toFixed(2)}</div><div><button class="action-btn view-btn" data-id="${o.id}"><i class="fas fa-eye"></i></button><button class="action-btn edit-btn" data-id="${o.id}"><i class="fas fa-edit"></i></button></div></div></div>`}).join("");
bind()}
function bind(){document.querySelectorAll(".view-btn").forEach(b=>b.onclick=e=>open(e.currentTarget.dataset.id));document.querySelectorAll(".edit-btn").forEach(b=>b.onclick=e=>open(e.currentTarget.dataset.id))}
function open(id){const o=orders.find(x=>x.id===id);if(!o)return;editing=id;const ad=o.shippingAddress?[o.shippingAddress.address,o.shippingAddress.city,o.shippingAddress.state,o.shippingAddress.zipCode,o.shippingAddress.country].filter(Boolean).join(", "):"No address";const it=(o.items||[]).map(i=>`<div style="display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid var(--border)"><div style="width:40px;height:40px;border-radius:8px;background:#f5f5f5;display:flex;align-items:center;justify-content:center"><i class="fas fa-jar"></i></div><div style="flex:1"><div style="font-weight:600">${esc(i.name)}</div><div class="muted">${esc(i.weight||"")}</div></div><div style="font-weight:700">x${i.quantity}</div><div style="font-weight:700">₹${(i.price*i.quantity).toFixed(2)}</div></div>`).join("")||"<div class='muted'>No items</div>";mb.innerHTML=`<div style="display:grid;gap:10px"><div><div class="muted">Order ID</div><div style="font-weight:700">#${esc(sid(id))}</div></div><div><div class="muted">Customer</div><div>${esc(o.shippingAddress?(o.shippingAddress.firstName+" "+o.shippingAddress.lastName):o.email)}</div></div><div style="display:flex;gap:12px"><div style="flex:1"><div class="muted">Email</div><div>${esc(o.email||"—")}</div></div><div style="flex:1"><div class="muted">Phone</div><div>${esc(o.shippingAddress?.phone||"—")}</div></div></div><div style="display:flex;gap:12px"><div style="flex:1"><div class="muted">Date</div><div>${fdn(o.createdAt)}</div></div><div style="flex:1"><div class="muted">Total</div><div style="font-weight:700">₹${Number(o.total||0).toFixed(2)}</div></div></div><div><div class="muted">Status</div><select id="ov-modal-status" style="padding:8px;border:1px solid var(--border);border-radius:8px;width:100%"> <option value="pending">Pending</option><option value="confirmed">Confirmed</option><option value="shipped">Shipped</option><option value="delivered">Delivered</option><option value="cancelled">Cancelled</option></select></div><div><div class="muted">Shipping Address</div><div>${esc(ad)}</div></div><div class="muted">Items</div><div style="max-height:220px;overflow:auto;border:1px solid var(--border);border-radius:8px">${it}</div></div>`;
document.getElementById("ov-modal-status").value=o.status||"pending";
m.classList.add("show")}
function close(){m.classList.remove("show");editing=null}
function save(){if(!editing)return;const st=document.getElementById("ov-modal-status").value;ms.disabled=true;const ot=ms.innerHTML;ms.innerHTML='<i class="fas fa-spinner fa-spin"></i> Saving...';db.collection("orders").doc(editing).update({status:st,updatedAt:firebase.firestore.FieldValue.serverTimestamp()}).then(()=>{activityLogger.logActivity("ORDER_STATUS",`Order #${sid(editing)} updated to ${st}`,{refId:editing});if(st==="cancelled")activityLogger.logActivity("ORDER_CANCELLED",`Order #${sid(editing)} was cancelled`,{refId:editing});if(st==="delivered")activityLogger.logActivity("ORDER_DELIVERED",`Order #${sid(editing)} delivered successfully`,{refId:editing});ms.disabled=false;ms.innerHTML=ot;toast("Order updated");close()}).catch(()=>{ms.disabled=false;ms.innerHTML=ot;toast("Save failed","error")})}
function apply(){let x=[...orders];const st=fs.value,d=fd.value,q=si.value.toLowerCase();if(st!=="all")x=x.filter(o=>(o.status||"").toLowerCase()===st);if(d!=="all"){const n=new Date();let S=null;if(d==="today")S=new Date(n.getFullYear(),n.getMonth(),n.getDate());if(d==="week")S=new Date(n.getTime()-7*864e5);if(d==="month")S=new Date(n.getFullYear(),n.getMonth()-1,n.getDate());if(S)x=x.filter(o=>{if(!o.createdAt)return false;const D=o.createdAt.toDate?o.createdAt.toDate():new Date(o.createdAt);return D>=S})}if(q)x=x.filter(o=>{const id=o.id.toLowerCase(),nm=((o.shippingAddress?.firstName||"")+" "+(o.shippingAddress?.lastName||"")).toLowerCase(),em=(o.email||"").toLowerCase();return id.includes(q)||nm.includes(q)||em.includes(q)});filtered=x;list(x)}
function csv(x){if(!x.length){toast("No orders to export","info");return}const rows=[["Order ID","Customer","Email","Date","Items","Total","Status"]];x.forEach(o=>{const cu=(o.shippingAddress?.firstName||"")+" "+(o.shippingAddress?.lastName||"");rows.push([`#${sid(o.id)}`,cu.trim(),o.email||"",fdn(o.createdAt),(o.items||[]).length,o.total||0,o.status||""])});
const out=rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n");
const B=new Blob([out],{type:"text/csv"}),u=URL.createObjectURL(B),a=document.createElement("a");a.href=u;a.download="orders.csv";a.click();URL.revokeObjectURL(u);toast("Export started")}
document.addEventListener("click",e=>{if(e.target===m)close()});
mc.onclick=close;mca.onclick=close;ms.onclick=save;fs.onchange=apply;fd.onchange=apply;si.oninput=()=>setTimeout(apply,100);rb.onclick=()=>{load();toast("Refreshing...","info")};xb.onclick=()=>csv(filtered.length?filtered:orders);
load();
})();

  </script> 
