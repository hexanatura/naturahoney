

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>

  <style>
    :root{
      --primary:#000;
      --secondary:#fff;
      --dark:#000;
      --light:#f7f7f7;
      --muted:#7b8794;
      --border:#e6e6e6;
      --card-bg:rgba(255,255,255,0.96);
      --shadow:0 6px 18px rgba(10,10,10,0.06);
      --radius:12px;
      --success:#10b981;
      --danger:#ef4444;
    }

    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{background:linear-gradient(135deg,#f0f0f0 0%,#e9e9e9 100%);color:var(--dark);padding:18px;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}

    .page-container{max-width:1400px;margin:0 auto;padding:18px 20px;width:100%}
    .orders-view{padding:12px;background:transparent;min-height:60vh}

    .orders-top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px;flex-wrap:wrap}
    .orders-title{font-family:'Outfit',sans-serif;font-size:1.25rem;font-weight:700;color:var(--dark)}
    .orders-sub{font-size:0.95rem;color:var(--muted);margin-top:4px}

    .orders-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .orders-card{background:var(--card-bg);border-radius:var(--radius);box-shadow:var(--shadow);padding:10px;border:1px solid var(--border);display:flex;gap:12px;align-items:center}
    .filters-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}

    .filter-select,.search-box{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;min-width:160px;font-size:0.95rem}
    .search-box{display:flex;gap:8px;align-items:center;min-width:220px;max-width:420px;padding:6px 10px}
    .search-box input{border:0;outline:none;background:transparent;width:100%;font-size:0.95rem;color:var(--dark)}

    .btn-primary{background:var(--dark);color:var(--secondary);border-radius:10px;padding:8px 12px;border:none;cursor:pointer;font-weight:700}
    .btn-ghost{background:transparent;border:1px solid var(--border);padding:7px 10px;border-radius:8px;cursor:pointer}

    .table-card{margin-top:14px;background:var(--card-bg);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px;border:1px solid var(--border)}
    .table-wrapper{overflow:auto}
    .orders-table{width:100%;border-collapse:collapse;min-width:900px;font-size:0.95rem}
    .orders-table thead th{text-align:left;padding:12px 16px;font-weight:700;color:var(--dark);border-bottom:1px solid var(--border);background:transparent;white-space:nowrap}
    .orders-table td{padding:12px 16px;border-bottom:1px solid var(--border);vertical-align:middle;color:var(--dark)}
    .muted{color:var(--muted);font-size:0.9rem}

    .status-pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;font-size:0.75rem}
    .status-pending{background:rgba(245,158,11,0.08);color:#f59e0b;border:1px solid rgba(245,158,11,0.12)}
    .status-confirmed{background:rgba(59,130,246,0.08);color:#3b82f6;border:1px solid rgba(59,130,246,0.12)}
    .status-shipped{background:rgba(16,185,129,0.08);color:#10b981;border:1px solid rgba(16,185,129,0.12)}
    .status-delivered{background:rgba(101,163,13,0.08);color:#65a30d;border:1px solid rgba(101,163,13,0.12)}
    .status-cancelled{background:rgba(239,68,68,0.08);color:#ef4444;border:1px solid rgba(239,68,68,0.12)}

    .action-btn{border-radius:8px;border:0;padding:8px;background:transparent;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;font-size:0.95rem}
    .action-btn .fa-eye{color:var(--dark)}
    .action-btn .fa-edit{color:var(--success)}

    .mobile-cards{display:none;gap:12px;margin-top:12px}
    .order-card{background:var(--card-bg);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px;border:1px solid var(--border)}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .customer-name{font-weight:600;color:var(--dark)}
    .card-meta{color:var(--muted);font-size:0.85rem}

    @media (max-width:1023px){.table-wrapper{display:none}.mobile-cards{display:flex;flex-direction:column}}
    @media (min-width:1024px){.table-wrapper{display:block}}

    .orders-modal-bg{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(6,8,15,0.6);z-index:1200;padding:20px}
    .orders-modal-bg.show{display:flex}
    .orders-modal{width:100%;max-width:760px;border-radius:12px;overflow:hidden;background:var(--card-bg);box-shadow:var(--shadow);border:1px solid var(--border)}
    .orders-modal .modal-header{padding:14px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)}
    .orders-modal .modal-body{padding:16px;max-height:60vh;overflow:auto}
    .orders-modal .modal-footer{padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px}

    .empty-state{text-align:center;padding:36px 12px;color:var(--muted)}
    .empty-state i{font-size:3rem;color:#cbd5e1;margin-bottom:8px}

    .oh-toast{position:fixed;right:22px;bottom:22px;padding:12px 16px;background:var(--card-bg);border:1px solid var(--border);box-shadow:var(--shadow);border-left:4px solid var(--success);z-index:1400;display:flex;gap:10px;align-items:center;transform:translateY(10px);opacity:0;transition:all .2s ease}
    .oh-toast.show{opacity:1;transform:translateY(0)}
    .oh-toast i{font-size:1.05rem}
  </style>
</head>
<body>
  <div class="page-container">
    <div class="orders-view fade-in">

      <div class="orders-top">
        <div>
          <div class="orders-title">Order Management</div>
          <div class="orders-sub muted">Manage and track customer orders</div>
        </div>

        <div class="orders-controls">
          <div class="orders-card filters-row">
            <select id="ov-status" class="filter-select" title="Filter by status">
              <option value="all">All Orders</option>
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="shipped">Shipped</option>
              <option value="delivered">Delivered</option>
              <option value="cancelled">Cancelled</option>
            </select>

            <select id="ov-date" class="filter-select" title="Filter by date">
              <option value="all">All Time</option>
              <option value="today">Today</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
            </select>

            <div class="search-box">
              <i class="fas fa-search muted"></i>
              <input id="ov-search" placeholder="Search order ID, customer, email">
            </div>
          </div>

          <button id="ov-refresh" class="btn-ghost" title="Refresh"><i class="fas fa-sync-alt"></i></button>
          <button id="ov-export" class="btn-primary" title="Export visible orders"><i class="fas fa-download" style="margin-right:8px"></i> Export</button>
        </div>
      </div>

      <div class="table-card">
        <div class="table-wrapper">
          <table class="orders-table" aria-label="Orders table">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Date</th>
                <th>Items</th>
                <th>Total</th>
                <th>Status</th>
                <th style="text-align:right">Actions</th>
              </tr>
            </thead>
            <tbody id="ov-tbody">
              <tr><td colspan="7" class="muted">Loading orders…</td></tr>
            </tbody>
          </table>
        </div>

        <div class="mobile-cards" id="ov-cards" aria-hidden="true"></div>
      </div>

      <div class="orders-modal-bg" id="ov-modal-bg" role="dialog" aria-hidden="true">
        <div class="orders-modal" role="document" aria-modal="true">
          <div class="modal-header">
            <div style="font-weight:700" id="ov-modal-title">Order Details</div>
            <button id="ov-modal-close" class="btn-ghost" aria-label="Close"><i class="fas fa-times"></i></button>
          </div>

          <div class="modal-body" id="ov-modal-body"></div>

          <div class="modal-footer">
            <button id="ov-modal-cancel" class="btn-ghost">Close</button>
            <button id="ov-modal-save" class="btn-primary"><i class="fas fa-save" style="margin-right:8px"></i> Save</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div id="oh-toast" class="oh-toast" role="status" aria-live="polite">
    <i class="fas fa-check-circle" style="color:var(--success)"></i>
    <div id="oh-toast-text">Saved</div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <script>
    (function(){
      const SAFE_FIREBASE_CONFIG = {
        apiKey: "AIzaSyDuF6bdqprddsE871GuOablXPYqXI_HJxc",
        authDomain: "hexahoney-96aed.firebaseapp.com",
        projectId: "hexahoney-96aed",
        storageBucket: "hexahoney-96aed.firebasestorage.app",
        messagingSenderId: "700458850837",
        appId: "1:700458850837:web:0eb4fca98a5f4acc2d0c1c",
        measurementId: "G-MQGKK9709H"
      };

      try {
        if (window.firebase) {
          if (!firebase.apps || !firebase.apps.length) firebase.initializeApp(SAFE_FIREBASE_CONFIG);
        }
      } catch (e) {}

      const tbody = document.getElementById('ov-tbody');
      const cards = document.getElementById('ov-cards');
      const modalBg = document.getElementById('ov-modal-bg');
      const modalClose = document.getElementById('ov-modal-close');
      const modalCancel = document.getElementById('ov-modal-cancel');
      const modalSave = document.getElementById('ov-modal-save');
      const modalBody = document.getElementById('ov-modal-body');

      const statusFilter = document.getElementById('ov-status');
      const dateFilter = document.getElementById('ov-date');
      const searchInput = document.getElementById('ov-search');
      const refreshBtn = document.getElementById('ov-refresh');
      const exportBtn = document.getElementById('ov-export');

      const toastWrap = document.getElementById('oh-toast');
      const toastText = document.getElementById('oh-toast-text');

      let orders = [];
      let filtered = [];
      let editingOrderId = null;
      let db = window.db || (window.firebase && firebase.firestore ? firebase.firestore() : null);

      function showToast(msg, type='success'){
        toastText.textContent = msg;
        toastWrap.classList.add('show');
        if (type === 'error'){ toastWrap.style.borderLeftColor = 'var(--danger)'; toastWrap.querySelector('i').className = 'fas fa-exclamation-circle'; toastWrap.querySelector('i').style.color = 'var(--danger)'; }
        else if (type === 'info'){ toastWrap.style.borderLeftColor = '#3b82f6'; toastWrap.querySelector('i').className = 'fas fa-info-circle'; toastWrap.querySelector('i').style.color = '#3b82f6'; }
        else { toastWrap.style.borderLeftColor = 'var(--success)'; toastWrap.querySelector('i').className = 'fas fa-check-circle'; toastWrap.querySelector('i').style.color = 'var(--success)'; }
        setTimeout(()=> toastWrap.classList.remove('show'), 2800);
      }

      function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
      function shortId(id){ return id ? id.toString().substring(0,8) : '—'; }
      function fmtDate(d){ if(!d) return 'N/A'; const dt = new Date(typeof d === 'object' && d.toDate ? d.toDate() : d); return dt.toLocaleDateString(); }
      function getStatusClass(s){ if(!s) return 'status-pending'; return 'status-' + s; }

      function loadOrders(){
        tbody.innerHTML = '<tr><td colspan="7" class="muted">Loading orders…</td></tr>';
        cards.innerHTML = '';

        if (db && db.collection){
          try {
            db.collection('orders').orderBy('createdAt','desc').onSnapshot(qs => {
              orders = [];
              qs.forEach(doc => orders.push({ id: doc.id, ...doc.data() }));
              applyFilters();
            }, err => {
              console.error('orders snapshot error', err);
              orders = [];
              renderEmpty();
              showToast('Error loading orders','error');
            });
            return;
          } catch (e) {
            console.warn('Firestore onSnapshot fallback', e);
          }
        }

        orders = [];
        renderEmpty();
      }

      function renderEmpty(){
        tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><i class="fas fa-shopping-bag"></i><h3>No Orders Found</h3><p class="muted">Customer orders will appear here.</p></div></td></tr>';
        cards.innerHTML = '<div class="order-card"><div class="muted">No orders for mobile view</div></div>';
      }

      function renderList(list){
        if (!list || !list.length){ renderEmpty(); return; }

        tbody.innerHTML = list.map(o => {
          const itemsCount = (o.items||[]).length;
          const total = o.total ?? 0;
          const customer = (o.shippingAddress && (o.shippingAddress.firstName || o.shippingAddress.lastName)) ? `${escapeHtml(o.shippingAddress.firstName||'')} ${escapeHtml(o.shippingAddress.lastName||'')}`.trim() : escapeHtml(o.email||'Customer');

          return `
            <tr data-id="${escapeHtml(o.id)}">
              <td class="order-id">#${escapeHtml(shortId(o.id))}</td>
              <td>
                <div style="display:flex;gap:10px;align-items:center">
                  <div style="width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,#8b5cf6,#a855f7);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600">${escapeHtml((customer||'C').slice(0,2).toUpperCase())}</div>
                  <div style="min-width:0">
                    <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${customer}</div>
                    <div class="muted" style="font-size:0.85rem">${escapeHtml(o.email||'No email')}</div>
                  </div>
                </div>
              </td>
              <td class="muted">${fmtDate(o.createdAt)}</td>
              <td class="muted">${itemsCount} item${itemsCount !== 1 ? 's' : ''}</td>
              <td>₹${Number(total).toFixed(2)}</td>
              <td><span class="status-pill ${getStatusClass(o.status)}">${escapeHtml((o.status||'pending').charAt(0).toUpperCase() + (o.status||'pending').slice(1))}</span></td>
              <td style="text-align:right">
                <button class="action-btn view-btn" data-id="${escapeHtml(o.id)}" title="View"><i class="fas fa-eye"></i></button>
                <button class="action-btn edit-btn" data-id="${escapeHtml(o.id)}" title="Edit"><i class="fas fa-edit"></i></button>
              </td>
            </tr>
          `;
        }).join('');

        cards.innerHTML = list.map(o => {
          const itemsCount = (o.items||[]).length;
          const total = o.total ?? 0;
          const customer = (o.shippingAddress && (o.shippingAddress.firstName || o.shippingAddress.lastName)) ? `${escapeHtml(o.shippingAddress.firstName||'')} ${escapeHtml(o.shippingAddress.lastName||'')}`.trim() : escapeHtml(o.email||'Customer');
          let itemsHTML = '';
          if (o.items && o.items.length){
            o.items.slice(0,2).forEach(it => {
              itemsHTML += `<div style="display:flex;gap:8px;align-items:center;margin-bottom:6px"><div style="width:30px;height:30px;border-radius:6px;background:var(--light);display:flex;align-items:center;justify-content:center"><i class="fas fa-jar"></i></div><div style="font-size:0.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(it.name)}</div><div style="margin-left:auto" class="muted">x${it.quantity}</div></div>`;
            });
            if (o.items.length > 2) itemsHTML += `<div class="muted">+${o.items.length - 2} more</div>`;
          } else itemsHTML = '<div class="muted">No items</div>';

          return `
            <div class="order-card">
              <div class="card-header">
                <div>
                  <div class="customer-name">${customer}</div>
                  <div class="card-meta muted">${fmtDate(o.createdAt)} • ${itemsCount} item${itemsCount!==1?'s':''}</div>
                </div>
                <div><span class="status-pill ${getStatusClass(o.status)}" style="font-size:0.75rem;padding:6px 10px">${escapeHtml((o.status||'pending').charAt(0).toUpperCase() + (o.status||'pending').slice(1))}</span></div>
              </div>
              <div style="margin:8px 0">${itemsHTML}</div>
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div style="font-weight:700">₹${Number(total).toFixed(2)}</div>
                <div style="display:flex;gap:8px">
                  <button class="action-btn view-btn" data-id="${escapeHtml(o.id)}"><i class="fas fa-eye"></i></button>
                  <button class="action-btn edit-btn" data-id="${escapeHtml(o.id)}"><i class="fas fa-edit"></i></button>
                </div>
              </div>
            </div>
          `;
        }).join('');

        attachRowListeners();
      }

      function attachRowListeners(){
        tbody.querySelectorAll('.view-btn').forEach(b => b.onclick = e => openModalById(e.currentTarget.getAttribute('data-id')));
        tbody.querySelectorAll('.edit-btn').forEach(b => b.onclick = e => openModalById(e.currentTarget.getAttribute('data-id')));
        cards.querySelectorAll('.view-btn').forEach(b => b.onclick = e => openModalById(e.currentTarget.getAttribute('data-id')));
        cards.querySelectorAll('.edit-btn').forEach(b => b.onclick = e => openModalById(e.currentTarget.getAttribute('data-id')));
      }

      function openModalById(id){
        const order = orders.find(x => x.id === id) || { id };
        openModal(order);
      }

      function openModal(order){
        if (!order) return;
        editingOrderId = order.id || null;
        const addressText = formatAddress(order.shippingAddress);
        const itemsHtml = (order.items && order.items.length) ? order.items.map(it => `<div style="display:flex;align-items:center;gap:8px;padding:8px;border-bottom:1px solid var(--border)"><div style="width:40px;height:40px;border-radius:8px;background:var(--light);display:flex;align-items:center;justify-content:center"><i class="fas fa-jar"></i></div><div style="flex:1;min-width:0"><div style="font-weight:600">${escapeHtml(it.name)}</div><div class="muted">${escapeHtml(it.weight||'')}</div></div><div style="font-weight:700">x${it.quantity}</div><div style="color:var(--primary);font-weight:700">₹${Number((it.price||0)*it.quantity).toFixed(2)}</div></div>`).join('') : '<div class="muted">No items</div>';

        modalBody.innerHTML = `
          <div style="display:grid;grid-template-columns:1fr;gap:10px">
            <div><div class="muted">Order ID</div><div style="font-weight:700">${escapeHtml('#' + shortId(order.id))}</div></div>
            <div><div class="muted">Customer</div><div>${escapeHtml((order.shippingAddress?.firstName||order.email||'Customer') + ' ' + (order.shippingAddress?.lastName||''))}</div></div>
            <div style="display:flex;gap:12px">
              <div style="flex:1"><div class="muted">Email</div><div>${escapeHtml(order.email || 'No email')}</div></div>
              <div style="flex:1"><div class="muted">Phone</div><div>${escapeHtml(order.shippingAddress?.phone || 'No phone')}</div></div>
            </div>
            <div style="display:flex;gap:12px">
              <div style="flex:1"><div class="muted">Date</div><div>${fmtDate(order.createdAt)}</div></div>
              <div style="flex:1"><div class="muted">Total</div><div style="font-weight:700">₹${Number(order.total||0).toFixed(2)}</div></div>
            </div>

            <div><div class="muted">Status</div>
              <select id="ov-modal-status" style="padding:8px 10px;border-radius:8px;border:1px solid var(--border);width:100%">
                <option value="pending">Pending</option>
                <option value="confirmed">Confirmed</option>
                <option value="shipped">Shipped</option>
                <option value="delivered">Delivered</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>

            <div><div class="muted">Shipping Address</div><div>${escapeHtml(addressText)}</div></div>
            <div class="muted">Items</div>
            <div style="max-height:220px;overflow:auto;border:1px solid var(--border);border-radius:8px;padding:8px" id="ov-modal-items">${itemsHtml}</div>
          </div>
        `;
        const sel = document.getElementById('ov-modal-status'); if (sel) sel.value = order.status || 'pending';
        modalBg.classList.add('show'); modalBg.setAttribute('aria-hidden','false');
      }

      function formatAddress(a){
        if(!a) return 'No address provided';
        const parts = [a.address, a.city, a.state, a.zipCode, a.country].filter(Boolean);
        return parts.join(', ');
      }

      function closeModal(){ modalBg.classList.remove('show'); modalBg.setAttribute('aria-hidden','true'); editingOrderId = null; }

      function saveModal(){
        if (!editingOrderId) return;
        const newStatus = document.getElementById('ov-modal-status')?.value || 'pending';
        if (db && db.collection){
          modalSave.disabled = true;
          const oldText = modalSave.innerHTML;
          modalSave.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
          db.collection('orders').doc(editingOrderId).update({ status: newStatus, updatedAt: firebase.firestore.FieldValue.serverTimestamp() })
            .then(()=>{ modalSave.disabled = false; modalSave.innerHTML = oldText; showToast('Order updated'); closeModal(); })
            .catch(err=>{ modalSave.disabled = false; modalSave.innerHTML = oldText; showToast('Save failed','error'); });
          return;
        }
        const idx = orders.findIndex(o=>o.id===editingOrderId);
        if (idx !== -1){ orders[idx].status = newStatus; applyFilters(); showToast('Order updated (local)'); }
        closeModal();
      }

      function applyFilters(){
        const st = statusFilter.value;
        const dv = dateFilter.value;
        const q = (searchInput.value||'').trim().toLowerCase();
        let list = orders.slice();

        if (st !== 'all') list = list.filter(o => (o.status||'').toLowerCase() === st);

        if (dv !== 'all'){
          const now = new Date(); let start = null;
          if (dv === 'today') start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          if (dv === 'week') start = new Date(now.getTime() - 7*86400000);
          if (dv === 'month') start = new Date(now.getFullYear(), now.getMonth()-1, now.getDate());
          if (start) list = list.filter(o => { if(!o.createdAt) return false; const od = new Date(typeof o.createdAt === 'object' && o.createdAt.toDate ? o.createdAt.toDate() : o.createdAt); return od >= start; });
        }

        if (q) list = list.filter(o => {
          const id = (o.id||'').toLowerCase();
          const name = ((o.shippingAddress?.firstName||'') + ' ' + (o.shippingAddress?.lastName||'')).toLowerCase();
          const email = (o.email||'').toLowerCase();
          return id.includes(q) || name.includes(q) || email.includes(q);
        });

        filtered = list;
        renderList(filtered);
      }

      function exportCSV(list){
        if (!list || !list.length){ showToast('No orders to export','info'); return; }
        const rows = [['Order ID','Customer','Email','Date','Items','Total','Status']];
        list.forEach(o => {
          const customer = (o.shippingAddress?.firstName || '') + ' ' + (o.shippingAddress?.lastName || '');
          rows.push([`#${shortId(o.id)}`, customer.trim(), o.email||'', fmtDate(o.createdAt), (o.items||[]).length, (o.total||0), o.status||'']);
        });
        const csv = rows.map(r => r.map(c => `"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'orders.csv'; a.click(); URL.revokeObjectURL(url);
        showToast('Export started');
      }

      document.addEventListener('click', function(e){ if (e.target === modalBg) closeModal(); });
      modalClose.addEventListener('click', closeModal);
      modalCancel.addEventListener('click', closeModal);
      modalSave.addEventListener('click', saveModal);

      statusFilter.addEventListener('change', applyFilters);
      dateFilter.addEventListener('change', applyFilters);
      searchInput.addEventListener('input', function(){ setTimeout(applyFilters, 120); });

      refreshBtn.addEventListener('click', function(){ loadOrders(); showToast('Refreshing orders...','info'); });
      exportBtn.addEventListener('click', function(){ exportCSV(filtered.length ? filtered : orders); });

      loadOrders();

      window.__orders_debug = { loadOrders, applyFilters, exportCSV };
    })();
  </script>
