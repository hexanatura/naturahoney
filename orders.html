<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  --primary: #2563eb;
  --primary-light: #3b82f6;
  --dark: #1f2937;
  --dark-light: #374151;
  --muted: #6b7280;
  --border: #e5e7eb;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --radius: 12px;
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
}

body {
  font-family: 'Inter', sans-serif;
  background: #f9fafb;
  color: #374151;
  line-height: 1.5;
}

.orders-view {
  padding: 20px;
  background: #f9fafb;
  min-height: 100vh;
}

.orders-top {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 20px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.orders-title-section {
  flex: 1;
  min-width: 250px;
}

.orders-title {
  font-family: 'Outfit', sans-serif;
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--dark);
  margin-bottom: 4px;
}

.orders-sub {
  font-size: 0.9rem;
  color: var(--muted);
  font-weight: 400;
}

.orders-controls {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.orders-card {
  background: #fff;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 16px;
  border: 1px solid var(--border);
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.filter-select,
.search-box {
  padding: 10px 14px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: #fff;
  font-size: 0.95rem;
  min-width: 160px;
  font-family: 'Inter', sans-serif;
  color: var(--dark);
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.filter-select:hover,
.search-box:hover {
  border-color: #9ca3af;
}

.filter-select:focus,
.search-box:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.search-box {
  display: flex;
  gap: 10px;
  align-items: center;
  min-width: 280px;
  flex: 1;
}

.search-box input {
  border: 0;
  outline: none;
  background: transparent;
  width: 100%;
  font-size: 0.95rem;
  color: var(--dark);
}

.search-box input::placeholder {
  color: #9ca3af;
}

.btn-primary {
  background: var(--primary);
  color: white;
  border-radius: 8px;
  padding: 10px 16px;
  border: none;
  cursor: pointer;
  font-weight: 500;
  font-family: 'Inter', sans-serif;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: background-color 0.2s ease, transform 0.1s ease;
}

.btn-primary:hover {
  background: var(--primary-light);
  transform: translateY(-1px);
}

.btn-ghost {
  background: transparent;
  border: 1px solid var(--border);
  padding: 9px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 500;
  color: var(--dark);
  display: flex;
  align-items: center;
  gap: 6px;
  transition: background-color 0.2s ease, border-color 0.2s ease;
}

.btn-ghost:hover {
  background: #f3f4f6;
  border-color: #d1d5db;
}

.table-card {
  margin-top: 16px;
  background: #fff;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 20px;
  border: 1px solid var(--border);
}

.table-wrapper {
  overflow: auto;
  background: #fff;
  border-radius: 8px;
}

.orders-table {
  width: 100%;
  border-collapse: collapse;
  min-width: 1000px;
  font-size: 0.95rem;
  background: #fff;
}

.orders-table thead th {
  text-align: left;
  padding: 16px;
  font-weight: 600;
  color: var(--dark-light);
  border-bottom: 2px solid var(--border);
  background: #f9fafb;
  font-size: 0.9rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.orders-table tbody tr {
  transition: background-color 0.2s ease;
}

.orders-table tbody tr:hover {
  background: #f9fafb;
}

.orders-table td {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  vertical-align: middle;
  color: var(--dark);
}

.status-pill {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 999px;
  font-weight: 500;
  font-size: 0.8rem;
  letter-spacing: 0.02em;
}

.status-pending { background: #fef3c7; color: #92400e; }
.status-confirmed { background: #dbeafe; color: #1e40af; }
.status-shipped { background: #d1fae5; color: #065f46; }
.status-out-for-delivery { background: #ede9fe; color: #5b21b6; }
.status-delivered { background: #dcfce7; color: #166534; }
.status-cancelled { background: #fee2e2; color: #991b1b; }

.action-btn {
  border-radius: 6px;
  border: 1px solid var(--border);
  padding: 8px;
  background: white;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 0.9rem;
  color: var(--dark);
  transition: all 0.2s ease;
}

.action-btn:hover {
  background: #f3f4f6;
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.actions-container {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  align-items: center;
}

.mobile-cards {
  display: none;
  gap: 16px;
  margin-top: 16px;
}

.order-card {
  background: #fff;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 16px;
  border: 1px solid var(--border);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.order-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border);
}

.order-id {
  font-weight: 600;
  color: var(--primary);
  font-family: 'Outfit', sans-serif;
}

.customer-info {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.customer-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--primary);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  flex-shrink: 0;
}

.customer-details {
  flex: 1;
}

.customer-name {
  font-weight: 500;
  color: var(--dark);
  margin-bottom: 2px;
}

.customer-email {
  font-size: 0.85rem;
  color: var(--muted);
}

.card-details {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-bottom: 16px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border);
}

.detail-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.detail-label {
  font-size: 0.8rem;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.detail-value {
  font-weight: 500;
  color: var(--dark);
}

.mobile-actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  padding-top: 12px;
  border-top: 1px solid var(--border);
}

/* Image Zoom Modal */
.image-zoom-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.95);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  padding: 20px;
  animation: fadeIn 0.3s ease;
}

.image-zoom-modal.show {
  display: flex;
}

.image-zoom-content {
  position: relative;
  max-width: 90%;
  max-height: 90%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.image-zoom-close {
  position: absolute;
  top: -50px;
  right: 0;
  background: rgba(255,255,255,0.1);
  border: none;
  color: white;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 1.2rem;
  transition: background 0.2s ease;
  z-index: 2001;
}

.image-zoom-close:hover {
  background: rgba(255,255,255,0.2);
}

#zoomedImage {
  max-width: 100%;
  max-height: 80vh;
  object-fit: contain;
  border-radius: 8px;
  background: #fff;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.image-zoom-caption {
  margin-top: 16px;
  color: white;
  font-size: 1rem;
  text-align: center;
  padding: 8px 16px;
  background: rgba(255,255,255,0.1);
  border-radius: 8px;
  max-width: 80%;
}

/* Orders Modal */
.orders-modal-bg {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  padding: 20px;
  animation: fadeIn 0.2s ease;
}

.orders-modal-bg.show {
  display: flex;
}

.orders-modal {
  width: 100%;
  max-width: 800px;
  max-height: 90vh;
  border-radius: var(--radius);
  overflow: hidden;
  background: #fff;
  box-shadow: var(--shadow-lg);
  border: 1px solid var(--border);
  display: flex;
  flex-direction: column;
}

.modal-header {
  padding: 20px 24px;
  background: #fff;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title-bold {
  font-weight: 600;
  color: var(--dark);
  font-size: 1.2rem;
}

.modal-body {
  padding: 24px;
  overflow-y: auto;
  flex: 1;
  background: #fff;
}

.modal-footer {
  padding: 20px 24px;
  background: #f9fafb;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

/* Product Image Styles */
.product-image-small {
  width: 40px;
  height: 40px;
  border-radius: 6px;
  object-fit: cover;
  border: 1px solid var(--border);
  background: #f5f5f5;
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.product-image-small:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.product-image-large {
  max-width: 90vw;
  max-height: 90vh;
  object-fit: contain;
  border-radius: 12px;
  background: #fff;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--muted);
}

.empty-state i {
  font-size: 3rem;
  margin-bottom: 16px;
  color: #d1d5db;
}

/* Toast Notification */
.oh-toast {
  position: fixed;
  right: 24px;
  bottom: 24px;
  padding: 16px 20px;
  background: #fff;
  border: 1px solid var(--border);
  box-shadow: var(--shadow-lg);
  border-left: 4px solid var(--success);
  z-index: 1400;
  display: flex;
  gap: 12px;
  align-items: center;
  transform: translateY(10px);
  opacity: 0;
  transition: all .3s ease;
  border-radius: 8px;
  min-width: 300px;
}

.oh-toast.show {
  opacity: 1;
  transform: translateY(0);
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Tablet Styles */
@media (max-width: 1024px) {
  .orders-view {
    padding: 16px;
  }
  
  .orders-title {
    font-size: 1.3rem;
  }
  
  .search-box {
    min-width: 240px;
  }
  
  .orders-card {
    padding: 14px;
  }
}

/* Mobile & Tablet: Switch to cards */
@media (max-width: 900px) {
  .table-wrapper {
    display: none;
  }
  
  .mobile-cards {
    display: flex;
    flex-direction: column;
  }
  
  .orders-top {
    flex-direction: column;
    gap: 16px;
  }
  
  .orders-controls {
    width: 100%;
  }
  
  .orders-card {
    width: 100%;
    flex-direction: column;
    align-items: stretch;
  }
  
  .filter-select,
  .search-box {
    width: 100%;
    min-width: auto;
  }
  
  .search-box {
    min-width: auto;
  }
  
  .image-zoom-close {
    top: -60px;
    right: 50%;
    transform: translateX(50%);
  }
  
  .image-zoom-caption {
    max-width: 90%;
    font-size: 0.9rem;
  }
}

/* Mobile Styles */
@media (max-width: 640px) {
  .orders-view {
    padding: 12px;
  }
  
  .orders-title {
    font-size: 1.2rem;
  }
  
  .table-card {
    padding: 16px;
  }
  
  .orders-controls {
    gap: 8px;
  }
  
  .card-details {
    grid-template-columns: 1fr;
    gap: 8px;
  }
  
  .modal-header,
  .modal-body,
  .modal-footer {
    padding: 16px;
  }
  
  .orders-modal {
    width: calc(100% - 20px);
    max-height: 85vh;
  }
  
  .modal-footer {
    flex-direction: column-reverse;
  }
  
  .modal-footer button {
    width: 100%;
  }
  
  .oh-toast {
    left: 12px;
    right: 12px;
    bottom: 12px;
    min-width: auto;
  }
}

/* Small Mobile */
@media (max-width: 480px) {
  .orders-title {
    font-size: 1.1rem;
  }
  
  .orders-sub {
    font-size: 0.8rem;
  }
  
  .order-card {
    padding: 14px;
  }
  
  .customer-avatar {
    width: 36px;
    height: 36px;
    font-size: 0.9rem;
  }
}
</style>

<div class="page-container">
  <div class="orders-view fade-in">

    <div class="orders-top">
      <div class="orders-title-section">
        <div class="orders-title">Order Management</div>
        <div class="orders-sub">Manage and track customer orders</div>
      </div>

      <div class="orders-controls">
        <div class="orders-card filters-row">
          <select id="ov-status" class="filter-select" title="Filter by status">
            <option value="all">All Orders</option>
            <option value="pending">Pending</option>
            <option value="confirmed">Confirmed</option>
            <option value="shipped">Shipped</option>
            <option value="out-for-delivery">Out for Delivery</option>
            <option value="delivered">Delivered</option>
            <option value="cancelled">Cancelled</option>
          </select>

          <select id="ov-date" class="filter-select" title="Filter by date">
            <option value="all">All Time</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
          </select>

          <div class="search-box">
            <i class="fas fa-search" style="color: #9ca3af;"></i>
            <input id="ov-search" placeholder="Search order ID, customer, email">
          </div>
        </div>

        <button id="ov-refresh" class="btn-ghost" title="Refresh">
          <i class="fas fa-sync-alt"></i>
          <span class="mobile-hide">Refresh</span>
        </button>
        <button id="ov-export" class="btn-primary" title="Export visible orders">
          <i class="fas fa-download"></i>
          <span class="mobile-hide">Export</span>
        </button>
      </div>
    </div>

    <div class="table-card">
      <div class="table-wrapper">
        <table class="orders-table" aria-label="Orders table">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Customer</th>
              <th>Date</th>
              <th>Items</th>
              <th>Total</th>
              <th>Status</th>
              <th style="text-align:right">Actions</th>
            </tr>
          </thead>
          <tbody id="ov-tbody">
            <tr><td colspan="7" class="muted">Loading orders…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="mobile-cards" id="ov-cards" aria-hidden="true"></div>
    </div>

    <!-- Product Image Zoom Modal -->
    <div class="image-zoom-modal" id="imageZoomModal">
      <div class="image-zoom-content">
        <button class="image-zoom-close" id="imageZoomClose" aria-label="Close zoom">
          <i class="fas fa-times"></i>
        </button>
        <img id="zoomedImage" class="product-image-large" alt="Product image" />
        <div id="imageCaption" class="image-zoom-caption"></div>
      </div>
    </div>

    <!-- Order Details Modal -->
    <div class="orders-modal-bg" id="ov-modal-bg" role="dialog" aria-hidden="true">
      <div class="orders-modal" role="document" aria-modal="true">
        <div class="modal-header">
          <div class="modal-title-bold" id="ov-modal-title">Order Details</div>
          <button id="ov-modal-close" class="btn-ghost" aria-label="Close">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="modal-body" id="ov-modal-body"></div>

        <div class="modal-footer">
          <button id="ov-modal-cancel" class="btn-ghost">Close</button>
          <button id="ov-modal-save" class="btn-primary">
            <i class="fas fa-save"></i>
            Save Changes
          </button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Toast Notification -->
<div id="oh-toast" class="oh-toast" role="status" aria-live="polite">
  <i class="fas fa-check-circle" style="color:var(--success)"></i>
  <div id="oh-toast-text">Changes saved successfully</div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
(function () {
  const config = {
    apiKey: "AIzaSyDuF6bdqprddsE871GuOablXPYqXI_HJxc",
    authDomain: "hexahoney-96aed.firebaseapp.com",
    projectId: "hexahoney-96aed",
    storageBucket: "hexahoney-96aed.firebasestorage.app",
    messagingSenderId: "700458850837",
    appId: "1:700458850837:web:0eb4fca98a5f4acc2d0c1c",
    measurementId: "G-MQGKK9709H",
  };

  if (window.firebase) {
    if (!firebase.apps.length) firebase.initializeApp(config);
  }
  
  let ordersCleanup = new Set();
  let ordersListener = null;

  function cleanupOrders() {
    ordersCleanup.forEach(fn => fn());
    ordersCleanup.clear();
    if (ordersListener) {
      ordersListener();
      ordersListener = null;
    }
  }

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  const db = firebase.firestore();

  const t = document.getElementById("ov-tbody"),
    c = document.getElementById("ov-cards"),
    m = document.getElementById("ov-modal-bg"),
    mc = document.getElementById("ov-modal-close"),
    mca = document.getElementById("ov-modal-cancel"),
    ms = document.getElementById("ov-modal-save"),
    mb = document.getElementById("ov-modal-body"),
    fs = document.getElementById("ov-status"),
    fd = document.getElementById("ov-date"),
    si = document.getElementById("ov-search"),
    rb = document.getElementById("ov-refresh"),
    xb = document.getElementById("ov-export"),
    tw = document.getElementById("oh-toast"),
    tt = document.getElementById("oh-toast-text"),
    imgZoomModal = document.getElementById("imageZoomModal"),
    imgZoomClose = document.getElementById("imageZoomClose"),
    zoomedImage = document.getElementById("zoomedImage"),
    imageCaption = document.getElementById("imageCaption");

  let orders = [],
    filtered = [],
    editing = null;

  function toast(message, type = "success") {
    tt.textContent = message;
    tw.style.borderLeftColor = type === "error" ? "#ef4444" : type === "warning" ? "#f59e0b" : "#10b981";
    tw.querySelector("i").style.color = type === "error" ? "#ef4444" : type === "warning" ? "#f59e0b" : "#10b981";
    tw.classList.add("show");
    setTimeout(() => tw.classList.remove("show"), 3000);
  }

  function esc(s) {
    return String(s || "").replace(/[&<>"']/g, (a) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;",
    }[a]));
  }

  function sid(x) {
    return x ? x.substring(0, 8) : "—";
  }

  function fdn(d) {
    if (!d) return "—";
    const x = d.toDate ? d.toDate() : new Date(d);
    return x.toLocaleDateString("en-IN", { 
      day: 'numeric', 
      month: 'short', 
      year: 'numeric' 
    });
  }

  function sc(s) {
    const statusMap = {
      'pending': 'pending',
      'confirmed': 'confirmed',
      'shipped': 'shipped',
      'out for delivery': 'out-for-delivery',
      'out-for-delivery': 'out-for-delivery',
      'delivered': 'delivered',
      'cancelled': 'cancelled'
    };
    
    const normalizedStatus = statusMap[s?.toLowerCase()] || 'pending';
    return "status-" + normalizedStatus;
  }

  // Image zoom functions
  function openImageZoom(imageSrc, altText) {
    zoomedImage.src = imageSrc;
    imageCaption.textContent = altText || "Product Image";
    imgZoomModal.classList.add("show");
    document.body.style.overflow = 'hidden';
  }

  function closeImageZoom() {
    imgZoomModal.classList.remove("show");
    document.body.style.overflow = 'auto';
  }

  // Close image zoom when clicking outside or on close button
  imgZoomModal.addEventListener('click', function(e) {
    if (e.target === imgZoomModal || e.target === imgZoomClose) {
      closeImageZoom();
    }
  });

  // Close with Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && imgZoomModal.classList.contains('show')) {
      closeImageZoom();
    }
  });

  function load() {
    t.innerHTML = `<tr><td colspan="7" class="muted">Loading orders…</td></tr>`;
    c.innerHTML = "";

    cleanupOrders();

    ordersListener = db.collection("orders")
      .orderBy("createdAt", "desc")
      .limit(100)
      .onSnapshot((q) => {
        orders = q.docs.map((d) => {
          const o = d.data();
          const firstName = o.shippingAddress?.firstName || "";
          const lastName = o.shippingAddress?.lastName || "";
          
          return {
            ...o,
            id: d.id,
            userId: o.userId || null,
            _name: (firstName + " " + lastName).toLowerCase().trim(),
            _email: (o.email || "").toLowerCase(),
            _created: o.createdAt?.toDate ? o.createdAt.toDate().getTime() : 0,
            items: o.items || [],
            customerInitials: (firstName.charAt(0) + lastName.charAt(0)).toUpperCase() || "CU"
          };
        });
        requestAnimationFrame(apply);
      }, (err) => {
        console.error("Error loading orders:", err);
        t.innerHTML = `<tr><td colspan="7"><div class="empty-state">
          <i class="fas fa-exclamation-circle"></i>
          <div style="margin-top: 8px;">Error loading orders</div>
        </div></td></tr>`;
        c.innerHTML = `<div class="empty-state">
          <i class="fas fa-exclamation-circle"></i>
          <div style="margin-top: 8px;">Error loading orders</div>
        </div>`;
      });

    ordersCleanup.add(() => {
      if (ordersListener) ordersListener();
    });
  }

  function empty() {
    t.innerHTML = `<tr><td colspan="7"><div class="empty-state">
      <i class="fas fa-box-open"></i>
      <div style="margin-top: 12px; font-size: 1rem;">No Orders Found</div>
      <div style="margin-top: 4px; font-size: 0.9rem;">Try adjusting your filters</div>
    </div></td></tr>`;
    c.innerHTML = `<div class="empty-state">
      <i class="fas fa-box-open"></i>
      <div style="margin-top: 12px; font-size: 1rem;">No Orders Found</div>
      <div style="margin-top: 4px; font-size: 0.9rem;">Try adjusting your filters</div>
    </div>`;
  }

  function createItemsPreview(items) {
    if (!items || items.length === 0) {
      return '<div class="muted">No items</div>';
    }
    
    const firstItem = items[0];
    const productImage = firstItem.image || 
                        firstItem.productImage || 
                        getDefaultProductImage(firstItem.name);
    
    return `
      <div class="flex-center" style="gap:10px; align-items: center;">
        <img src="${esc(productImage)}" 
             alt="${esc(firstItem.name)}" 
             class="product-image-small"
             data-image="${esc(productImage)}"
             data-name="${esc(firstItem.name)}"
             style="cursor:pointer"
             onerror="this.onerror=null; this.src='https://ik.imagekit.io/hexaanatura/Gemini_Generated_Image_gyalrfgyalrfgyal.jpg?updatedAt=1757217705022'">
        <div style="flex:1;">
          <div style="font-weight:500;font-size:0.9rem;line-height:1.2">${esc(firstItem.name)}</div>
          ${items.length > 1 ? 
            `<div style="font-size:0.8rem;color:#6b7280;margin-top:2px;">+ ${items.length - 1} more item${items.length > 2 ? 's' : ''}</div>` : 
            ''}
        </div>
      </div>
    `;
  }

  function createMobileCard(order) {
    const itemsCount = order.items?.length || 0;
    const total = order.total || 0;
    const firstName = order.shippingAddress?.firstName || "";
    const lastName = order.shippingAddress?.lastName || "";
    const customerName = `${firstName} ${lastName}`.trim() || "Customer";
    const statusDisplay = order.status === 'out for delivery' ? 'out for delivery' : (order.status || "pending");
    
    return `
      <div class="order-card" data-id="${esc(order.id)}">
        <div class="card-header">
          <div class="order-id">#${esc(sid(order.id))}</div>
          <span class="status-pill ${sc(order.status)}">${esc(statusDisplay)}</span>
        </div>
        
        <div class="customer-info">
          <div class="customer-avatar">${order.customerInitials}</div>
          <div class="customer-details">
            <div class="customer-name">${esc(customerName)}</div>
            <div class="customer-email">${esc(order.email || "—")}</div>
          </div>
        </div>
        
        <div class="card-details">
          <div class="detail-item">
            <div class="detail-label">Date</div>
            <div class="detail-value">${fdn(order.createdAt)}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Items</div>
            <div class="detail-value">${itemsCount}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Total</div>
            <div class="detail-value">₹${Number(total).toFixed(2)}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Payment</div>
            <div class="detail-value">${esc(order.paymentMethod || "COD")}</div>
          </div>
        </div>
        
        <div class="mobile-actions">
          <button class="action-btn view-btn" data-id="${order.id}" title="View Details">
            <i class="fas fa-eye"></i>
            <span style="margin-left: 6px; font-size: 0.85rem;">View</span>
          </button>
          <button class="action-btn edit-btn" data-id="${order.id}" title="Edit Status">
            <i class="fas fa-edit"></i>
            <span style="margin-left: 6px; font-size: 0.85rem;">Edit</span>
          </button>
        </div>
      </div>
    `;
  }

  function list(ordersToDisplay) {
    if (!ordersToDisplay.length) {
      empty();
      return;
    }

    // Update table view
    t.innerHTML = ordersToDisplay
      .map((order) => {
        const itemsCount = order.items?.length || 0;
        const total = order.total || 0;
        const firstName = order.shippingAddress?.firstName || "";
        const lastName = order.shippingAddress?.lastName || "";
        const customerName = `${firstName} ${lastName}`.trim() || "Customer";
        const statusDisplay = order.status === 'out for delivery' ? 'out for delivery' : (order.status || "pending");
        
        return `
          <tr data-id="${esc(order.id)}">
            <td>
              <div style="font-weight:500;color:#2563eb">#${esc(sid(order.id))}</div>
              ${order.userId ? `<div style="font-size:0.75rem;color:#6b7280">UID: ${esc(order.userId.substring(0, 6))}</div>` : ''}
            </td>
            <td>
              <div style="display:flex;gap:12px;align-items:center">
                <div style="width:36px;height:36px;border-radius:50%;background:#2563eb;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:500">
                  ${order.customerInitials}
                </div>
                <div>
                  <div style="font-weight:500">${esc(customerName)}</div>
                  <div style="font-size:0.85rem;color:#6b7280">${esc(order.email || "—")}</div>
                </div>
              </div>
            </td>
            <td>
              <div style="font-weight:500">${fdn(order.createdAt)}</div>
              ${order.createdAt ? `<div style="font-size:0.75rem;color:#6b7280">
                ${new Date(order.createdAt.toDate ? order.createdAt.toDate() : order.createdAt).toLocaleTimeString('en-IN', {hour: '2-digit', minute:'2-digit'})}
              </div>` : ''}
            </td>
            <td>${createItemsPreview(order.items)}</td>
            <td style="font-weight:500">₹${Number(total).toFixed(2)}</td>
            <td>
              <span class="status-pill ${sc(order.status)}">${esc(statusDisplay)}</span>
            </td>
            <td>
              <div class="actions-container">
                <button class="action-btn view-btn" data-id="${order.id}" title="View Details">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="action-btn edit-btn" data-id="${order.id}" title="Edit Status">
                  <i class="fas fa-edit"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      })
      .join("");

    // Update mobile cards view
    c.innerHTML = ordersToDisplay.map(order => createMobileCard(order)).join("");

    // Add event listeners to product images
    setTimeout(() => {
      document.querySelectorAll('.product-image-small[data-image]').forEach(img => {
        img.addEventListener('click', function(e) {
          e.stopPropagation();
          const imageSrc = this.getAttribute('data-image');
          const imageName = this.getAttribute('data-name') || 'Product Image';
          openImageZoom(imageSrc, imageName);
        });
      });
      
      // Add event listeners to action buttons
      bindActionButtons();
    }, 100);
  }

  function bindActionButtons() {
    document.querySelectorAll(".view-btn").forEach((btn) => {
      btn.onclick = (e) => {
        e.stopPropagation();
        open(e.currentTarget.dataset.id);
      };
    });

    document.querySelectorAll(".edit-btn").forEach((btn) => {
      btn.onclick = (e) => {
        e.stopPropagation();
        open(e.currentTarget.dataset.id);
      };
    });
  }

  function open(id) {
    const order = orders.find((x) => x.id === id);
    if (!order) return;

    editing = id;

    const address = order.shippingAddress
      ? [
          order.shippingAddress.address,
          order.shippingAddress.city,
          order.shippingAddress.state,
          order.shippingAddress.zipCode,
          order.shippingAddress.country,
        ]
          .filter(Boolean)
          .join(", ")
      : "No address provided";

    // Create items HTML
    const itemsHtml = (order.items || [])
      .map((item, index) => {
        const productImage = item.image || 
                            item.productImage || 
                            getDefaultProductImage(item.name) || 
                            'https://ik.imagekit.io/hexaanatura/Gemini_Generated_Image_gyalrfgyalrfgyal.jpg?updatedAt=1757217705022';
        
        return `
          <div style="display:flex;gap:16px;align-items:center;padding:12px;border-bottom:1px solid #e5e7eb;background:#fff;" 
               data-image="${esc(productImage)}" 
               data-name="${esc(item.name)}"
               onclick="openImageZoom('${esc(productImage)}', '${esc(item.name)}')">
            <div style="flex-shrink:0">
              <img src="${esc(productImage)}" 
                   alt="${esc(item.name)}" 
                   class="product-image-small"
                   style="width:48px;height:48px;cursor:pointer"
                   onerror="this.onerror=null; this.src='https://ik.imagekit.io/hexaanatura/Gemini_Generated_Image_gyalrfgyalrfgyal.jpg?updatedAt=1757217705022'">
            </div>
            <div style="flex:1">
              <div style="font-weight:500;font-size:0.95rem;margin-bottom:4px">${esc(item.name)}</div>
              <div style="display:flex;gap:12px;font-size:0.85rem;color:#6b7280;margin-bottom:4px">
                <span>${esc(item.weight || "")}</span>
                <span>•</span>
                <span>₹${item.price ? Number(item.price).toFixed(2) : '0.00'} each</span>
              </div>
            </div>
            <div style="flex-shrink:0;text-align:right">
              <div style="font-weight:500;margin-bottom:4px">Qty: ${item.quantity || 1}</div>
              <div style="font-weight:600;color:#1f2937">
                ₹${(item.price * (item.quantity || 1)).toFixed(2)}
              </div>
            </div>
          </div>
        `;
      })
      .join("") || '<div class="muted" style="padding:12px;text-align:center">No items</div>';

    mb.innerHTML = `
      <div style="display:grid;gap:20px;">
        <!-- Order ID -->
        <div>
          <div class="modal-title-bold">Order ID</div>
          <div style="font-family:monospace;background:#f3f4f6;padding:10px 14px;border-radius:8px;border:1px solid #e5e7eb;color:#374151;">
            #${esc(sid(id))}
          </div>
        </div>

        <!-- Customer Information -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">
          <div>
            <div class="modal-title-bold">Customer Name</div>
            <div style="padding:8px 0;color:#374151;">
              ${esc(order.shippingAddress ? order.shippingAddress.firstName + " " + order.shippingAddress.lastName : order.email || "—")}
            </div>
          </div>
          <div>
            <div class="modal-title-bold">Customer Email</div>
            <div style="padding:8px 0;color:#374151;">${esc(order.email || "—")}</div>
          </div>
        </div>

        <!-- Contact Information -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">
          <div>
            <div class="modal-title-bold">Phone Number</div>
            <div style="padding:8px 0;color:#374151;">${esc(order.shippingAddress?.phone || "—")}</div>
          </div>
          <div>
            <div class="modal-title-bold">Order Date</div>
            <div style="padding:8px 0;color:#374151;">${fdn(order.createdAt)}</div>
          </div>
        </div>

        <!-- Order Details -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">
          <div>
            <div class="modal-title-bold">Total Amount</div>
            <div style="font-weight:600;font-size:1.3rem;padding:8px 0;color:#1f2937">
              ₹${Number(order.total || 0).toFixed(2)}
            </div>
          </div>
          <div>
            <div class="modal-title-bold">Payment Method</div>
            <div style="padding:8px 0;color:#374151;">${esc(order.paymentMethod || "Cash on Delivery")}</div>
          </div>
        </div>

        <!-- Order Status -->
        <div>
          <div class="modal-title-bold">Order Status</div>
          <select id="ov-modal-status" 
                  style="padding:12px;border:1px solid #e5e7eb;border-radius:8px;width:100%;margin-top:8px;background:#fff;font-family:'Inter', sans-serif;color:#374151;">
            <option value="pending">Pending</option>
            <option value="confirmed">Confirmed</option>
            <option value="shipped">Shipped</option>
            <option value="out-for-delivery">Out for Delivery</option>
            <option value="delivered">Delivered</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>

        <!-- Shipping Address -->
        <div>
          <div class="modal-title-bold">Shipping Address</div>
          <div style="background:#f9fafb;padding:14px;border-radius:8px;border:1px solid #e5e7eb;margin-top:8px;color:#374151;">
            ${esc(address)}
          </div>
        </div>

        <!-- Order Items -->
        <div>
          <div class="modal-title-bold">Order Items (${(order.items || []).length})</div>
          <div style="margin-top:8px;border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;max-height:300px;overflow-y:auto;">
            ${itemsHtml}
          </div>
        </div>

        <!-- Additional Notes -->
        ${order.notes ? `
          <div>
            <div class="modal-title-bold">Additional Notes</div>
            <div style="background:#f9fafb;padding:14px;border-radius:8px;border:1px solid #e5e7eb;margin-top:8px;color:#374151;">
              ${esc(order.notes)}
            </div>
          </div>
        ` : ''}
      </div>
    `;

    // Set current status
    document.getElementById("ov-modal-status").value = order.status || "pending";

    // Show modal
    document.getElementById("ov-modal-title").textContent = `Order #${sid(id)} Details`;
    m.classList.add("show");
    document.body.style.overflow = 'hidden';
  }

  // Make openImageZoom function globally accessible
  window.openImageZoom = openImageZoom;

  function getDefaultProductImage(productName) {
    const productImages = {
      'natura agmark honey': 'https://ik.imagekit.io/hexaanatura/Gemini_Generated_Image_gyalrfgyalrfgyal.jpg?updatedAt=1757217705022',
      'honey': 'https://ik.imagekit.io/hexaanatura/Gemini_Generated_Image_gyalrfgyalrfgyal.jpg?updatedAt=1757217705022',
      'crystal pack': 'https://ik.imagekit.io/hexaanatura/Gemini_Generated_Image_i8jo3di8jo3di8jo.jpg?updatedAt=1757217705022',
      'premium pet': 'https://ik.imagekit.io/hexaanatura/Gemini_Generated_Image_cbat36cbat36cbat.jpg?updatedAt=1757217705022'
    };
    
    const name = (productName || '').toLowerCase();
    for (const [key, image] of Object.entries(productImages)) {
      if (name.includes(key)) {
        return image;
      }
    }
    
    return 'https://ik.imagekit.io/hexaanatura/Gemini_Generated_Image_gyalrfgyalrfgyal.jpg?updatedAt=1757217705022';
  }

  function close() {
    m.classList.remove("show");
    document.body.style.overflow = 'auto';
    editing = null;
  }
  
  function save() {
    if (!editing) return;

    const status = document.getElementById("ov-modal-status").value;
    const originalText = ms.innerHTML;
    
    ms.disabled = true;
    ms.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

    const updateData = {
      status: status,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    // Add timestamps for status transitions
    if (status === 'confirmed') {
      updateData.confirmedAt = firebase.firestore.FieldValue.serverTimestamp();
    } else if (status === 'shipped') {
      updateData.shippedAt = firebase.firestore.FieldValue.serverTimestamp();
    } else if (status === 'out-for-delivery') {
      updateData.outForDeliveryAt = firebase.firestore.FieldValue.serverTimestamp();
    } else if (status === 'delivered') {
      updateData.deliveredAt = firebase.firestore.FieldValue.serverTimestamp();
    }

    const orderRef = db.collection("orders").doc(editing);
    
    orderRef.update(updateData)
      .then(() => {
        // Also update in user's orders if userId exists
        const order = orders.find(o => o.id === editing);
        if (order && order.userId) {
          const userOrderRef = db.collection("users").doc(order.userId)
            .collection("orders").doc(editing);
          
          return userOrderRef.update(updateData).catch(() => {
            // Silently fail if user order doesn't exist
            return Promise.resolve();
          });
        }
        return Promise.resolve();
      })
      .then(() => {
        toast("Order status updated successfully");
        close();
      })
      .catch((error) => {
        console.error("Error updating order:", error);
        toast("Failed to update order: " + error.message, "error");
      })
      .finally(() => {
        ms.disabled = false;
        ms.innerHTML = originalText;
      });
  }

  function apply() {
    let filteredOrders = [...orders];
    const statusFilter = fs.value;
    const dateFilter = fd.value;
    const searchQuery = si.value.toLowerCase().trim();

    // Apply status filter
    if (statusFilter !== "all") {
      filteredOrders = filteredOrders.filter(order => 
        (order.status || "").toLowerCase() === statusFilter
      );
    }

    // Apply date filter
    if (dateFilter !== "all") {
      const now = Date.now();
      let startTime = null;

      if (dateFilter === "today") {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        startTime = today.getTime();
      } else if (dateFilter === "week") {
        startTime = now - 7 * 86400000; // 7 days
      } else if (dateFilter === "month") {
        startTime = now - 30 * 86400000; // 30 days
      }

      if (startTime !== null) {
        filteredOrders = filteredOrders.filter(order => order._created >= startTime);
      }
    }

    // Apply search filter
    if (searchQuery) {
      filteredOrders = filteredOrders.filter(order => 
        order.id.toLowerCase().includes(searchQuery) ||
        order._name.includes(searchQuery) ||
        order._email.includes(searchQuery) ||
        (order.shippingAddress?.phone || "").includes(searchQuery)
      );
    }

    filtered = filteredOrders;
    list(filteredOrders);
  }

  function exportToCSV() {
    if (!filtered.length) {
      toast("No orders to export", "warning");
      return;
    }

    const headers = ["Order ID", "Customer Name", "Email", "Phone", "Date", "Items", "Total", "Status", "Payment Method"];
    
    const rows = filtered.map(order => {
      const customerName = order.shippingAddress ? 
        `${order.shippingAddress.firstName} ${order.shippingAddress.lastName}`.trim() : 
        "Unknown";
      
      return [
        `#${sid(order.id)}`,
        customerName,
        order.email || "",
        order.shippingAddress?.phone || "",
        fdn(order.createdAt),
        order.items?.length || 0,
        `₹${Number(order.total || 0).toFixed(2)}`,
        order.status || "pending",
        order.paymentMethod || "COD"
      ];
    });

    const csvContent = [
      headers.join(","),
      ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(","))
    ].join("\n");

    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    
    if (link.download !== undefined) {
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", `orders_${new Date().toISOString().slice(0,10)}.csv`);
      link.style.visibility = "hidden";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      toast(`Exported ${filtered.length} orders`, "success");
    }
  }

  // Event Listeners
  document.addEventListener("click", (e) => {
    if (e.target === m) close();
  });

  mc.onclick = close;
  mca.onclick = close;
  ms.onclick = save;
  fs.onchange = apply;
  fd.onchange = apply;
  si.oninput = debounce(apply, 300);
  
  rb.onclick = () => {
    load();
    toast("Refreshing orders...", "info");
  };
  
  xb.onclick = exportToCSV;

  // Initialize
  load();
})();
</script>
