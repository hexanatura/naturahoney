<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

/* Status badge */
.status-out-for-delivery {
    background: rgba(168,85,247,0.08);
    color: #a855f7;
    border: 1px solid rgba(168,85,247,0.12);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 4px 10px;
    white-space: nowrap;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 500;
}

/* Action buttons wrapper */
.action-buttons-container {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    align-items: center;
    width: 100%;
}

/* Action button */
.action-btn {
    border-radius: 8px;
    border: none;
    padding: 8px;
    background: transparent;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 0.95rem;
    min-width: 40px;
    height: 40px;
}

.action-btn .fa-eye { color: var(--dark); }
.action-btn .fa-edit { color: var(--success); }

/* Table actions alignment */
.orders-table td:last-child {
    text-align: right;
    padding-right: 0;
}

/* Mobile card actions */
.card-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    justify-content: flex-end;
    width: 100%;
}

.orders-view {
  padding: 22px;
  background: #fff;
  min-height: 100vh;
}

.orders-modal .modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.orders-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  margin-bottom: 18px;
  flex-wrap: wrap;
}

/* Reduced boldness for titles */
.orders-title {
  font-family: 'Outfit', sans-serif;
  font-size: 1.2rem;
  font-weight: 600; /* Reduced from 700 */
  color: var(--dark);
}

.modal-title-bold {
  font-weight: 600 !important; /* Reduced from 700 */
  color: var(--dark);
  margin-bottom: 4px;
}

.product-image-small {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  object-fit: cover;
  border: 1px solid var(--border);
  background: #f5f5f5;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.product-image-small:hover {
  transform: scale(1.05);
}

/* Product image modal */
.product-image-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.product-image-modal.show {
  opacity: 1;
  visibility: visible;
}

.product-image-modal img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 8px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.product-image-modal-close {
  position: absolute;
  top: 20px;
  right: 20px;
  color: white;
  font-size: 2rem;
  cursor: pointer;
  background: rgba(0,0,0,0.5);
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.flex-center {
  display: flex;
  align-items: center;
  gap: 10px;
}

.flex-column {
  display: flex;
  flex-direction: column;
}

.orders-sub {
  font-size: 0.9rem;
  color: var(--muted);
  margin-top: 4px;
  font-weight: 400; /* Normal weight for subtitle */
}

.orders-controls {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.orders-card {
  background: #fff;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 14px;
  border: 1px solid var(--border);
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.filter-select,
.search-box {
  padding: 10px 14px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: #fff;
  font-size: 0.95rem;
  min-width: 160px;
  font-weight: 400; /* Normal weight for inputs */
}

.search-box {
  display: flex;
  gap: 8px;
  align-items: center;
  min-width: 260px;
  max-width: 420px;
}

.search-box input {
  border: 0;
  outline: none;
  background: transparent;
  width: 100%;
  font-size: 0.95rem;
  font-weight: 400;
}

.btn-primary {
  background: var(--dark);
  color: var(--secondary);
  border-radius: 10px;
  padding: 9px 14px;
  border: none;
  cursor: pointer;
  font-weight: 600; /* Reduced from 700 */
}

.btn-ghost {
  background: transparent;
  border: 1px solid var(--border);
  padding: 8px 12px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 500; /* Reduced from 600 */
}

.table-card {
  margin-top: 16px;
  background: #fff;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 16px;
  border: 1px solid var(--border);
}

.table-wrapper {
  overflow: auto;
  background: #fff;
}

.orders-table {
  width: 100%;
  border-collapse: collapse;
  min-width: 900px;
  font-size: 0.95rem;
  background: #fff;
}

.orders-table thead th {
  text-align: left;
  padding: 12px 16px;
  font-weight: 600; /* Reduced from 700 */
  color: var(--dark);
  border-bottom: 1px solid var(--border);
  background: #fff;
}

.orders-table td {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  vertical-align: middle;
  color: var(--dark);
  background: #fff;
  font-weight: 400; /* Normal weight for table data */
}

/* Keep only important text bold */
.orders-table td div[style*="font-weight:700"] {
  font-weight: 600; /* Reduced from 700 */
}

.status-pill {
  display: inline-block;
  padding: 6px 10px;
  border-radius: 999px;
  font-weight: 600; /* Reduced from 700 */
  font-size: 0.75rem;
}

.status-pending { background: rgba(245,158,11,0.08); color:#f59e0b; border:1px solid rgba(245,158,11,0.12); }
.status-confirmed { background: rgba(59,130,246,0.08); color:#3b82f6; border:1px solid rgba(59,130,246,0.12); }
.status-shipped { background: rgba(16,185,129,0.08); color:#10b981; border:1px solid rgba(16,185,129,0.12); }
.status-delivered { background: rgba(101,163,13,0.08); color:#65a30d; border:1px solid rgba(101,163,13,0.12); }
.status-cancelled { background: rgba(239,68,68,0.08); color:#ef4444; border:1px solid rgba(239,68,68,0.12); }

.mobile-cards {
  display: none;
  gap: 12px;
  margin-top: 12px;
}

.order-card {
  background: #fff;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 14px;
  border: 1px solid var(--border);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.customer-name {
  font-weight: 500; /* Reduced from 600 */
  color: var(--dark);
}

.card-meta {
  color: var(--muted);
  font-size: 0.85rem;
  font-weight: 400;
}

.orders-modal-bg {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(6,8,15,0.6);
  z-index: 1200;
  padding: 20px;
}

.orders-modal-bg.show {
  display: flex;
}

.orders-modal {
  width: 100%;
  max-width: 760px;
  border-radius: 12px;
  overflow: hidden;
  background: #fff;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  max-height: 90vh;
  overflow-y: auto;
}

.orders-modal .modal-header,
.orders-modal .modal-body,
.orders-modal .modal-footer {
  padding: 14px 16px;
  background: #fff;
}

/* Modal section headers - keep these bold */
.modal-section-title {
  font-weight: 600;
  color: var(--dark);
  margin-top: 16px;
  margin-bottom: 8px;
  font-size: 0.95rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Modal data - normal weight */
.modal-data {
  font-weight: 400;
  color: var(--dark);
  margin-bottom: 12px;
}

.modal-data strong {
  font-weight: 600;
}

.empty-state {
  text-align: center;
  padding: 36px 12px;
  color: var(--muted);
  font-weight: 400;
}

.oh-toast {
  position: fixed;
  right: 22px;
  bottom: 22px;
  padding: 12px 16px;
  background: #fff;
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  border-left: 4px solid var(--success);
  z-index: 1400;
  display: flex;
  gap: 10px;
  align-items: center;
  transform: translateY(10px);
  opacity: 0;
  transition: all .2s ease;
}

.oh-toast.show {
  opacity: 1;
  transform: translateY(0);
}

/* Product items in modal */
.product-item-modal {
  display: flex;
  gap: 12px;
  align-items: center;
  padding: 12px;
  border-bottom: 1px solid var(--border);
  background: #fff;
}

.product-item-modal:last-child {
  border-bottom: none;
}

.product-image-modal-item {
  width: 50px;
  height: 50px;
  border-radius: 8px;
  object-fit: cover;
  border: 1px solid var(--border);
  background: #f5f5f5;
  cursor: pointer;
}

.product-info-modal {
  flex: 1;
}

.product-name-modal {
  font-weight: 500;
  color: var(--dark);
  margin-bottom: 4px;
}

.product-details-modal {
  font-size: 0.85rem;
  color: var(--muted);
}

.product-quantity-modal,
.product-price-modal {
  font-weight: 500;
  color: var(--dark);
  min-width: 60px;
  text-align: right;
}

@media (max-width:1023px) {
  .table-wrapper { display: none; }
  .mobile-cards { display: flex; flex-direction: column; }
  .orders-controls { width: 100%; flex-direction: column; }
  .orders-card { width: 100%; flex-direction: column; }
  .search-box, .filter-select {
    width: 100%;
    max-width: 100%;
  }
}

@media (max-width:768px) {
  .orders-title { font-size: 1.1rem; }
  .orders-sub { font-size: 0.85rem; }
  .orders-card { padding: 12px; }
  .orders-modal { width: 100%; max-width: 90%; }
}

@media (max-width:480px) {
  .orders-view { padding: 14px; }
  .orders-card { padding: 10px; }
  .orders-table td,
  .orders-table th {
    padding: 8px 10px;
  }
  .orders-modal {
    width: calc(100% - 20px);
  }
  .product-item-modal {
    flex-wrap: wrap;
  }
}
</style>

</head>
<body>
  <div class="page-container">
    <div class="orders-view fade-in">
      <div class="orders-top">
        <div>
          <div class="orders-title">Order Management</div>
          <div class="orders-sub muted">Manage and track customer orders</div>
        </div>

        <div class="orders-controls">
          <div class="orders-card filters-row">
            <select id="ov-status" class="filter-select" title="Filter by status">
              <option value="all">All Orders</option>
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="shipped">Shipped</option>
              <option value="delivered">Delivered</option>
              <option value="cancelled">Cancelled</option>
            </select>

            <select id="ov-date" class="filter-select" title="Filter by date">
              <option value="all">All Time</option>
              <option value="today">Today</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
            </select>

            <div class="search-box">
              <i class="fas fa-search muted"></i>
              <input id="ov-search" placeholder="Search order ID, customer, email">
            </div>
          </div>

          <button id="ov-refresh" class="btn-ghost" title="Refresh"><i class="fas fa-sync-alt"></i></button>
          <button id="ov-export" class="btn-primary" title="Export visible orders"><i class="fas fa-download" style="margin-right:8px"></i> Export</button>
        </div>
      </div>

      <div class="table-card">
        <div class="table-wrapper">
          <table class="orders-table" aria-label="Orders table">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Date</th>
                <th>Items</th>
                <th>Total</th>
                <th>Status</th>
                <th style="text-align:right">Actions</th>
              </tr>
            </thead>
            <tbody id="ov-tbody">
              <tr><td colspan="7" class="muted">Loading orders…</td></tr>
            </tbody>
          </table>
        </div>

        <div class="mobile-cards" id="ov-cards" aria-hidden="true"></div>
      </div>

      <div class="orders-modal-bg" id="ov-modal-bg" role="dialog" aria-hidden="true">
        <div class="orders-modal" role="document" aria-modal="true">
          <div class="modal-header">
            <div style="font-weight:600" id="ov-modal-title">Order Details</div>
            <button id="ov-modal-close" class="btn-ghost" aria-label="Close"><i class="fas fa-times"></i></button>
          </div>

          <div class="modal-body" id="ov-modal-body"></div>

          <div class="modal-footer">
            <button id="ov-modal-cancel" class="btn-ghost">Close</button>
            <button id="ov-modal-save" class="btn-primary"><i class="fas fa-save" style="margin-right:8px"></i> Save</button>
          </div>
        </div>
      </div>
      
      <!-- Product Image View Modal -->
      <div class="product-image-modal" id="productImageModal">
        <div class="product-image-modal-close" id="productImageModalClose">&times;</div>
        <img id="productImageModalImg" src="" alt="Product Image">
      </div>

    </div>
  </div>

  <div id="oh-toast" class="oh-toast" role="status" aria-live="polite">
    <i class="fas fa-check-circle" style="color:var(--success)"></i>
    <div id="oh-toast-text">Saved</div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="activityLogger.js?v=1"></script>

<script>
(function () {
  const config = {
    apiKey: "AIzaSyDuF6bdqprddsE871GuOablXPYqXI_HJxc",
    authDomain: "hexahoney-96aed.firebaseapp.com",
    projectId: "hexahoney-96aed",
    storageBucket: "hexahoney-96aed.firebasestorage.app",
    messagingSenderId: "700458850837",
    appId: "1:700458850837:web:0eb4fca98a5f4acc2d0c1c",
    measurementId: "G-MQGKK9709H",
  };

  if (window.firebase) {
    if (!firebase.apps.length) firebase.initializeApp(config);
  }
  
  let ordersCleanup = new Set();
  let ordersListener = null;

  function cleanupOrders() {
    ordersCleanup.forEach(fn => fn());
    ordersCleanup.clear();
    if (ordersListener) {
      ordersListener();
      ordersListener = null;
    }
  }

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  const db = firebase.firestore();
  const t = document.getElementById("ov-tbody"),
    c = document.getElementById("ov-cards"),
    m = document.getElementById("ov-modal-bg"),
    mc = document.getElementById("ov-modal-close"),
    mca = document.getElementById("ov-modal-cancel"),
    ms = document.getElementById("ov-modal-save"),
    mb = document.getElementById("ov-modal-body"),
    fs = document.getElementById("ov-status"),
    fd = document.getElementById("ov-date"),
    si = document.getElementById("ov-search"),
    rb = document.getElementById("ov-refresh"),
    xb = document.getElementById("ov-export"),
    tw = document.getElementById("oh-toast"),
    tt = document.getElementById("oh-toast-text"),
    productImageModal = document.getElementById("productImageModal"),
    productImageModalImg = document.getElementById("productImageModalImg"),
    productImageModalClose = document.getElementById("productImageModalClose");

  let orders = [],
    filtered = [],
    editing = null;

  function showProductImage(src, alt) {
    productImageModalImg.src = src;
    productImageModalImg.alt = alt;
    productImageModal.classList.add("show");
    document.body.style.overflow = "hidden";
  }

  function hideProductImage() {
    productImageModal.classList.remove("show");
    document.body.style.overflow = "auto";
  }

  productImageModalClose.onclick = hideProductImage;
  productImageModal.onclick = function(e) {
    if (e.target === productImageModal) hideProductImage();
  };

  function toast(m, y = "success") {
    tt.textContent = m;
    tw.classList.add("show");
    setTimeout(() => tw.classList.remove("show"), 2600);
  }

  function esc(s) {
    return String(s || "").replace(/[&<>"']/g, (a) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;",
    }[a]));
  }

  function sid(x) {
    return x ? x.substring(0, 8) : "—";
  }

  function fdn(d) {
    if (!d) return "—";
    const x = d.toDate ? d.toDate() : new Date(d);
    return x.toLocaleDateString("en-IN");
  }

  function sc(s) {
    const status = (s || "").toLowerCase().replace(/\s+/g, '-');
    const statusMap = {
      'pending': 'status-pending',
      'confirmed': 'status-confirmed',
      'shipped': 'status-shipped',
      'out-for-delivery': 'status-out-for-delivery',
      'outfordelivery': 'status-out-for-delivery',
      'delivered': 'status-delivered',
      'cancelled': 'status-cancelled'
    };
    return statusMap[status] || 'status-pending';
  }

  function getDefaultProductImage(productName) {
    return 'https://ik.imagekit.io/hexaanatura/Gemini_Generated_Image_gyalrfgyalrfgyal.jpg?updatedAt=1757217705022';
  }

  function load() {
    t.innerHTML = `<tr><td colspan="7" class="muted">Loading orders…</td></tr>`;
    c.innerHTML = "";

    cleanupOrders();

    ordersListener = db.collection("orders")
      .orderBy("createdAt", "desc")
      .limit(50)
      .onSnapshot((q) => {
        orders = q.docs.map((d) => {
          const o = d.data();
          return {
            ...o,
            id: d.id,
            userId: o.userId || null,
            _name: ((o.shippingAddress?.firstName || "") + " " + (o.shippingAddress?.lastName || "")).toLowerCase(),
            _email: (o.email || "").toLowerCase(),
            _created: o.createdAt?.toDate ? o.createdAt.toDate().getTime() : 0,
            items: o.items || [],
          };
        });
        requestAnimationFrame(apply);
      }, (err) => {
        empty();
        toast("Error loading orders", "error");
      });

    ordersCleanup.add(() => {
      if (ordersListener) ordersListener();
    });
  }

  function empty() {
    t.innerHTML = `<tr><td colspan="7"><div class="empty-state">No Orders Found</div></td></tr>`;
    c.innerHTML = `<div class="order-card muted">No orders</div>`;
  }

  function list(x) {
    if (!x.length) {
      empty();
      return;
    }

    t.innerHTML = x
      .map((o) => {
        const it = (o.items || []).length,
          tot = o.total || 0;
        const cu = o.shippingAddress
          ? o.shippingAddress.firstName + " " + o.shippingAddress.lastName
          : o.email || "Customer";

        let itemsPreview = 'No items';
        if (it > 0) {
          const firstItem = o.items[0];
          const productImage = firstItem.image || 
                              firstItem.productImage || 
                              getDefaultProductImage(firstItem.name);
          
          itemsPreview = `
            <div class="flex-center" style="gap:8px;">
              <img src="${esc(productImage)}" 
                   alt="${esc(firstItem.name)}" 
                   class="product-image-small"
                   onclick="showProductImage('${esc(productImage)}', '${esc(firstItem.name)}')"
                   style="width:24px;height:24px;border-radius:4px;object-fit:cover;border:1px solid var(--border);"
                   onerror="this.onerror=null; this.src='https://ik.imagekit.io/hexaanatura/Gemini_Generated_Image_gyalrfgyalrfgyal.jpg?updatedAt=1757217705022'">
              <div>
                <div style="font-weight:500;font-size:0.85rem">${esc(firstItem.name)}</div>
                ${it > 1 ? `<div class="muted" style="font-size:0.75rem">+ ${it - 1} more</div>` : ''}
              </div>
            </div>
          `;
        }

        const statusClass = sc(o.status);
        
        return `
          <tr data-id="${esc(o.id)}">
            <td>
              <div style="font-weight:600">#${esc(sid(o.id))}</div>
              ${o.userId ? `<small class="muted" style="font-size:0.75rem">UID: ${esc(o.userId.substring(0, 6))}</small>` : ''}
            </td>
            <td>
              <div style="display:flex;gap:10px;align-items:center">
                <div style="width:36px;height:36px;border-radius:8px;background:#000;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:500">
                  ${esc(cu.slice(0, 2).toUpperCase())}
                </div>
                <div>
                  <div style="font-weight:500">${esc(cu)}</div>
                  <div class="muted">${esc(o.email || "—")}</div>
                </div>
              </div>
            </td>
            <td>
              <div style="font-weight:500">${fdn(o.createdAt)}</div>
              ${o.createdAt ? `<small class="muted" style="font-size:0.75rem">
                ${new Date(o.createdAt.toDate ? o.createdAt.toDate() : o.createdAt).toLocaleTimeString('en-IN', {hour: '2-digit', minute:'2-digit'})}
              </small>` : ''}
            </td>
            <td>${itemsPreview}</td>
            <td style="font-weight:600">₹${Number(tot).toFixed(2)}</td>
            <td>
              <span class="status-pill ${statusClass}">${esc(o.status || "pending")}</span>
            </td>
            <td>
              <div class="action-buttons-container">
                <button class="action-btn view-btn" data-id="${o.id}" title="View Details">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="action-btn edit-btn" data-id="${o.id}" title="Edit Status">
                  <i class="fas fa-edit"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      })
      .join("");

    bind();
  }

  function bind() {
    document.querySelectorAll(".view-btn").forEach((b) => {
      b.onclick = (e) => open(e.currentTarget.dataset.id);
    });

    document.querySelectorAll(".edit-btn").forEach((b) => {
      b.onclick = (e) => open(e.currentTarget.dataset.id);
    });

    document.querySelectorAll(".user-btn").forEach((b) => {
      b.onclick = (e) => {
        const userId = e.currentTarget.dataset.user;
        alert(`User ID: ${userId}\nWould open user profile here.`);
      };
    });
  }

function open(id) {
    const o = orders.find((x) => x.id === id);
    if (!o) return;

    editing = id;

    // Format address if available
    const address = o.shippingAddress ? `
        ${o.shippingAddress.address || ''}<br>
        ${o.shippingAddress.city || ''}, ${o.shippingAddress.state || ''}<br>
        ${o.shippingAddress.zipCode || ''}<br>
        ${o.shippingAddress.country || ''}
    ` : "No address provided";

    // Format phone
    const phone = o.shippingAddress?.phone || "Not provided";

    // Format items with images - added data attributes for image viewing
    const itemsHTML = (o.items || [])
        .map((item, index) => {
            const productImage = item.image || item.productImage || getDefaultProductImage(item.name);
            return `
            <div class="product-item-modal" data-index="${index}">
                <div style="display:flex;align-items:center;gap:12px;padding:12px;border-bottom:1px solid var(--border);">
                    <img src="${esc(productImage)}" 
                         alt="${esc(item.name)}" 
                         class="product-image-modal-item"
                         data-image="${esc(productImage)}"
                         data-name="${esc(item.name)}"
                         style="width:50px;height:50px;border-radius:6px;object-fit:cover;border:1px solid var(--border);cursor:pointer;"
                         onerror="this.onerror=null; this.src='https://ik.imagekit.io/hexaanatura/Gemini_Generated_Image_gyalrfgyalrfgyal.jpg?updatedAt=1757217705022'">
                    <div style="flex:1">
                        <div style="font-weight:500;color:var(--dark);margin-bottom:4px">${esc(item.name)}</div>
                        <div style="font-size:0.85rem;color:var(--muted)">
                            ${item.weight ? esc(item.weight) + ' • ' : ''}
                            Quantity: ${item.quantity}
                        </div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-weight:600;color:var(--dark)">₹${(item.price * item.quantity).toFixed(2)}</div>
                        <div style="font-size:0.85rem;color:var(--muted)">₹${Number(item.price).toFixed(2)} each</div>
                    </div>
                </div>
            </div>
            `;
        })
        .join("") || '<div style="padding:20px;text-align:center;color:var(--muted)">No items in this order</div>';

    // Calculate subtotal
    const subtotal = (o.items || []).reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const tax = o.tax || 0;
    const shipping = o.shipping || 0;
    const total = o.total || subtotal + tax + shipping;

    mb.innerHTML = `
        <div style="display:grid;gap:20px;">
            <!-- Order Header -->
            <div style="background:var(--light);padding:16px;border-radius:8px;border:1px solid var(--border);">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px;">
                    <div>
                        <div style="font-size:0.9rem;color:var(--muted);margin-bottom:4px">ORDER ID</div>
                        <div style="font-weight:600;font-size:1.1rem;color:var(--dark)">#${esc(sid(id))}</div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-size:0.9rem;color:var(--muted);margin-bottom:4px">DATE</div>
                        <div style="font-weight:500;color:var(--dark)">${fdn(o.createdAt)}</div>
                    </div>
                </div>
            </div>

            <!-- Two Column Layout -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                <!-- Left Column: Customer Info -->
                <div>
                    <div style="font-weight:600;color:var(--dark);margin-bottom:12px;font-size:0.95rem">CUSTOMER INFORMATION</div>
                    <div style="background:#fff;border:1px solid var(--border);border-radius:8px;padding:16px;">
                        <div style="margin-bottom:12px">
                            <div style="font-size:0.85rem;color:var(--muted);margin-bottom:4px">Name</div>
                            <div style="font-weight:500;color:var(--dark)">
                                ${esc(o.shippingAddress?.firstName || '')} ${esc(o.shippingAddress?.lastName || '')}
                            </div>
                        </div>
                        <div style="margin-bottom:12px">
                            <div style="font-size:0.85rem;color:var(--muted);margin-bottom:4px">Email</div>
                            <div style="color:var(--dark)">${esc(o.email || "—")}</div>
                        </div>
                        <div>
                            <div style="font-size:0.85rem;color:var(--muted);margin-bottom:4px">Phone</div>
                            <div style="color:var(--dark)">${phone}</div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Shipping Info -->
                <div>
                    <div style="font-weight:600;color:var(--dark);margin-bottom:12px;font-size:0.95rem">SHIPPING ADDRESS</div>
                    <div style="background:#fff;border:1px solid var(--border);border-radius:8px;padding:16px;height:100%">
                        <div style="color:var(--dark);line-height:1.5">${address}</div>
                    </div>
                </div>
            </div>

            <!-- Status Section -->
            <div>
                <div style="font-weight:600;color:var(--dark);margin-bottom:12px;font-size:0.95rem">ORDER STATUS</div>
                <div style="background:#fff;border:1px solid var(--border);border-radius:8px;padding:16px;">
                    <select id="ov-modal-status" style="padding:12px;border:1px solid var(--border);border-radius:8px;width:100%;font-size:0.95rem;background:#fff;color:var(--dark);">
                        <option value="pending">Pending</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="shipped">Shipped</option>
                        <option value="out-for-delivery">Out for Delivery</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                    <div style="margin-top:12px;display:flex;align-items:center;gap:8px;padding:8px;background:var(--light);border-radius:6px;">
                        <i class="fas fa-info-circle" style="color:var(--muted)"></i>
                        <div style="font-size:0.85rem;color:var(--muted)">
                            Updating status will notify the customer
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Items -->
            <div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <div style="font-weight:600;color:var(--dark);font-size:0.95rem">ORDER ITEMS</div>
                    <div style="font-size:0.85rem;color:var(--muted);background:var(--light);padding:4px 8px;border-radius:4px;">
                        ${(o.items || []).length} item${(o.items || []).length !== 1 ? 's' : ''}
                    </div>
                </div>
                <div style="background:#fff;border:1px solid var(--border);border-radius:8px;overflow:hidden;max-height:300px;overflow-y:auto;">
                    ${itemsHTML}
                </div>
            </div>

            <!-- Order Summary -->
            <div>
                <div style="font-weight:600;color:var(--dark);margin-bottom:12px;font-size:0.95rem">ORDER SUMMARY</div>
                <div style="background:#fff;border:1px solid var(--border);border-radius:8px;padding:16px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <div style="color:var(--muted)">Subtotal</div>
                        <div style="font-weight:500">₹${subtotal.toFixed(2)}</div>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <div style="color:var(--muted)">Tax</div>
                        <div style="font-weight:500">₹${tax.toFixed(2)}</div>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <div style="color:var(--muted)">Shipping</div>
                        <div style="font-weight:500">₹${shipping.toFixed(2)}</div>
                    </div>
                    <div style="height:1px;background:var(--border);margin:12px 0;"></div>
                    <div style="display:flex;justify-content:space-between;">
                        <div style="font-weight:600;color:var(--dark)">Total</div>
                        <div style="font-weight:700;color:var(--dark);font-size:1.1rem">₹${total.toFixed(2)}</div>
                    </div>
                </div>
            </div>

            <!-- Payment & Notes Section -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                <div>
                    <div style="font-weight:600;color:var(--dark);margin-bottom:12px;font-size:0.95rem">PAYMENT INFORMATION</div>
                    <div style="background:#fff;border:1px solid var(--border);border-radius:8px;padding:16px;">
                        <div style="margin-bottom:8px">
                            <div style="font-size:0.85rem;color:var(--muted);margin-bottom:4px">Method</div>
                            <div style="font-weight:500;color:var(--dark)">
                                ${o.paymentMethod ? esc(o.paymentMethod) : 'Not specified'}
                            </div>
                        </div>
                        <div>
                            <div style="font-size:0.85rem;color:var(--muted);margin-bottom:4px">Status</div>
                            <div style="display:inline-flex;align-items:center;gap:6px;padding:4px 8px;background:${o.paymentStatus === 'paid' ? 'rgba(16,185,129,0.1)' : 'rgba(245,158,11,0.1)'};color:${o.paymentStatus === 'paid' ? '#10b981' : '#f59e0b'};border-radius:4px;font-size:0.85rem;font-weight:500">
                                ${o.paymentStatus === 'paid' ? '✓ Paid' : 'Pending'}
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <div style="font-weight:600;color:var(--dark);margin-bottom:12px;font-size:0.95rem">CUSTOMER NOTES</div>
                    <div style="background:#fff;border:1px solid var(--border);border-radius:8px;padding:16px;height:100%">
                        <div style="color:var(--muted);font-style:italic">
                            ${o.notes ? esc(o.notes) : 'No notes provided'}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Set current status
    document.getElementById("ov-modal-status").value = o.status || "pending";
    
    // Add click event listeners to product images in the modal
    setTimeout(() => {
        const productImages = document.querySelectorAll('.product-image-modal-item');
        productImages.forEach(img => {
            img.addEventListener('click', function(e) {
                e.stopPropagation();
                const imageSrc = this.getAttribute('data-image') || this.src;
                const imageAlt = this.getAttribute('data-name') || this.alt;
                showProductImage(imageSrc, imageAlt);
            });
        });
    }, 100);

    m.classList.add("show");
}

// Add this function to your existing code
function showProductImage(src, alt) {
    // Create or get the image viewer modal
    let imageViewer = document.getElementById('image-viewer-modal');
    
    if (!imageViewer) {
        imageViewer = document.createElement('div');
        imageViewer.id = 'image-viewer-modal';
        imageViewer.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        `;
        
        const imageContainer = document.createElement('div');
        imageContainer.style.cssText = `
            position: relative;
            max-width: 90%;
            max-height: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        `;
        
        const img = document.createElement('img');
        img.id = 'full-size-image';
        img.style.cssText = `
            max-width: 100%;
            max-height: calc(90vh - 60px);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            object-fit: contain;
        `;
        
        const closeBtn = document.createElement('div');
        closeBtn.innerHTML = '&times;';
        closeBtn.style.cssText = `
            position: absolute;
            top: -40px;
            right: -10px;
            color: white;
            font-size: 2.5rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
        `;
        closeBtn.onclick = hideProductImage;
        
        const caption = document.createElement('div');
        caption.id = 'image-caption';
        caption.style.cssText = `
            color: white;
            text-align: center;
            margin-top: 15px;
            font-size: 1rem;
            max-width: 80%;
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
        `;
        
        imageContainer.appendChild(img);
        imageContainer.appendChild(closeBtn);
        imageContainer.appendChild(caption);
        imageViewer.appendChild(imageContainer);
        
        imageViewer.onclick = function(e) {
            if (e.target === imageViewer) hideProductImage();
        };
        
        document.body.appendChild(imageViewer);
    }
    
    // Set image and caption
    document.getElementById('full-size-image').src = src;
    document.getElementById('full-size-image').alt = alt;
    document.getElementById('image-caption').textContent = alt;
    
    // Show the modal
    imageViewer.style.opacity = '1';
    imageViewer.style.visibility = 'visible';
    document.body.style.overflow = 'hidden';
}

function hideProductImage() {
    const imageViewer = document.getElementById('image-viewer-modal');
    if (imageViewer) {
        imageViewer.style.opacity = '0';
        imageViewer.style.visibility = 'hidden';
        document.body.style.overflow = 'auto';
    }
}

// Add ESC key support for closing image viewer
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hideProductImage();
    }
});

function close() {
    m.classList.remove("show");
    editing = null;
  }
  
  function searchAndUpdateInUsers(orderId, updateData) {
    return db.collection("users").get().then(users => {
      const promises = [];
      let foundInUsers = false;
      
      users.forEach(u => {
        const userOrderRef = db.collection("users").doc(u.id).collection("orders").doc(orderId);
        promises.push(
          userOrderRef.get().then(snap => {
            if (snap.exists) {
              foundInUsers = true;
              return userOrderRef.update(updateData);
            }
            return Promise.resolve();
          })
        );
      });
      
      return Promise.all(promises).then(() => {
        return { updatedInUser: foundInUsers };
      });
    });
  }

  function save() {
    if (!editing) return;

    const st = document.getElementById("ov-modal-status").value;
    ms.disabled = true;

    const ot = ms.innerHTML;
    ms.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

    const rootRef = db.collection("orders").doc(editing);
    const timestamp = firebase.firestore.FieldValue.serverTimestamp();
    const updateData = {
      status: st,
      updatedAt: timestamp
    };

    if (st === 'confirmed') {
      updateData.confirmedAt = timestamp;
    } else if (st === 'shipped') {
      updateData.shippedAt = timestamp;
    } else if (st === 'out-for-delivery' || st === 'out for delivery') {
      updateData.outForDeliveryAt = timestamp;
    } else if (st === 'delivered') {
      updateData.deliveredAt = timestamp;
    }

    rootRef.get().then(doc => {
      if (doc.exists) {
        const orderData = doc.data();
        
        return rootRef.update(updateData).then(() => {
          if (orderData.userId) {
            const userOrderRef = db.collection("users").doc(orderData.userId)
              .collection("orders").doc(editing);
            
            return userOrderRef.update(updateData).then(() => {
              return { updatedInUser: true, userId: orderData.userId };
            }).catch(err => {
              console.log("Couldn't update with userId, trying email...", err);
              return searchAndUpdateInUsers(editing, updateData);
            });
          } else {
            return searchAndUpdateInUsers(editing, updateData);
          }
        });
      } else {
        return searchAndUpdateInUsers(editing, updateData);
      }
    })
    .then((result) => {
      ms.disabled = false;
      ms.innerHTML = ot;
      
      if (result && result.updatedInUser) {
        toast(`Order updated (User: ${result.userId ? '✓' : 'found via email'})`);
      } else {
        toast("Order updated in admin view");
      }
      
      m.classList.remove("show");
    })
    .catch((err) => {
      ms.disabled = false;
      ms.innerHTML = ot;
      console.error("Save error:", err);
      toast("Save failed: " + err.message, "error");
    });
  }

  function apply() {
    let x = [...orders];
    const st = fs.value;
    const d = fd.value;
    const q = si.value.toLowerCase();

    if (st !== "all") {
      x = x.filter(o => (o.status || "").toLowerCase() === st);
    }

    if (d !== "all") {
      const now = Date.now();
      let start = null;

      if (d === "today") {
        const today = new Date();
        today.setHours(0,0,0,0);
        start = today.getTime();
      }

      if (d === "week") start = now - 7 * 864e5;
      if (d === "month") start = now - 30 * 864e5;

      if (start !== null) {
        x = x.filter(o => o._created >= start);
      }
    }

    if (q) {
      x = x.filter(o => 
        o.id.toLowerCase().includes(q) ||
        o._name.toLowerCase().includes(q) ||
        o._email.includes(q)
      );
    }

    filtered = x;
    requestAnimationFrame(() => list(x)); 
  }

  function csv(x) {
    if (!x.length) {
      toast("No orders to export", "info");
      return;
    }

    const rows = [["Order ID", "Customer", "Email", "Date", "Items", "Total", "Status"]];

    x.forEach((o) => {
      const cu =
        (o.shippingAddress?.firstName || "") +
        " " +
        (o.shippingAddress?.lastName || "");

      rows.push([
        `#${sid(o.id)}`,
        cu.trim(),
        o.email || "",
        fdn(o.createdAt),
        (o.items || []).length,
        o.total || 0,
        o.status || "",
      ]);
    });

    const out = rows
      .map((r) => r.map((c) => `"${String(c).replace(/"/g, '""')}"`).join(","))
      .join("\n");

    const B = new Blob([out], { type: "text/csv" }),
      u = URL.createObjectURL(B),
      a = document.createElement("a");

    a.href = u;
    a.download = "orders.csv";
    a.click();

    URL.revokeObjectURL(u);
    toast("Export started");
  }

  document.addEventListener("click", (e) => {
    if (e.target === m) close();
  });

  // Make showProductImage globally available
  window.showProductImage = showProductImage;

  mc.onclick = close;
  mca.onclick = close;
  ms.onclick = save;
  fs.onchange = apply;
  fd.onchange = apply;
  si.oninput = debounce(apply, 300);
  rb.onclick = () => {
    load();
    toast("Refreshing...", "info");
  };
  xb.onclick = () => csv(filtered.length ? filtered : orders);

  load();
})();
</script>
