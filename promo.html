<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Promo Codes</title>
    <style>
        body { 
            font-family: 'Unbounded', Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #f8f3e6;
            color: #333;
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); 
        }
        h1, h2 {
            color: #5f2b27;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group { 
            margin-bottom: 20px; 
        }
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #333;
            font-family: 'Unbounded', sans-serif;
        }
        input, select, textarea { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            font-size: 14px; 
            font-family: 'Quicksand', sans-serif;
            transition: border 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #5f2b27;
            outline: none;
        }
        button { 
            background: #5f2b27; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px; 
            margin-right: 10px; 
            font-family: 'Unbounded', sans-serif;
            transition: all 0.3s;
        }
        button:hover { 
            background: #7a3731; 
            transform: translateY(-2px);
        }
        .promo-list { 
            margin-top: 40px; 
        }
        .promo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .promo-item { 
            border: 1px solid #e0e0e0; 
            padding: 20px; 
            border-radius: 10px; 
            background: #f9f9f9;
            transition: all 0.3s;
        }
        .promo-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .promo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .promo-code {
            background: #5f2b27;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 14px;
        }
        .promo-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        .promo-details {
            margin: 10px 0;
        }
        .promo-details p {
            margin: 5px 0;
            font-size: 14px;
        }
        .promo-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        .btn-warning:hover {
            background: #e0a800;
        }
        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #5f2b27;
        }
        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }
    </style>
    <!-- Include the same fonts as your main site -->
    <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¯ Promo Code Generator</h1>
        
        <!-- Stats Section -->
        <div class="stats" id="statsSection">
            <div class="stat-card">
                <div class="stat-number" id="totalPromos">0</div>
                <div class="stat-label">Total Promo Codes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activePromos">0</div>
                <div class="stat-label">Active Promo Codes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalUses">0</div>
                <div class="stat-label">Total Uses</div>
            </div>
        </div>
        
        <!-- Create New Promo Code Form -->
        <div class="form-section">
            <h2>Create New Promo Code</h2>
            <form id="promoForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label for="code">Promo Code:</label>
                        <input type="text" id="code" required placeholder="e.g., WELCOME10" style="text-transform: uppercase;">
                    </div>
                    
                    <div class="form-group">
                        <label for="discountType">Discount Type:</label>
                        <select id="discountType" required>
                            <option value="percentage">Percentage (%)</option>
                            <option value="fixed">Fixed Amount (â‚¹)</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label for="discountValue">Discount Value:</label>
                        <input type="number" id="discountValue" required min="1" placeholder="10">
                    </div>
                    
                    <div class="form-group">
                        <label for="minOrderAmount">Minimum Order Amount (â‚¹):</label>
                        <input type="number" id="minOrderAmount" value="0" min="0" placeholder="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="description">Description (Shown to customers):</label>
                    <textarea id="description" required rows="3" placeholder="Describe the offer that customers will see..."></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label for="maxUses">Maximum Uses:</label>
                        <input type="number" id="maxUses" value="100" min="1" placeholder="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="validUntil">Valid Until:</label>
                        <input type="datetime-local" id="validUntil" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="isActive">
                        <input type="checkbox" id="isActive" checked> Active (Visible to customers)
                    </label>
                </div>
                
                <button type="submit">âœ¨ Generate Promo Code</button>
                <button type="button" onclick="generateRandomCode()">ðŸŽ² Generate Random Code</button>
            </form>
        </div>
        
        <!-- Active Promo Codes List -->
        <div class="promo-list">
            <h2>Active Promo Codes</h2>
            <div id="loadingMessage">Loading promo codes...</div>
            <div class="promo-grid" id="promoGrid">
                <!-- Promo codes will be loaded here -->
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script>
        // Firebase config (same as your main app)
        const firebaseConfig = {
            apiKey: "AIzaSyDuF6bdqprddsE871GuOablXPYqXI_HJxc",
            authDomain: "hexahoney-96aed.firebaseapp.com",
            projectId: "hexahoney-96aed",
            storageBucket: "hexahoney-96aed.firebasestorage.app",
            messagingSenderId: "700458850837",
            appId: "1:700458850837:web:0eb4fca98a5f4acc2d0c1c",
            measurementId: "G-MQGKK9709H"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Set default validUntil to 30 days from now
        function setDefaultValidUntil() {
            const now = new Date();
            now.setDate(now.getDate() + 30);
            const formatted = now.toISOString().slice(0, 16);
            document.getElementById('validUntil').value = formatted;
        }

        // Generate random promo code
        function generateRandomCode() {
            const prefixes = ['HONEY', 'SWEET', 'NATURA', 'BEE', 'GOLDEN', 'PURE'];
            const suffixes = ['10', '15', '20', '25', '50', 'OFF', 'SAVE'];
            
            const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
            const suffix = suffixes[Math.floor(Math.random() * suffixes.length)];
            const randomNum = Math.floor(Math.random() * 90) + 10;
            
            const randomCode = prefix + suffix + randomNum;
            document.getElementById('code').value = randomCode;
        }

        // Load and display promo codes
        function loadPromoCodes() {
            const loadingMessage = document.getElementById('loadingMessage');
            const promoGrid = document.getElementById('promoGrid');
            
            db.collection('promoCodes')
                .orderBy('createdAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    loadingMessage.style.display = 'none';
                    promoGrid.innerHTML = '';
                    
                    let totalPromos = 0;
                    let activePromos = 0;
                    let totalUses = 0;
                    
                    if (querySnapshot.empty) {
                        promoGrid.innerHTML = `
                            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
                                <p>No promo codes found. Create your first one above!</p>
                            </div>
                        `;
                        updateStats(0, 0, 0);
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const promo = doc.data();
                        totalPromos++;
                        totalUses += (promo.usedCount || 0);
                        
                        if (promo.isActive) {
                            activePromos++;
                        }
                        
                        const promoItem = document.createElement('div');
                        promoItem.className = 'promo-item';
                        promoItem.innerHTML = createPromoCard(doc.id, promo);
                        promoGrid.appendChild(promoItem);
                    });
                    
                    updateStats(totalPromos, activePromos, totalUses);
                    attachEventListeners();
                })
                .catch((error) => {
                    console.error("Error loading promo codes:", error);
                    loadingMessage.innerHTML = `
                        <div style="color: #dc3545; text-align: center;">
                            <p>Error loading promo codes: ${error.message}</p>
                            <button onclick="loadPromoCodes()">Retry</button>
                        </div>
                    `;
                });
        }

        // Create promo card HTML
        function createPromoCard(docId, promo) {
            const now = new Date();
            const validUntil = promo.validUntil.toDate();
            const isValid = validUntil > now && promo.isActive;
            const usagePercent = promo.maxUses ? Math.round((promo.usedCount || 0) / promo.maxUses * 100) : 0;
            
            return `
                <div class="promo-header">
                    <span class="promo-code">${promo.code}</span>
                    <span class="promo-status ${isValid ? 'status-active' : 'status-inactive'}">
                        ${isValid ? 'ACTIVE' : 'INACTIVE'}
                    </span>
                </div>
                <div class="promo-details">
                    <p><strong>${promo.description}</strong></p>
                    <p>Discount: ${promo.discountType === 'percentage' ? promo.discountValue + '%' : 'â‚¹' + promo.discountValue}</p>
                    <p>Min Order: â‚¹${promo.minOrderAmount || 0}</p>
                    <p>Used: ${promo.usedCount || 0}/${promo.maxUses || 'Unlimited'}</p>
                    <p>Valid Until: ${validUntil.toLocaleDateString()}</p>
                    <div style="background: #e9ecef; border-radius: 5px; margin: 10px 0;">
                        <div style="background: #5f2b27; height: 6px; border-radius: 5px; width: ${usagePercent}%;"></div>
                    </div>
                </div>
                <div class="promo-actions">
                    <button class="btn-warning" onclick="togglePromoStatus('${docId}', ${!promo.isActive})">
                        ${promo.isActive ? 'Deactivate' : 'Activate'}
                    </button>
                    <button class="btn-danger" onclick="deletePromoCode('${docId}')">Delete</button>
                </div>
            `;
        }

        // Update statistics
        function updateStats(total, active, uses) {
            document.getElementById('totalPromos').textContent = total;
            document.getElementById('activePromos').textContent = active;
            document.getElementById('totalUses').textContent = uses;
        }

        // Attach event listeners to promo actions
        function attachEventListeners() {
            // Event listeners are attached in the createPromoCard function via onclick
        }

        // Toggle promo code status
        function togglePromoStatus(docId, newStatus) {
            db.collection('promoCodes').doc(docId).update({
                isActive: newStatus
            })
            .then(() => {
                alert(`Promo code ${newStatus ? 'activated' : 'deactivated'} successfully!`);
                loadPromoCodes();
            })
            .catch((error) => {
                console.error("Error updating promo code:", error);
                alert('Error updating promo code: ' + error.message);
            });
        }

        // Delete promo code
        function deletePromoCode(docId) {
            if (confirm('Are you sure you want to delete this promo code? This action cannot be undone.')) {
                db.collection('promoCodes').doc(docId).delete()
                .then(() => {
                    alert('Promo code deleted successfully!');
                    loadPromoCodes();
                })
                .catch((error) => {
                    console.error("Error deleting promo code:", error);
                    alert('Error deleting promo code: ' + error.message);
                });
            }
        }

        // Form submission
        document.getElementById('promoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const promoData = {
                code: document.getElementById('code').value.toUpperCase(),
                description: document.getElementById('description').value,
                discountType: document.getElementById('discountType').value,
                discountValue: parseInt(document.getElementById('discountValue').value),
                minOrderAmount: parseInt(document.getElementById('minOrderAmount').value) || 0,
                maxUses: parseInt(document.getElementById('maxUses').value),
                usedCount: 0,
                isActive: document.getElementById('isActive').checked,
                validFrom: new Date(),
                validUntil: new Date(document.getElementById('validUntil').value),
                createdAt: new Date()
            };

            // Validate dates
            if (promoData.validUntil <= new Date()) {
                alert('Valid Until date must be in the future!');
                return;
            }

            // Check if promo code already exists
            db.collection('promoCodes')
                .where('code', '==', promoData.code)
                .get()
                .then((querySnapshot) => {
                    if (!querySnapshot.empty) {
                        alert('Promo code already exists! Please use a different code.');
                        return;
                    }

                    // Save to Firestore
                    return db.collection('promoCodes').add(promoData);
                })
                .then(() => {
                    alert('Promo code created successfully!');
                    document.getElementById('promoForm').reset();
                    setDefaultValidUntil();
                    loadPromoCodes();
                })
                .catch((error) => {
                    console.error("Error creating promo code:", error);
                    alert('Error creating promo code: ' + error.message);
                });
        });

        // Initialize page
        setDefaultValidUntil();
        loadPromoCodes();

        // Auto-generate description based on inputs
        document.getElementById('discountType').addEventListener('change', updateDescription);
        document.getElementById('discountValue').addEventListener('input', updateDescription);
        document.getElementById('minOrderAmount').addEventListener('input', updateDescription);

        function updateDescription() {
            const type = document.getElementById('discountType').value;
            const value = document.getElementById('discountValue').value;
            const minAmount = document.getElementById('minOrderAmount').value;
            
            if (value) {
                let description = `Get ${type === 'percentage' ? value + '%' : 'â‚¹' + value} off`;
                if (minAmount > 0) {
                    description += ` on orders above â‚¹${minAmount}`;
                } else {
                    description += ` on all orders`;
                }
                document.getElementById('description').value = description;
            }
        }
    </script>
</body>
</html>
