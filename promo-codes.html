<!-- promo-codes.html — dashboard-styled promo UI (component, no <html>/<body>) -->
<div class="promo-view fade-in">
  <style>

    @media (max-width: 1024px) {
  .promo-controls {
    flex-direction: column;
    width: 100%;
  }
  .promo-card.filter-row {
    width: 100%;
    flex-wrap: wrap;
  }
  .promo-search {
    min-width: 100%;
    max-width: 100%;
  }
  .promo-top {
    flex-direction: column;
    align-items: flex-start;
  }
  .promo-card .table-wrapper {
    overflow-x: auto;
  }
}

@media (max-width: 768px) {
  .promo-title {
    font-size: 1.1rem;
  }
  .promo-sub {
    font-size: 0.85rem;
  }
  .promo-controls {
    flex-direction: column;
    width: 100%;
  }
  .promo-card.filter-row {
    flex-direction: column;
    gap: 10px;
    width: 100%;
  }
  .filter-select {
    width: 100%;
  }
  .promo-search {
    width: 100%;
  }
  .promo-modal .modal-body form > div {
    flex-direction: column !important;
    width: 100%;
  }
  #pv-value,
  #pv-max,
  #pv-limit,
  #pv-min,
  #pv-until {
    width: 100% !important;
  }
  #pv-active,
  #pv-popular,
  #pv-checkout {
    transform: scale(1.1);
  }
}

@media (max-width: 480px) {
  .promo-view {
    padding: 14px;
  }
  .promo-title {
    font-size: 1rem;
  }
  .promo-card {
    padding: 12px;
  }
  .promo-table td,
  .promo-table th {
    padding: 8px 10px;
  }
  .promo-modal {
    width: calc(100% - 20px);
    margin: 0 10px;
  }
  .promo-modal .modal-header,
  .promo-modal .modal-footer,
  .promo-modal .modal-body {
    padding: 12px;
  }
  input,
  select,
  textarea {
    font-size: 0.9rem;
  }
  .mobile-cards .promo-card {
    padding: 12px;
  }
}
    /* Scoped styles — reuses dashboard root variables */
    .promo-view { padding: 22px; background: transparent; min-height: 100vh; }

    /* Top row: title + actions */
    .promo-top {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:18px;
    }
    .promo-title {
      font-family:'Outfit',sans-serif;
      font-size:1.2rem;
      font-weight:700;
      color:var(--dark);
    }
    .promo-sub {
      font-size:0.9rem;
      color:var(--gray);
      margin-top:4px;
    }

    /* Controls row */
    .promo-controls {
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }

    .promo-card {
      background:var(--card-bg);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      border:1px solid var(--border);
    }

    .filter-row {
      display:flex;
      gap:12px;
      align-items:center;
    }
    .filter-select, .promo-search {
      padding:10px 14px;
      border-radius:10px;
      border:1px solid var(--border);
      background:transparent;
      font-size:0.95rem;
      min-width:160px;
    }

    .promo-search {
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      min-width:260px;
      max-width:420px;
    }
    .promo-search input {
      border:0;
      outline:none;
      background:transparent;
      width:100%;
      font-size:0.95rem;
    }

    .btn-ghost {
      background:transparent;
      border:1px solid var(--border);
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
    }

    .btn-primary {
      background:var(--dark);
      color:var(--secondary);
      border-radius:10px;
      padding:9px 14px;
      border:none;
      cursor:pointer;
      font-weight:700;
    }

    /* Table styles */
    .promo-table {
      width:100%;
      border-collapse:collapse;
      margin-top:16px;
      min-width:900px;
      font-size:0.95rem;
    }
    .promo-table thead th {
      text-align:left;
      padding:12px 16px;
      font-weight:700;
      color:var(--dark);
      border-bottom:1px solid var(--border);
      background:transparent;
    }
    .promo-table tbody tr {
      border-bottom:1px solid var(--border);
      transition:background .15s;
      background:transparent;
    }
    .promo-table tbody tr:hover { background: rgba(0,0,0,0.02); }
    .promo-table td { padding:12px 16px; vertical-align:middle; color:var(--dark); }

    .tag {
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-weight:600;
      font-size:0.8rem;
      background:rgba(0,0,0,0.03);
    }

    .status-pill {
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-weight:700;
      font-size:0.75rem;
    }
    .status-active { background: rgba(16,185,129,0.12); color: #10b981; border:1px solid rgba(16,185,129,0.18); }
    .status-inactive { background: rgba(239,68,68,0.08); color:#ef4444; border:1px solid rgba(239,68,68,0.12); }
    .status-expired { background: rgba(0,0,0,0.04); color: #666; border:1px solid rgba(0,0,0,0.06); }

    .action-btn {
      border-radius:8px;
      border:0;
      padding:8px;
      cursor:pointer;
      background:transparent;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-size:0.95rem;
    }
    .action-btn .fa-edit { color:var(--dark); }
    .action-btn .fa-play, .action-btn .fa-pause { color:var(--gray); }
    .action-btn .fa-trash { color:#ef4444; }

    /* Mobile cards for small view */
    .mobile-cards { display:none; gap:12px; margin-top:12px; }
    @media (max-width:1023px) {
      .table-wrapper { display:none; }
      .mobile-cards { display:flex; flex-direction:column; }
    }
    @media (min-width:1024px) {
      .table-wrapper { display:block; }
    }

    /* Modal overrides (scoped) */
    .promo-modal-bg {
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(15,23,42,0.6); z-index:1200;
    }
    .promo-modal-bg.show { display:flex; }
    .promo-modal {
      width:100%; max-width:560px; border-radius:var(--radius); overflow:hidden;
      background:var(--card-bg); box-shadow:var(--shadow); border:1px solid var(--border);
    }
    .promo-modal .modal-header {
      padding:14px 16px; display:flex; justify-content:space-between; align-items:center; background:transparent;
      border-bottom:1px solid var(--border);
    }
    .promo-modal .modal-body { padding:16px; }
    .promo-modal .modal-footer { padding:12px 16px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:8px; }

    /* Small helpers */
    .muted { color:var(--gray); font-size:0.9rem; }
    .flex { display:flex; gap:10px; align-items:center; }
    .col { display:flex; flex-direction:column; gap:8px; }
    .min-w-120 { min-width:120px; }
  </style>

  <!-- header / controls -->
  <div class="promo-top">
    <div>
      <div class="promo-title">Promo Codes</div>
      <div class="promo-sub muted">Create, edit and manage discount codes</div>
    </div>

    <div class="promo-controls">
      <div class="promo-card filter-row">
        <select id="pv-status" class="filter-select">
          <option value="all">All status</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <option value="expired">Expired</option>
        </select>

        <select id="pv-type" class="filter-select">
          <option value="all">All types</option>
          <option value="fixed">Fixed</option>
          <option value="percentage">Percentage</option>
          <option value="shipping">Free Shipping</option>
        </select>

        <div class="promo-search">
          <i class="fas fa-search muted"></i>
          <input id="pv-search" placeholder="Search promo codes or description">
        </div>
      </div>

      <button id="pv-add" class="btn-primary"><i class="fas fa-plus" style="margin-right:8px"></i> Create New</button>
    </div>
  </div>

  <!-- table / cards -->
  <div class="promo-card">
    <div class="table-wrapper">
      <table class="promo-table" aria-label="Promo codes table">
        <thead>
          <tr>
            <th>Promo</th>
            <th>Details</th>
            <th>Valid Until</th>
            <th>Status</th>
            <th style="text-align:right">Actions</th>
          </tr>
        </thead>
        <tbody id="pv-tbody">
          <tr>
            <td colspan="5" class="muted">Loading promo codes…</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="mobile-cards" id="pv-cards"></div>
  </div>

  <!-- modal: add/edit -->
  <div class="promo-modal-bg" id="pv-modal-bg" role="dialog" aria-hidden="true">
    <div class="promo-modal" role="document">
      <div class="modal-header">
        <div style="font-weight:700" id="pv-modal-title">Create Promo Code</div>
        <button id="pv-modal-close" class="btn-ghost"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <form id="pv-form">
          <input type="hidden" id="pv-id">

          <div class="col">
            <label class="muted">Promo Code</label>
            <input id="pv-code" required style="padding:10px;border:1px solid var(--border);border-radius:8px;text-transform:uppercase">
          </div>

          <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
            <div class="col" style="flex:1">
              <label class="muted">Type</label>
              <select id="pv-type-select" style="padding:10px;border:1px solid var(--border);border-radius:8px">
                <option value="">Select</option>
                <option value="fixed">Fixed (₹)</option>
                <option value="percentage">Percentage (%)</option>
                <option value="shipping">Free Shipping</option>
              </select>
            </div>

            <div class="col" style="width:140px">
              <label class="muted">Value</label>
              <input id="pv-value" type="number" style="padding:10px;border:1px solid var(--border);border-radius:8px" min="0">
            </div>

            <div class="col" style="width:160px">
              <label class="muted">Max Discount</label>
              <input id="pv-max" type="number" style="padding:10px;border:1px solid var(--border);border-radius:8px" min="0">
            </div>
          </div>

          <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
            <div class="col" style="flex:1">
              <label class="muted">Description</label>
              <input id="pv-desc" style="padding:10px;border:1px solid var(--border);border-radius:8px">
            </div>
            <div class="col" style="width:160px">
              <label class="muted">Min Order (₹)</label>
              <input id="pv-min" type="number" style="padding:10px;border:1px solid var(--border);border-radius:8px" min="0">
            </div>
          </div>

          <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
            <div class="col" style="width:220px">
              <label class="muted">Valid Until</label>
              <input id="pv-until" type="date" style="padding:10px;border:1px solid var(--border);border-radius:8px">
            </div>
            <div class="col" style="width:160px">
              <label class="muted">Usage Limit</label>
              <input id="pv-limit" type="number" style="padding:10px;border:1px solid var(--border);border-radius:8px" min="0">
            </div>

         <div class="col" style="display:flex;align-items:center;gap:8px">
  <input id="pv-active" type="checkbox" checked>
  <label class="muted">Active</label>
</div>

<div class="col" style="display:flex;align-items:center;gap:8px">
  <input id="pv-popular" type="checkbox">
  <label class="muted">Mark as Popular</label>
</div>

<div class="col" style="display:flex;align-items:center;gap:8px">
  <input id="pv-checkout" type="checkbox" checked>
  <label class="muted">Show on Checkout</label>
</div>
          </div>

          <div style="margin-top:12px">
            <label class="muted">Terms</label>
            <textarea id="pv-terms" style="width:100%;min-height:80px;padding:10px;border:1px solid var(--border);border-radius:8px"></textarea>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button id="pv-cancel" class="btn-ghost">Cancel</button>
        <button id="pv-save" class="btn-primary"><i class="fas fa-check" style="margin-right:8px"></i> Save</button>
      </div>
    </div>
  </div>

  <!-- confirm modal -->
  <div class="promo-modal-bg" id="pv-confirm-bg" role="dialog" aria-hidden="true">
    <div class="promo-modal" role="document" style="max-width:420px">
      <div class="modal-header">
        <div style="font-weight:700">Confirm</div>
        <button id="pv-confirm-close" class="btn-ghost"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <div id="pv-confirm-msg">Are you sure?</div>
      </div>
      <div class="modal-footer">
        <button id="pv-confirm-cancel" class="btn-ghost">Cancel</button>
        <button id="pv-confirm-ok" class="btn-primary">Delete</button>
      </div>
    </div>
  </div>

  <!-- script: behavior & firebase (scoped) -->
  <script>
    (function () {
      // Safe firebase init: only initialize if firebase available and not already initialized
      try {
        if (window.firebase && !firebase.apps?.length) {
          const firebaseConfig = {
            apiKey: "AIzaSyDuF6bdqprddsE871GuOablXPYqXI_HJxc",
            authDomain: "hexahoney-96aed.firebaseapp.com",
            projectId: "hexahoney-96aed",
            storageBucket: "hexahoney-96aed.firebasestorage.app",
            messagingSenderId: "700458850837",
            appId: "1:700458850837:web:0eb4fca98a5f4acc2d0c1c",
            measurementId: "G-MQGKK9709H"
          };
          try { firebase.initializeApp(firebaseConfig); } catch(e) { /* already */ }
        }
      } catch (err) {
        console.warn('Firebase not available or init failed:', err);
      }

      // DOM refs
      const tbody = document.getElementById('pv-tbody');
      const cards = document.getElementById('pv-cards');
      const addBtn = document.getElementById('pv-add');
      const modalBg = document.getElementById('pv-modal-bg');
      const modalClose = document.getElementById('pv-modal-close');
      const cancelBtn = document.getElementById('pv-cancel');
      const saveBtn = document.getElementById('pv-save');
      const form = document.getElementById('pv-form');
      const searchInput = document.getElementById('pv-search');
      const statusFilter = document.getElementById('pv-status');
      const typeFilter = document.getElementById('pv-type');
      const confirmBg = document.getElementById('pv-confirm-bg');
      const confirmMsg = document.getElementById('pv-confirm-msg');
      const confirmOk = document.getElementById('pv-confirm-ok');
      const confirmCancel = document.getElementById('pv-confirm-cancel');

      // form fields
      const idField = document.getElementById('pv-id');
      const codeField = document.getElementById('pv-code');
      const typeField = document.getElementById('pv-type-select');
      const valueField = document.getElementById('pv-value');
      const maxField = document.getElementById('pv-max');
      const descField = document.getElementById('pv-desc');
      const minField = document.getElementById('pv-min');
      const untilField = document.getElementById('pv-until');
      const limitField = document.getElementById('pv-limit');
      const termsField = document.getElementById('pv-terms');
      const activeField = document.getElementById('pv-active');

      let promos = []; // cached
      let lastDeleteId = null;

      // wire events
      addBtn.addEventListener('click', () => openModal());
      modalClose.addEventListener('click', closeModal);
      cancelBtn.addEventListener('click', closeModal);
      saveBtn.addEventListener('click', savePromo);
      searchInput.addEventListener('input', applyFilters);
      statusFilter.addEventListener('change', applyFilters);
      typeFilter.addEventListener('change', applyFilters);

      confirmCancel.addEventListener('click', () => { confirmBg.classList.remove('show'); });
      document.getElementById('pv-confirm-close').addEventListener('click', () => { confirmBg.classList.remove('show'); });

      confirmOk.addEventListener('click', () => {
        if (!lastDeleteId) return;
        // delete from firestore if available
        try {
          if (window.firebase && firebase.firestore) {
            firebase.firestore().collection('promoCodes').doc(lastDeleteId).delete()
              .then(() => {
                showToast('Deleted');
                confirmBg.classList.remove('show');
                loadPromos();
              })
              .catch(err => showToast('Delete failed: ' + err.message, true));
          } else {
            // fallback local removal (if running offline for demo)
            promos = promos.filter(p => p.id !== lastDeleteId);
            renderPromos(promos);
            confirmBg.classList.remove('show');
            showToast('Deleted (local)');
          }
        } catch (e) {
          showToast('Delete error', true);
        }
      });

      // load
      loadPromos();

      /* ---------- Data load & render ---------- */
      function loadPromos() {
        tbody.innerHTML = '<tr><td colspan="5" class="muted">Loading promo codes…</td></tr>';
        cards.innerHTML = '';

        try {
          if (window.firebase && firebase.firestore) {
            firebase.firestore().collection('promoCodes').orderBy('createdAt','desc').get()
              .then(qs => {
                promos = [];
                qs.forEach(doc => {
                  promos.push({ id: doc.id, ...doc.data() });
                });
                applyFilters();
              })
              .catch(err => {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="5" class="muted">Error loading promo codes</td></tr>';
              });
            return;
          }
        } catch (e) {
          console.warn('Firestore not available', e);
        }

        // If firebase not usable, show empty state
        promos = [];
        renderPromos(promos);
      }

      function renderPromos(list) {
        // table
        if (!list.length) {
          tbody.innerHTML = '<tr><td colspan="5"><div class="muted">No promo codes. Create one using the button above.</div></td></tr>';
          cards.innerHTML = `
            <div class="promo-card">
              <div class="muted">No promo codes for mobile view</div>
            </div>
          `;
          return;
        }

        tbody.innerHTML = list.map(p => `
          <tr data-id="${p.id}">
            <td>
              <div style="display:flex;flex-direction:column;gap:6px;">
                <div style="font-weight:700">${escapeHtml(p.id)}</div>
                <div class="muted">${getTypeLabel(p.type)}</div>
              </div>
            </td>
            <td>
              <div style="font-weight:600">${escapeHtml(getValueDisplay(p))}</div>
              <div class="muted">${escapeHtml(p.description || '')}</div>
              <div style="display:flex;gap:8px;margin-top:6px">
  ${p.isPopular ? '<span class="tag">Popular</span>' : ''}
  ${p.showOnCheckout ? '<span class="tag">Checkout</span>' : ''}
</div>
            </td>
            <td class="muted">${p.validUntil ? new Date(p.validUntil).toLocaleDateString() : 'No expiry'}</td>
            <td><span class="status-pill ${getStatusClass(p)}">${getStatusText(p)}</span></td>
            <td style="text-align:right">
              <button class="action-btn" data-action="edit" data-id="${p.id}" title="Edit"><i class="fas fa-edit"></i></button>
              <button class="action-btn" data-action="toggle" data-id="${p.id}" title="${p.active ? 'Deactivate' : 'Activate'}"><i class="fas ${p.active ? 'fa-pause' : 'fa-play'}"></i></button>
              <button class="action-btn" data-action="delete" data-id="${p.id}" title="Delete"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `).join('');

        // mobile cards
        cards.innerHTML = list.map(p => `
          <div class="promo-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div style="font-weight:700">${escapeHtml(p.id)}</div>
              <div><span class="status-pill ${getStatusClass(p)}" style="font-size:0.75rem;padding:6px 10px">${getStatusText(p)}</span></div>
            </div>
            <div class="muted" style="margin-bottom:8px">${getTypeLabel(p.type)} • ${getValueDisplay(p)}</div>
            <div style="display:flex;justify-content:space-between;gap:8px">
              <div class="muted">Valid: ${p.validUntil ? new Date(p.validUntil).toLocaleDateString() : 'No expiry'}</div>
              <div style="display:flex;gap:6px">
                <button class="action-btn" data-action="edit" data-id="${p.id}"><i class="fas fa-edit"></i></button>
                <button class="action-btn" data-action="toggle" data-id="${p.id}"><i class="fas ${p.active ? 'fa-pause' : 'fa-play'}"></i></button>
                <button class="action-btn" data-action="delete" data-id="${p.id}"><i class="fas fa-trash"></i></button>
              </div>
            </div>
          </div>
        `).join('');

        // attach delegated listeners
        tbody.querySelectorAll('button').forEach(btn => btn.addEventListener('click', handleAction));
        cards.querySelectorAll('button').forEach(btn => btn.addEventListener('click', handleAction));
      }

      function handleAction(e) {
        const action = e.currentTarget.getAttribute('data-action');
        const id = e.currentTarget.getAttribute('data-id');
        const promo = promos.find(x => x.id === id);
        if (!promo && action !== 'delete') return;
        if (action === 'edit') openModal(promo);
        if (action === 'toggle') {
          const newStatus = !promo.active;
          if (window.firebase && firebase.firestore) {
            firebase.firestore().collection('promoCodes').doc(id).update({ active: newStatus, updatedAt: firebase.firestore.FieldValue.serverTimestamp() })
              .then(() => { showToast('Status updated'); loadPromos(); })
              .catch(err => showToast('Update failed: ' + err.message, true));
          } else {
            promo.active = newStatus;
            renderPromos(promos);
            showToast('Status updated (local)');
          }
        }
        if (action === 'delete') {
          lastDeleteId = id;
          confirmMsg.textContent = `Delete promo "${id}"? This cannot be undone.`;
          confirmBg.classList.add('show');
        }
      }

      function applyFilters() {
        const s = searchInput.value.trim().toLowerCase();
        const st = statusFilter.value;
        const ty = typeFilter.value;

        let filtered = promos.slice();
        if (st !== 'all') {
          if (st === 'active') filtered = filtered.filter(p => p.active && !isExpired(p));
          else if (st === 'inactive') filtered = filtered.filter(p => !p.active);
          else if (st === 'expired') filtered = filtered.filter(p => isExpired(p));
        }
        if (ty !== 'all') filtered = filtered.filter(p => p.type === ty);
        if (s) filtered = filtered.filter(p => (p.id || '').toLowerCase().includes(s) || (p.description||'').toLowerCase().includes(s));
        renderPromos(filtered);
      }

      /* ---------- Modal handling ---------- */
      function openModal(promo) {
        if (promo) {
          document.getElementById('pv-modal-title').textContent = 'Edit Promo Code';
          idField.value = promo.id;
          codeField.value = promo.id;
          typeField.value = promo.type || '';
          valueField.value = promo.value ?? '';
          maxField.value = promo.maxDiscount ?? '';
          descField.value = promo.description || '';
          minField.value = promo.minOrder ?? '';
          untilField.value = promo.validUntil ? new Date(promo.validUntil).toISOString().substr(0,10) : '';
          limitField.value = promo.usageLimit ?? '';
          termsField.value = promo.terms || '';
          activeField.checked = promo.active !== false;
          document.getElementById('pv-popular').checked = promo.isPopular === true;
document.getElementById('pv-checkout').checked = promo.showOnCheckout !== false;
        } else {
          document.getElementById('pv-modal-title').textContent = 'Create Promo Code';
          form.reset();
          idField.value = '';
          activeField.checked = true;
          document.getElementById('pv-popular').checked = false;
document.getElementById('pv-checkout').checked = true;
        }
        modalBg.classList.add('show');
      }
      function closeModal() { modalBg.classList.remove('show'); }

      function savePromo(ev) {
        ev.preventDefault();
        const code = (codeField.value || '').trim().toUpperCase();
        if (!code) { showToast('Enter promo code', true); return; }
       const data = {
  type: typeField.value || 'fixed',
  value: typeField.value === 'shipping' ? 0 : parseFloat(valueField.value || 0),
  maxDiscount: maxField.value ? parseFloat(maxField.value) : null,
  minOrder: minField.value ? parseFloat(minField.value) : 0,
  description: descField.value || '',
  terms: termsField.value || '',
  validUntil: untilField.value || null,
  usageLimit: limitField.value ? parseInt(limitField.value) : 0,
  active: !!activeField.checked,
  isPopular: document.getElementById('pv-popular').checked,
  showOnCheckout: document.getElementById('pv-checkout').checked,
  updatedAt: (window.firebase && firebase.firestore) ? firebase.firestore.FieldValue.serverTimestamp() : null
};


        // create or update
        try {
          if (window.firebase && firebase.firestore) {
            const docRef = idField.value ? firebase.firestore().collection('promoCodes').doc(idField.value) : firebase.firestore().collection('promoCodes').doc(code);
            const op = idField.value ? docRef.update(data) : docRef.set({ ...data, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            op.then(() => {
              saveBtn.disabled = false; saveBtn.innerHTML = '<i class="fas fa-check"></i> Save';
              showToast('Saved');
              closeModal();
              loadPromos();
            }).catch(err => {
              saveBtn.disabled = false; saveBtn.innerHTML = '<i class="fas fa-check"></i> Save';
              showToast('Save failed: ' + err.message, true);
            });
            return;
          }
        } catch (e) { console.warn('Firestore not available', e); }

        // fallback: store locally
        if (idField.value) { // update local
          const idx = promos.findIndex(x => x.id === idField.value);
          if (idx !== -1) promos[idx] = { id: idField.value, ...data };
        } else {
          promos.unshift({ id: code, ...data });
        }
        renderPromos(promos);
        closeModal();
        showToast('Saved (local)');
      }

      /* ---------- Helpers ---------- */
      function getTypeLabel(t) {
        if (!t) return '';
        return t === 'fixed' ? 'Fixed Discount' : (t === 'percentage' ? 'Percentage Off' : 'Free Shipping');
      }
      function getValueDisplay(p) {
        if (!p) return '';
        if (p.type === 'fixed') return `₹${p.value ?? 0}`;
        if (p.type === 'percentage') return `${p.value ?? 0}%${p.maxDiscount ? ' (max ₹' + p.maxDiscount + ')' : ''}`;
        if (p.type === 'shipping') return 'Free Shipping';
        return '';
      }
      function isExpired(p) {
        if (!p || !p.validUntil) return false;
        return new Date(p.validUntil).setHours(0,0,0,0) < new Date().setHours(0,0,0,0);
      }
      function getStatusClass(p) {
        if (!p.active) return 'status-inactive';
        if (isExpired(p)) return 'status-expired';
        return 'status-active';
      }
      function getStatusText(p) {
        if (!p.active) return 'Inactive';
        if (isExpired(p)) return 'Expired';
        return 'Active';
      }
      function escapeHtml(s) { return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

      function showToast(msg, isError) {
        // light toast using existing dashboard layout: temporary simple alert
        const t = document.createElement('div');
        t.style.position = 'fixed';
        t.style.bottom = '22px';
        t.style.right = '22px';
        t.style.padding = '12px 16px';
        t.style.background = isError ? '#ffe8e8' : 'var(--card-bg)';
        t.style.border = '1px solid var(--border)';
        t.style.boxShadow = 'var(--shadow)';
        t.style.borderLeft = isError ? '4px solid #ef4444' : '4px solid #10b981';
        t.style.zIndex = 1400;
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(()=> t.remove(), 3000);
      }

    })();
  </script>
</div>
