<div class="promo-view fade-in">
  <style>
    .promo-view { 
      padding: 22px; 
      background: transparent; 
      min-height: 100vh; 
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
    }

    .promo-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 18px;
      flex-wrap: wrap;
      width: 100%;
    }

    .promo-title {
      font-family: 'Outfit', sans-serif;
      font-size: clamp(1.2rem, 2.5vw, 1.4rem);
      font-weight: 700;
      color: var(--dark);
      line-height: 1.2;
    }

    .promo-sub { 
      font-size: clamp(0.85rem, 2vw, 0.9rem); 
      color: var(--gray); 
      margin-top: 4px; 
      line-height: 1.3;
    }

    .promo-controls { 
      display: flex; 
      gap: 12px; 
      align-items: center; 
      flex-wrap: wrap;
      width: 100%;
    }

    .promo-card {
      background: #ffffff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: clamp(14px, 2vw, 16px);
      border: 1px solid var(--border);
      width: 100%;
      box-sizing: border-box;
    }

    .filter-row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      width: 100%;
    }

    .filter-select,
    .promo-search {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #ffffff;
      font-size: 0.95rem;
      min-width: 140px;
      flex: 1;
      max-width: 100%;
      box-sizing: border-box;
    }

    .promo-search {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      min-width: 200px;
      flex: 2;
    }

    .promo-search input {
      border: 0;
      outline: none;
      background: transparent;
      width: 100%;
      font-size: 0.95rem;
      min-width: 0;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--dark);
      color: var(--secondary);
      border-radius: 10px;
      padding: 9px 14px;
      border: none;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .btn-primary:disabled {
      background: var(--gray);
      cursor: not-allowed;
      opacity: 0.6;
    }

    .promo-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      min-width: 600px;
      font-size: 0.95rem;
      table-layout: fixed;
    }

    .promo-table thead th {
      text-align: left;
      padding: 12px 16px;
      font-weight: 700;
      color: var(--dark);
      border-bottom: 1px solid var(--border);
      background: #ffffff;
      position: sticky;
      top: 0;
    }

    .promo-table tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
      background: #ffffff;
    }

    .promo-table tbody tr:hover { background: rgba(0, 0, 0, 0.02); }

    .promo-table td {
      padding: 12px 16px;
      vertical-align: middle;
      color: var(--dark);
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .tag {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.8rem;
      background: rgba(0, 0, 0, 0.03);
      margin: 2px;
    }

    .status-pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.75rem;
      white-space: nowrap;
    }

    .status-active {
      background: rgba(16, 185, 129, 0.12);
      color: #10b981;
      border: 1px solid rgba(16, 185, 129, 0.18);
    }

    .status-inactive {
      background: rgba(239, 68, 68, 0.08);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.12);
    }

    .status-expired {
      background: rgba(0, 0, 0, 0.04);
      color: #666;
      border: 1px solid rgba(0, 0, 0, 0.06);
    }

    .action-btn {
      border-radius: 8px;
      border: 0;
      padding: 8px;
      cursor: pointer;
      background: transparent;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 0.95rem;
      margin: 2px;
    }

    .action-btn .fa-edit { color: var(--dark); }
    .action-btn .fa-play,
    .action-btn .fa-pause { color: var(--gray); }
    .action-btn .fa-trash { color: #ef4444; }

    .mobile-cards { 
      display: none; 
      gap: 12px; 
      margin-top: 12px; 
      width: 100%;
    }

    .mobile-promo-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
      width: 100%;
    }

    .mobile-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .mobile-card-title {
      font-weight: 700;
      font-size: 1rem;
      color: var(--dark);
    }

    .mobile-card-details {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }

    .mobile-card-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
    }

    .mobile-card-label {
      color: var(--gray);
      font-weight: 500;
    }

    .mobile-card-value {
      color: var(--dark);
      font-weight: 600;
      text-align: right;
      max-width: 60%;
      word-break: break-word;
    }

    .mobile-card-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .promo-modal-bg {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.6);
      z-index: 1200;
      padding: 20px;
    }

    .promo-modal-bg.show { display: flex; }

    .promo-modal {
      width: 100%;
      max-width: 560px;
      border-radius: var(--radius);
      overflow: hidden;
      background: #ffffff;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      max-height: 90vh;
      overflow-y: auto;
    }

    .promo-modal .modal-header {
      padding: 14px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #ffffff;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .promo-modal .modal-body {
      padding: 16px;
      background: #ffffff;
    }

    .promo-modal .modal-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      background: #ffffff;
      position: sticky;
      bottom: 0;
    }

    .muted { color: var(--gray); font-size: 0.9rem; }

    .col { display: flex; flex-direction: column; gap: 8px; }

    .field-input,
    .field-select,
    .field-textarea {
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #ffffff;
      font: inherit;
      width: 100%;
      box-sizing: border-box;
    }

    .field-textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
      width: 100%;
    }

    .form-col {
      flex: 1;
      min-width: 0;
    }

    .checkbox-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      margin-top: 10px;
      width: 100%;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 140px;
    }

    .checkbox-item label { 
      cursor: pointer; 
      white-space: nowrap;
    }

    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 8px;
      margin-top: 12px;
    }

    /* Responsive Styles */
    @media (max-width: 1200px) {
      .promo-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filter-row {
        width: 100%;
      }
      
      .btn-primary {
        align-self: flex-end;
      }
    }

    @media (max-width: 992px) {
      .promo-view {
        padding: 16px;
      }
      
      .promo-top {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
      
      .promo-controls {
        width: 100%;
      }
      
      .filter-row {
        flex-direction: column;
        gap: 10px;
      }
      
      .filter-select,
      .promo-search {
        min-width: 100%;
        width: 100%;
      }
      
      .btn-primary {
        width: 100%;
        text-align: center;
      }
    }

    @media (max-width: 768px) {
      .table-wrapper { 
        display: none; 
      }
      
      .mobile-cards { 
        display: flex; 
        flex-direction: column; 
      }
      
      .promo-modal {
        max-width: calc(100% - 40px);
        margin: 0 20px;
      }
      
      .form-row {
        flex-direction: column;
        gap: 12px;
      }
      
      .form-col {
        width: 100%;
      }
      
      .checkbox-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .checkbox-item {
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      .promo-view {
        padding: 12px;
      }
      
      .promo-card {
        padding: 12px;
      }
      
      .promo-modal {
        max-width: calc(100% - 20px);
        margin: 0 10px;
      }
      
      .promo-modal .modal-header,
      .promo-modal .modal-footer,
      .promo-modal .modal-body {
        padding: 12px;
      }
      
      .btn-ghost,
      .btn-primary {
        padding: 10px;
        font-size: 0.85rem;
      }
      
      .mobile-card-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .mobile-card-actions {
        justify-content: center;
      }
    }

    @media (min-width: 769px) {
      .mobile-cards {
        display: none !important;
      }
      
      .table-wrapper {
        display: block;
      }
    }
  </style>

  <div class="promo-top">
    <div style="flex: 1; min-width: 0;">
      <div class="promo-title">Promo Codes</div>
      <div class="promo-sub muted">Create, edit and manage discount codes</div>
    </div>

    <div class="promo-controls">
      <div class="promo-card filter-row">
        <select id="pv-status" class="filter-select">
          <option value="all">All status</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <option value="expired">Expired</option>
        </select>

        <select id="pv-type" class="filter-select">
          <option value="all">All types</option>
          <option value="fixed">Fixed</option>
          <option value="percentage">Percentage</option>
          <option value="shipping">Free Shipping</option>
        </select>

        <div class="promo-search">
          <i class="fas fa-search muted"></i>
          <input id="pv-search" placeholder="Search promo codes or description">
        </div>
      </div>

      <button id="pv-add" class="btn-primary">
        <i class="fas fa-plus" style="margin-right:8px"></i> Create New
      </button>
    </div>
  </div>

  <div class="promo-card">
    <div class="table-wrapper">
      <table class="promo-table">
        <thead>
          <tr>
            <th style="width: 20%">Promo</th>
            <th style="width: 30%">Details</th>
            <th style="width: 20%">Valid Until</th>
            <th style="width: 15%">Status</th>
            <th style="width: 15%; text-align:right">Actions</th>
          </tr>
        </thead>
        <tbody id="pv-tbody">
          <tr><td colspan="5" class="muted" style="text-align:center;padding:40px;">Loading promo codes…</td></tr>
        </tbody>
      </table>
    </div>

    <div class="mobile-cards" id="pv-cards"></div>
  </div>

  <div class="promo-modal-bg" id="pv-modal-bg">
    <div class="promo-modal">
      <div class="modal-header">
        <div id="pv-modal-title" style="font-weight:700">Create Promo Code</div>
        <button id="pv-modal-close" class="btn-ghost" style="padding:6px;"><i class="fas fa-times"></i></button>
      </div>

      <div class="modal-body">
        <form id="pv-form">
          <input type="hidden" id="pv-id">

          <div class="col">
            <label class="muted">Promo Code *</label>
            <input id="pv-code" required class="field-input" style="text-transform:uppercase" placeholder="ENTERCODE">
          </div>

          <div class="form-row">
            <div class="form-col">
              <label class="muted">Type *</label>
              <select id="pv-type-select" class="field-select" required>
                <option value="">Select Type</option>
                <option value="fixed">Fixed (₹)</option>
                <option value="percentage">Percentage (%)</option>
                <option value="shipping">Free Shipping</option>
              </select>
            </div>

            <div class="form-col">
              <label class="muted">Value *</label>
              <input id="pv-value" type="number" class="field-input" min="0" placeholder="0" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-col">
              <label class="muted">Description</label>
              <input id="pv-desc" class="field-input" placeholder="Enter description">
            </div>

            <div class="form-col">
              <label class="muted">Min Order (₹)</label>
              <input id="pv-min" type="number" class="field-input" min="0" placeholder="0">
            </div>
          </div>

          <div class="form-row">
            <div class="form-col">
              <label class="muted">Valid Until</label>
              <input id="pv-until" type="date" class="field-input">
            </div>

            <div class="form-col">
              <label class="muted">Usage Limit</label>
              <input id="pv-limit" type="number" class="field-input" min="0" placeholder="Unlimited">
            </div>
          </div>

          <div class="checkbox-row">
            <div class="checkbox-item">
              <input id="pv-popular" type="checkbox">
              <label class="muted" for="pv-popular">Mark as Popular</label>
            </div>

            <div class="checkbox-item">
              <input id="pv-checkout" type="checkbox" checked>
              <label class="muted" for="pv-checkout">Show on Checkout</label>
            </div>

            <div class="checkbox-item">
              <input id="pv-active" type="checkbox" checked>
              <label class="muted" for="pv-active">Active</label>
            </div>
          </div>

          <div style="margin-top:12px">
            <label class="muted">Terms & Conditions</label>
            <textarea id="pv-terms" class="field-textarea" placeholder="Enter terms and conditions (optional)"></textarea>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button id="pv-cancel" class="btn-ghost">Cancel</button>
        <button id="pv-save" class="btn-primary">
          <i class="fas fa-check" style="margin-right:8px"></i> Save
        </button>
      </div>
    </div>
  </div>

  <div class="promo-modal-bg" id="pv-confirm-bg">
    <div class="promo-modal" style="max-width:420px">
      <div class="modal-header">
        <div style="font-weight:700">Confirm</div>
        <button id="pv-confirm-close" class="btn-ghost" style="padding:6px;"><i class="fas fa-times"></i></button>
      </div>

      <div class="modal-body">
        <div id="pv-confirm-msg">Are you sure?</div>
      </div>

      <div class="modal-footer">
        <button id="pv-confirm-cancel" class="btn-ghost">Cancel</button>
        <button id="pv-confirm-ok" class="btn-primary">Delete</button>
      </div>
    </div>
  </div>
  
  <script src="activityLogger.js?v=1"></script>

<script>
    (function(){
        let promoListener = null;

        function cleanupPromos() {
            if (promoListener) {
                promoListener();
                promoListener = null;
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        const logActivityFn =
            (typeof logActivity === "function")
                ? logActivity
                : (typeof window !== "undefined" && typeof window.logActivity === "function"
                    ? window.logActivity
                    : null);

        function getDb() {
            if (window.db && typeof window.db.collection === "function") return window.db;
            if (typeof firebase !== "undefined" && firebase.firestore) return firebase.firestore();
            return null;
        }

        const tbody = document.getElementById('pv-tbody');
        const cards = document.getElementById('pv-cards');
        const addBtn = document.getElementById('pv-add');
        const modalBg = document.getElementById('pv-modal-bg');
        const modalClose = document.getElementById('pv-modal-close');
        const cancelBtn = document.getElementById('pv-cancel');
        const saveBtn = document.getElementById('pv-save');
        const form = document.getElementById('pv-form');
        const searchInput = document.getElementById('pv-search');
        const statusFilter = document.getElementById('pv-status');
        const typeFilter = document.getElementById('pv-type');
        const confirmBg = document.getElementById('pv-confirm-bg');
        const confirmMsg = document.getElementById('pv-confirm-msg');
        const confirmOk = document.getElementById('pv-confirm-ok');
        const confirmCancel = document.getElementById('pv-confirm-cancel');

        const idField = document.getElementById('pv-id');
        const codeField = document.getElementById('pv-code');
        const typeField = document.getElementById('pv-type-select');
        const valueField = document.getElementById('pv-value');
        const descField = document.getElementById('pv-desc');
        const minField = document.getElementById('pv-min');
        const untilField = document.getElementById('pv-until');
        const limitField = document.getElementById('pv-limit');
        const termsField = document.getElementById('pv-terms');
        const activeField = document.getElementById('pv-active');
        const popularField = document.getElementById('pv-popular');
        const checkoutField = document.getElementById('pv-checkout');

        let promos = [];
        let lastDeleteId = null;

        if (addBtn) addBtn.addEventListener('click', () => openModal());
        if (modalClose) modalClose.addEventListener('click', closeModal);
        if (cancelBtn) cancelBtn.addEventListener('click', closeModal);

        if (saveBtn) {
            saveBtn.addEventListener('click', savePromo);
        }

        if (confirmCancel) confirmCancel.addEventListener('click', () => confirmBg.classList.remove('show'));
        const confirmClose = document.getElementById('pv-confirm-close');
        if (confirmClose) confirmClose.addEventListener('click', () => confirmBg.classList.remove('show'));

        if (confirmOk) {
            confirmOk.addEventListener('click', () => {
                if (lastDeleteId) deletePromo(lastDeleteId);
            });
        }

        if (searchInput) searchInput.addEventListener('input', debounce(applyFilters, 300));
        if (statusFilter) statusFilter.addEventListener('change', applyFilters);
        if (typeFilter) typeFilter.addEventListener('change', applyFilters);

        if (tbody) {
            tbody.addEventListener('click', e => {
                const btn = e.target.closest('button[data-action]');
                if (btn) handleAction(btn);
            });
        }

        if (cards) {
            cards.addEventListener('click', e => {
                const btn = e.target.closest('button[data-action]');
                if (btn) handleAction(btn);
            });
        }

        function loadPromos() {
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="5" class="muted" style="text-align:center;padding:40px;">Loading promo codes…</td></tr>';
            if (cards) cards.innerHTML = '';

            const db = getDb();
            if (!db) { 
                showError('Database unavailable'); 
                return; 
            }

            cleanupPromos();

            promoListener = db.collection('promoCodes')
                .orderBy('createdAt','desc')
                .limit(100)
                .onSnapshot(qs => {
                    promos = [];
                    qs.forEach(doc => {
                        const data = doc.data() || {};
                        promos.push({ id: doc.id, ...data });
                    });
                    applyFilters();
                }, err => {
                    console.error('Promo codes load error:', err);
                    showError(err?.message || 'Error loading promo codes');
                    tbody.innerHTML = '<tr><td colspan="5" class="muted" style="text-align:center;padding:40px;">Error loading promo codes</td></tr>';
                    if (cards) cards.innerHTML = '<div class="mobile-promo-card"><div class="muted" style="text-align:center;padding:20px;">Error loading promo codes</div></div>';
                });
        }

        function renderPromos(list) {
            if (!list || !list.length) {
                tbody.innerHTML = '<tr><td colspan="5" class="muted" style="text-align:center;padding:40px;">No promo codes found.</td></tr>';
                if (cards) {
                    cards.innerHTML = '<div class="mobile-promo-card"><div class="muted" style="text-align:center;padding:20px;">No promo codes available</div></div>';
                }
                return;
            }

            tbody.innerHTML = list.map(p => {
                const code = p.code || p.id || '';
                return `
                    <tr data-id="${escapeHtml(p.id)}">
                        <td>
                            <div style="display:flex;flex-direction:column;gap:6px;">
                                <div style="font-weight:700;word-break:break-word;">${escapeHtml(code)}</div>
                                <div class="muted">${escapeHtml(getTypeLabel(p.type))}</div>
                            </div>
                        </td>
                        <td>
                            <div style="font-weight:600;word-break:break-word;">${escapeHtml(getValueDisplay(p))}</div>
                            <div class="muted" style="word-break:break-word;">${escapeHtml(p.description || '')}</div>
                            <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap">
                                ${p.isPopular ? '<span class="tag">Popular</span>' : ''}
                                ${p.showOnCheckout ? '<span class="tag">Checkout</span>' : ''}
                                ${p.minOrder ? `<span class="tag">Min: ₹${p.minOrder}</span>` : ''}
                            </div>
                        </td>
                        <td class="muted">${p.validUntil ? new Date(p.validUntil).toLocaleDateString() : 'No expiry'}</td>
                        <td><span class="status-pill ${getStatusClass(p)}">${getStatusText(p)}</span></td>
                        <td style="text-align:right">
                            <button class="action-btn" data-action="edit" data-id="${escapeHtml(p.id)}" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="action-btn" data-action="toggle" data-id="${escapeHtml(p.id)}" title="${p.active ? 'Deactivate' : 'Activate'}"><i class="fas ${p.active ? 'fa-pause' : 'fa-play'}"></i></button>
                            <button class="action-btn" data-action="delete" data-id="${escapeHtml(p.id)}" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');

            if (cards) {
                cards.innerHTML = list.map(p => {
                    const code = p.code || p.id || '';
                    return `
                        <div class="mobile-promo-card" data-id="${escapeHtml(p.id)}">
                            <div class="mobile-card-header">
                                <div class="mobile-card-title">${escapeHtml(code)}</div>
                                <div><span class="status-pill ${getStatusClass(p)}">${getStatusText(p)}</span></div>
                            </div>
                            <div class="mobile-card-details">
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">Type:</span>
                                    <span class="mobile-card-value">${getTypeLabel(p.type)}</span>
                                </div>
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">Value:</span>
                                    <span class="mobile-card-value">${getValueDisplay(p)}</span>
                                </div>
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">Description:</span>
                                    <span class="mobile-card-value">${escapeHtml(p.description || 'N/A')}</span>
                                </div>
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">Valid Until:</span>
                                    <span class="mobile-card-value">${p.validUntil ? new Date(p.validUntil).toLocaleDateString() : 'No expiry'}</span>
                                </div>
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">Min Order:</span>
                                    <span class="mobile-card-value">${p.minOrder ? `₹${p.minOrder}` : 'None'}</span>
                                </div>
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">Usage Limit:</span>
                                    <span class="mobile-card-value">${p.usageLimit ? p.usageLimit : 'Unlimited'}</span>
                                </div>
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">Tags:</span>
                                    <span class="mobile-card-value">
                                        ${p.isPopular ? '<span class="tag">Popular</span>' : ''}
                                        ${p.showOnCheckout ? '<span class="tag">Checkout</span>' : ''}
                                    </span>
                                </div>
                            </div>
                            <div class="mobile-card-actions">
                                <button class="action-btn" data-action="edit" data-id="${escapeHtml(p.id)}" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="action-btn" data-action="toggle" data-id="${escapeHtml(p.id)}" title="${p.active ? 'Deactivate' : 'Activate'}"><i class="fas ${p.active ? 'fa-pause' : 'fa-play'}"></i></button>
                                <button class="action-btn" data-action="delete" data-id="${escapeHtml(p.id)}" title="Delete"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function handleAction(btn) {
            const action = btn.getAttribute('data-action');
            const id = btn.getAttribute('data-id');
            if (!action || !id) return;

            if (action === 'edit') {
                const promo = promos.find(x => x.id === id);
                if (promo) openModal(promo);
                return;
            }

            if (action === 'toggle') {
                togglePromoStatus(id);
                return;
            }

            if (action === 'delete') {
                confirmDelete(id);
                return;
            }
        }

        function togglePromoStatus(id) {
            const db = getDb();
            if (!db) { showError('Database unavailable'); return; }

            const ref = db.collection('promoCodes').doc(id);
            ref.get()
                .then(doc => {
                    if (!doc.exists) throw new Error('Promo not found');
                    const current = doc.data() || {};
                    const newState = !current.active;
                    return ref.update({
                        active: newState,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }).then(() => {
                        if (logActivityFn) {
                            logActivityFn(
                                newState ? "PROMO_ACTIVATED" : "PROMO_DEACTIVATED",
                                newState ? `Promo activated: ${id}` : `Promo deactivated: ${id}`,
                                id
                            );
                        }
                        loadPromos();
                    });
                })
                .catch(err => showError(err && err.message ? err.message : 'Error updating promo'));
        }

        function confirmDelete(id) {
            const promo = promos.find(p => p.id === id);
            lastDeleteId = id;
            confirmMsg.textContent = `Delete promo code "${promo?.code || id}"? This action cannot be undone.`;
            confirmBg.classList.add('show');
        }

        function deletePromo(id) {
            const db = getDb();
            if (!db) { showError('Database unavailable'); return; }

            db.collection('promoCodes').doc(id).delete()
                .then(() => {
                    if (logActivityFn) {
                        logActivityFn("PROMO_DELETED", `Promo deleted: ${id}`, id);
                    }
                    confirmBg.classList.remove('show');
                    loadPromos();
                })
                .catch(err => {
                    showError(err && err.message ? err.message : 'Error deleting promo');
                    confirmBg.classList.remove('show');
                });
        }

        function applyFilters() {
            const s = (searchInput && searchInput.value.trim().toLowerCase()) || '';
            const st = (statusFilter && statusFilter.value) || 'all';
            const ty = (typeFilter && typeFilter.value) || 'all';

            let filtered = promos.slice();

            if (st !== 'all') {
                if (st === 'active') filtered = filtered.filter(p => p.active && !isExpired(p));
                else if (st === 'inactive') filtered = filtered.filter(p => !p.active);
                else if (st === 'expired') filtered = filtered.filter(p => isExpired(p));
            }

            if (ty !== 'all') filtered = filtered.filter(p => p.type === ty);

            if (s) {
                filtered = filtered.filter(p => {
                    const code = (p.code || p.id || '').toLowerCase();
                    const desc = (p.description || '').toLowerCase();
                    return code.includes(s) || desc.includes(s);
                });
            }

            renderPromos(filtered);
        }

        function openModal(promo) {
            if (promo) {
                document.getElementById('pv-modal-title').textContent = 'Edit Promo Code';
                idField.value = promo.id;
                codeField.value = promo.code || promo.id || '';
                typeField.value = promo.type || '';
                valueField.value = promo.value ?? '';
                descField.value = promo.description || '';
                minField.value = promo.minOrder ?? '';
                untilField.value = promo.validUntil
                    ? new Date(promo.validUntil).toISOString().substr(0, 10)
                    : '';
                limitField.value = promo.usageLimit ?? '';
                termsField.value = promo.terms || '';
                activeField.checked = promo.active !== false;
                popularField.checked = promo.isPopular === true;
                checkoutField.checked = promo.showOnCheckout !== false;
            } else {
                document.getElementById('pv-modal-title').textContent = 'Create Promo Code';
                form.reset();
                idField.value = '';
                typeField.value = '';
                activeField.checked = true;
                popularField.checked = false;
                checkoutField.checked = true;
                untilField.value = '';
            }
            modalBg.classList.add('show');
        }

        function closeModal() {
            modalBg.classList.remove('show');
        }

        function savePromo(e) {
            if (e && e.preventDefault) e.preventDefault();

            const code = (codeField.value || '').trim().toUpperCase();
            if (!code) {
                showError('Promo code is required');
                return;
            }

            const selectedType = typeField.value || 'fixed';
            if (!selectedType) {
                showError('Please select a promo type');
                return;
            }

            const value = parseFloat(valueField.value || 0);
            if (value <= 0) {
                showError('Please enter a valid value');
                return;
            }

            const data = {
                code: code,
                type: selectedType,
                value: selectedType === 'shipping' ? 0 : value,
                minOrder: minField.value ? parseFloat(minField.value) : 0,
                description: descField.value || '',
                terms: termsField.value || '',
                validUntil: untilField.value || null,
                usageLimit: limitField.value ? parseInt(limitField.value, 10) : 0,
                active: activeField.checked,
                isPopular: popularField.checked,
                showOnCheckout: checkoutField.checked,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            const db = getDb();
            if (!db) {
                showError('Database unavailable');
                return;
            }

            const isEdit = !!idField.value;
            const docRef = isEdit
                ? db.collection('promoCodes').doc(idField.value)
                : db.collection('promoCodes').doc(code);

            const op = isEdit
                ? docRef.update(data)
                : docRef.set({
                    ...data,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right:8px"></i> Saving...';

            op.then(() => {
                const promoId = code;
                if (logActivityFn) {
                    logActivityFn(
                        isEdit ? "PROMO_UPDATED" : "PROMO_CREATED",
                        isEdit ? `Promo updated: ${promoId}` : `New promo created: ${promoId}`,
                        promoId
                    );
                }

                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-check" style="margin-right:8px"></i> Save';
                closeModal();
                loadPromos();
            }).catch(err => {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-check" style="margin-right:8px"></i> Save';
                showError(err && err.message ? err.message : 'Error saving promo');
            });
        }

        function getTypeLabel(t) {
            if (!t) return '';
            if (t === 'fixed') return 'Fixed Discount';
            if (t === 'percentage') return 'Percentage Off';
            if (t === 'shipping') return 'Free Shipping';
            return t;
        }

        function getValueDisplay(p) {
            if (p.type === 'fixed') return `₹${p.value ?? 0} off`;
            if (p.type === 'percentage') return `${p.value ?? 0}% off`;
            if (p.type === 'shipping') return 'Free Shipping';
            return '';
        }

        function isExpired(p) {
            if (!p.validUntil) return false;
            return new Date(p.validUntil).setHours(0, 0, 0, 0) <
                   new Date().setHours(0, 0, 0, 0);
        }

        function getStatusClass(p) {
            if (!p.active) return 'status-inactive';
            if (isExpired(p)) return 'status-expired';
            return 'status-active';
        }

        function getStatusText(p) {
            if (!p.active) return 'Inactive';
            if (isExpired(p)) return 'Expired';
            return 'Active';
        }

        function escapeHtml(s) {
            return String(s || '').replace(/[&<>"']/g, c => ({
                '&':'&amp;',
                '<':'&lt;',
                '>':'&gt;',
                '"':'&quot;',
                "'":'&#39;'
            }[c]));
        }

        function showError(msg) {
            const errorHtml = `
                <tr><td colspan="5">
                    <div style="text-align:center;padding:40px;color:#ef4444">
                        <i class="fas fa-exclamation-triangle" style="font-size:2rem;margin-bottom:16px"></i>
                        <div style="font-weight:600;margin-bottom:8px;">Error</div>
                        <div class="muted">${escapeHtml(msg)}</div>
                    </div>
                </td></tr>
            `;
            
            if (tbody) tbody.innerHTML = errorHtml;
            if (cards) cards.innerHTML = `<div class="mobile-promo-card"><div style="text-align:center;padding:20px;color:#ef4444">${escapeHtml(msg)}</div></div>`;
        }

        window.addEventListener('beforeunload', cleanupPromos);

        // Initialize
        loadPromos();
    })();
</script>
</div>
