<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --dark:#000;
  --light:#f5f5f5;
  --gray:#666;
  --border:#e0e0e0;
  --card-bg:rgba(255,255,255,0.95);
  --radius:12px;
  --shadow:0 4px 12px rgba(0,0,0,0.1);
}

*{box-sizing:border-box;margin:0;padding:0}

.page-container{
  max-width:1400px;
  margin:24px auto;
  padding:20px;
  width:100%;
  overflow-x:auto;
}

.page-title{
  font-family:'Outfit',sans-serif;
  font-size:1.9rem;
  font-weight:700
}

.page-subtitle{
  color:var(--gray);
  margin-bottom:18px
}

.filters-bar{
  background:var(--card-bg);
  box-shadow:var(--shadow);
  border-radius:var(--radius);
  padding:14px 16px;
  margin-bottom:20px;
  display:flex;
  flex-wrap:wrap;
  gap:16px
}

.filter-group{
  flex:1;
  min-width:180px;
  display:flex;
  flex-direction:column
}

.filter-label{
  font-size:.8rem;
  color:var(--gray);
  margin-bottom:6px;
  font-weight:600
}

.filter-select{
  padding:10px 12px;
  border-radius:8px;
  border:1px solid var(--border);
  background:var(--card-bg);
  font-size:.95rem;
  box-shadow:var(--shadow)
}

.table-container{
  background:var(--card-bg);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  overflow:hidden;
  margin-bottom:22px;
  overflow-x:auto;
}

table{
  width:100%;
  border-collapse:collapse;
  min-width:650px;
}

thead{
  background:rgba(0,0,0,0.04)
}

th{
  padding:14px 16px;
  text-align:left;
  font-weight:600;
  font-size:.95rem;
  border-bottom:1px solid var(--border)
}

td{
  padding:12px 16px;
  font-size:.95rem;
  border-bottom:1px solid var(--border);
  vertical-align:middle
}

tr:hover{
  background:rgba(0,0,0,0.03)
}

.user-info{
  display:flex;
  align-items:center;
  gap:12px
}

.avatar{
  width:40px;
  height:40px;
  border-radius:50%;
  background:#000;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700
}

.status{
  padding:6px 14px;
  border-radius:25px;
  font-size:.75rem;
  font-weight:700;
  display:inline-block
}

.status-new{background:#fff3f3;color:#b71c1c}
.status-read{background:#eaf4ff;color:#054a9b}
.status-replied{background:#e9fbef;color:#0f7a47}

.actions{
  display:flex;
  gap:8px
}

.action-btn{
  width:38px;
  height:38px;
  border-radius:10px;
  background:rgba(0,0,0,0.06);
  border:none;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition:all .14s
}

.action-btn:hover{
  transform:translateY(-3px);
  background:rgba(0,0,0,0.12)
}

.mobile-cards{
  display:none;
  flex-direction:column;
  gap:14px
}

.card{
  background:var(--card-bg);
  padding:16px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  display:flex;
  flex-direction:column;
  gap:10px
}

.card-row{
  display:flex;
  justify-content:space-between;
  align-items:center
}

.card .meta{
  color:var(--gray);
  font-size:.85rem
}

.modal{
  position:fixed;
  inset:0;
  display:none;
  background:rgba(0,0,0,0.45);
  backdrop-filter:blur(4px);
  align-items:center;
  justify-content:center;
  z-index:1200;
  padding:20px;
}

.modal-content{
  background:var(--card-bg);
  width:100%;
  max-width:520px;
  border-radius:var(--radius);
  overflow:hidden;
  box-shadow:var(--shadow);
  animation:pop .2s ease;
  max-height:90vh;
  overflow-y:auto;
}

@keyframes pop{
  from{opacity:0;transform:translateY(8px)}
  to{opacity:1;transform:none}
}

.modal-header{
  padding:16px;
  background:#000;
  color:#fff;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;
  top:0;
  z-index:10;
}

.modal-body{
  padding:18px
}

.detail-label{
  font-size:.8rem;
  color:var(--gray);
  margin-bottom:6px;
  font-weight:600
}

.detail-value{
  background:rgba(0,0,0,0.04);
  padding:12px;
  border-radius:10px;
  margin-bottom:12px;
  word-break:break-word;
}

.message-box{
  min-height:120px;
  max-height:200px;
  overflow:auto;
  white-space:pre-wrap;
  word-break:break-word;
}

.modal-footer{
  display:flex;
  gap:10px;
  justify-content:flex-end;
  padding:14px;
  border-top:1px solid var(--border);
  position:sticky;
  bottom:0;
  background:var(--card-bg);
}

.btn{
  padding:9px 16px;
  border-radius:10px;
  border:none;
  cursor:pointer;
  font-weight:700;
  font-size:14px;
}

.btn-primary{background:#000;color:#fff}
.btn-secondary{background:rgba(0,0,0,0.07)}

.toast{
  position:fixed;
  right:20px;
  bottom:20px;
  background:var(--card-bg);
  padding:12px 16px;
  border-radius:12px;
  box-shadow:var(--shadow);
  display:flex;
  gap:10px;
  align-items:center;
  transform:translateY(24px);
  opacity:0;
  transition:.25s;
  z-index:1300;
  max-width:300px;
  word-break:break-word;
}

.toast.show{
  transform:none;
  opacity:1
}

/* RESPONSIVE DESIGN */
@media(max-width:1024px){
  .table-container{
    display:none !important;
  }

  .mobile-cards{
    display:flex;
  }
  
  .filters-bar{
    flex-direction:column;
  }
  
  .filter-group{
    min-width:100%;
  }
}

@media(max-width:768px){
  .page-container{
    padding:12px;
    margin:16px auto;
  }
  
  .page-title{
    font-size:1.6rem;
  }
  
  .modal{
    padding:10px;
  }
  
  .modal-content{
    max-height:95vh;
  }
  
  .modal-body{
    padding:14px;
  }
  
  .modal-footer{
    flex-direction:column;
  }
  
  .btn{
    width:100%;
    text-align:center;
  }
  
  .filters-bar{
    padding:12px;
  }
}

@media(max-width:480px){
  .page-container{
    padding:8px;
    margin:12px auto;
  }
  
  .page-title{
    font-size:1.4rem;
  }
  
  .page-subtitle{
    font-size:0.9rem;
  }
  
  .card{
    padding:12px;
  }
  
  .user-info{
    gap:8px;
  }
  
  .avatar{
    width:32px;
    height:32px;
    font-size:0.8rem;
  }
  
  .actions{
    gap:6px;
  }
  
  .action-btn{
    width:32px;
    height:32px;
    font-size:0.8rem;
  }
  
  .modal{
    padding:5px;
  }
  
  .modal-header{
    padding:12px;
    font-size:0.9rem;
  }
  
  .modal-body{
    padding:12px;
  }
  
  .detail-value{
    padding:10px;
    font-size:0.9rem;
  }
  
  .message-box{
    max-height:150px;
    font-size:0.9rem;
  }
  
  .toast{
    right:10px;
    left:10px;
    bottom:10px;
    max-width:none;
  }
}

/* Fix for mobile cards duplicate issue */
.mobile-cards .card {
  display: flex !important;
}

.table-container table {
  display: table !important;
}

/* Ensure proper hiding on different screens */
@media(max-width:1024px){
  .table-container{
    display:none;
  }
  
  .mobile-cards{
    display:flex;
  }
}

@media(min-width:1025px){
  .table-container{
    display:block;
  }
  
  .mobile-cards{
    display:none;
  }
}
</style>

<div class="page-container fade-in">
  <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;">
    <div style="flex:1;min-width:250px;">
      <div class="page-title">Contact Submissions</div>
      <div class="page-subtitle">Manage and respond to customer inquiries</div>
    </div>
    <button id="testDataBtn" style="padding:8px 16px;background:#000;color:white;border:none;border-radius:5px;cursor:pointer;font-size:14px;white-space:nowrap;">
        Add Test Data
    </button>
  </div>

  <div class="filters-bar">
    <div class="filter-group">
      <div class="filter-label">Status</div>
      <select id="status-filter" class="filter-select">
        <option value="all">All</option>
        <option value="new">New</option>
        <option value="read">Read</option>
        <option value="replied">Replied</option>
      </select>
    </div>
    <div class="filter-group">
      <div class="filter-label">Date Range</div>
      <select id="date-filter" class="filter-select">
        <option value="all">All Time</option>
        <option value="today">Today</option>
        <option value="week">This Week</option>
        <option value="month">This Month</option>
      </select>
    </div>
  </div>

  <!-- Desktop Table -->
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Contact</th>
          <th>Subject</th>
          <th>Date</th>
          <th>Status</th>
          <th style="width:140px">Actions</th>
        </tr>
      </thead>
      <tbody id="submissions-table-body">
        <tr>
          <td colspan="5" style="text-align:center;padding:40px;color:#666;">
            <i class="fas fa-spinner fa-spin" style="font-size:24px;margin-bottom:10px;"></i>
            <p>Loading messages...</p>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Mobile Cards -->
  <div id="mobile-cards" class="mobile-cards">
    <div class="card" style="text-align:center;padding:30px;">
      <i class="fas fa-spinner fa-spin" style="font-size:24px;margin-bottom:10px;"></i>
      <p>Loading messages...</p>
    </div>
  </div>
</div>

<!-- MODAL -->
<div id="submission-modal" class="modal" role="dialog" aria-modal="true">
  <div class="modal-content">
    <div class="modal-header">
      <div style="font-weight:600;">Message Details</div>
      <button id="close-modal" class="btn-secondary btn" style="min-width:auto;padding:8px;">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="detail-label">Name</div>
      <div id="detail-name" class="detail-value">-</div>

      <div class="detail-label">Email</div>
      <div id="detail-email" class="detail-value">-</div>

      <div class="detail-label">Phone</div>
      <div id="detail-phone" class="detail-value">-</div>

      <div class="detail-label">Subject</div>
      <div id="detail-subject" class="detail-value">-</div>

      <div class="detail-label">Status</div>
      <div id="detail-status" class="detail-value">-</div>

      <div class="detail-label">Message</div>
      <div id="detail-message" class="detail-value message-box">-</div>
    </div>

    <div class="modal-footer">
      <button id="close-modal-2" class="btn-secondary btn">Close</button>
      <button id="gmail-reply-btn" class="btn btn-secondary">Reply via Gmail</button>
    </div>
  </div>
</div>

<div id="toast" class="toast">
  <i class="fas fa-check-circle"></i>
  <div id="toast-message">Updated</div>
</div>

<script>
// Simple Contact Manager that works with your dashboard setup
class ContactSubmissionsManager {
    constructor() {
        this.currentSubmissions = [];
        this.filteredSubmissions = [];
        this.currentSubmissionId = null;
        this.initialize();
    }

    initialize() {
        console.log('Contact Manager Initializing...');
        this.setupEventListeners();
        this.loadSubmissions();
    }

    setupEventListeners() {
        // Test data button
        const testBtn = document.getElementById('testDataBtn');
        if (testBtn) {
            testBtn.addEventListener('click', () => this.addTestData());
        }

        // Modal close buttons
        const closeModalBtn = document.getElementById('close-modal');
        const closeModalBtn2 = document.getElementById('close-modal-2');
        const gmailReplyBtn = document.getElementById('gmail-reply-btn');

        if (closeModalBtn) closeModalBtn.addEventListener('click', () => this.closeModal());
        if (closeModalBtn2) closeModalBtn2.addEventListener('click', () => this.closeModal());
        if (gmailReplyBtn) gmailReplyBtn.addEventListener('click', () => this.replyEmail());

        // Modal backdrop click
        const modal = document.getElementById('submission-modal');
        if (modal) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) this.closeModal();
            });
        }

        // Filters
        const statusFilter = document.getElementById('status-filter');
        const dateFilter = document.getElementById('date-filter');

        if (statusFilter) statusFilter.addEventListener('change', () => this.applyFilters());
        if (dateFilter) dateFilter.addEventListener('change', () => this.applyFilters());

        // Event delegation for action buttons
        document.addEventListener('click', (e) => {
            const viewBtn = e.target.closest('.view-btn');
            const replyBtn = e.target.closest('.reply-btn');
            const deleteBtn = e.target.closest('.delete-btn');

            if (viewBtn) this.openModal(viewBtn.dataset.id);
            if (replyBtn) this.replyEmailDirect(replyBtn.dataset.id);
            if (deleteBtn) this.deleteSubmission(deleteBtn.dataset.id);
        });
    }

    showLoadingState() {
        const tableBody = document.getElementById('submissions-table-body');
        const mobileCards = document.getElementById('mobile-cards');

        if (tableBody) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align:center;padding:40px;color:#666;">
                        <i class="fas fa-spinner fa-spin" style="font-size:24px;margin-bottom:10px;"></i>
                        <p>Loading messages...</p>
                    </td>
                </tr>`;
        }

        if (mobileCards) {
            mobileCards.innerHTML = `
                <div class="card" style="text-align:center;padding:30px;">
                    <i class="fas fa-spinner fa-spin" style="font-size:24px;margin-bottom:10px;"></i>
                    <p>Loading messages...</p>
                </div>`;
        }
    }

    showError(message) {
        const tableBody = document.getElementById('submissions-table-body');
        const mobileCards = document.getElementById('mobile-cards');

        if (tableBody) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align:center;padding:40px;color:red;">
                        <i class="fas fa-exclamation-triangle" style="font-size:24px;margin-bottom:10px;"></i>
                        <p>${message}</p>
                        <button onclick="contactManager.loadSubmissions()" style="margin-top:10px;padding:8px 16px;background:#000;color:white;border:none;border-radius:5px;cursor:pointer;">
                            Retry
                        </button>
                    </td>
                </tr>`;
        }

        if (mobileCards) {
            mobileCards.innerHTML = `
                <div class="card" style="text-align:center;padding:30px;color:red;">
                    <i class="fas fa-exclamation-triangle" style="font-size:24px;margin-bottom:10px;"></i>
                    <p>${message}</p>
                    <button onclick="contactManager.loadSubmissions()" style="margin-top:10px;padding:8px 16px;background:#000;color:white;border:none;border-radius:5px;cursor:pointer;">
                        Retry
                    </button>
                </div>`;
        }
    }

    loadSubmissions() {
        console.log('Loading submissions...');
        
        // Check if Firebase is available
        if (typeof firebase === 'undefined' || !firebase.firestore) {
            this.showError("Firebase is not available. Please refresh the dashboard.");
            return;
        }

        this.showLoadingState();

        try {
            const db = firebase.firestore();
            
            db.collection("contactSubmissions")
                .orderBy("timestamp", "desc")
                .get()
                .then((snapshot) => {
                    console.log('Firestore response received:', snapshot.size, 'documents');
                    this.currentSubmissions = [];

                    if (snapshot.empty) {
                        this.showNoDataMessage();
                        return;
                    }

                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const submission = {
                            id: doc.id,
                            name: data.name || 'Unknown',
                            email: data.email || 'No email',
                            phone: data.phone || 'Not provided',
                            subject: data.subject || 'No subject',
                            message: data.message || 'No message',
                            status: data.status || 'new',
                            date: data.timestamp ? this.formatFirebaseTimestamp(data.timestamp) : new Date().toISOString()
                        };
                        this.currentSubmissions.push(submission);
                    });

                    this.filteredSubmissions = [...this.currentSubmissions];
                    this.renderTable();
                    this.renderMobileCards();
                    
                    console.log('Successfully loaded', this.currentSubmissions.length, 'submissions');
                })
                .catch((error) => {
                    console.error('Firestore error:', error);
                    this.showError("Failed to load messages: " + error.message);
                });

        } catch (error) {
            console.error('Error loading submissions:', error);
            this.showError("Error loading messages: " + error.message);
        }
    }

    formatFirebaseTimestamp(timestamp) {
        if (timestamp && timestamp.toDate) {
            return timestamp.toDate().toISOString();
        }
        return new Date().toISOString();
    }

    showNoDataMessage() {
        const tableBody = document.getElementById('submissions-table-body');
        const mobileCards = document.getElementById('mobile-cards');

        if (tableBody) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align:center;padding:60px 40px;color:#666;">
                        <i class="fas fa-inbox" style="font-size:48px;color:#ddd;margin-bottom:15px;"></i>
                        <h3 style="margin-bottom:10px;font-weight:500;">No messages yet</h3>
                        <p style="color:#888;max-width:400px;margin:0 auto;">
                            No contact form submissions found. Customer messages will appear here when they contact you.
                        </p>
                    </td>
                </tr>`;
        }

        if (mobileCards) {
            mobileCards.innerHTML = `
                <div class="card" style="text-align:center;padding:40px 20px;">
                    <i class="fas fa-inbox" style="font-size:48px;color:#ddd;margin-bottom:15px;"></i>
                    <h3 style="margin-bottom:10px;font-weight:500;">No messages yet</h3>
                    <p style="color:#888;">Customer messages will appear here when they contact you.</p>
                </div>`;
        }
    }

    renderTable() {
        const tableBody = document.getElementById('submissions-table-body');
        if (!tableBody) return;

        if (this.filteredSubmissions.length === 0) {
            this.showNoDataMessage();
            return;
        }

        tableBody.innerHTML = this.filteredSubmissions.map((submission) => {
            const initials = this.getInitials(submission.name);
            const shortSubject = submission.subject.length > 50 ? 
                submission.subject.substring(0, 50) + '...' : submission.subject;

            return `
                <tr>
                    <td>
                        <div class="user-info">
                            <div class="avatar">${initials}</div>
                            <div>
                                <div style="font-weight:600;">${this.escapeHtml(submission.name)}</div>
                                <div style="font-size:.8rem;color:#666">${this.escapeHtml(submission.email)}</div>
                            </div>
                        </div>
                    </td>
                    <td>${this.escapeHtml(shortSubject)}</td>
                    <td style="white-space:nowrap;">${this.formatDate(submission.date)}</td>
                    <td><span class="status status-${submission.status}">${this.formatStatus(submission.status)}</span></td>
                    <td>
                        <div class="actions">
                            <button class="action-btn view-btn" data-id="${submission.id}" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn reply-btn" data-id="${submission.id}" title="Reply">
                                <i class="fas fa-reply"></i>
                            </button>
                            <button class="action-btn delete-btn" data-id="${submission.id}" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
        }).join("");
    }

    renderMobileCards() {
        const mobileCards = document.getElementById('mobile-cards');
        if (!mobileCards) return;

        if (this.filteredSubmissions.length === 0) {
            this.showNoDataMessage();
            return;
        }

        mobileCards.innerHTML = this.filteredSubmissions.map((submission) => {
            const initials = this.getInitials(submission.name);

            return `
                <div class="card">
                    <div class="card-row">
                        <div class="user-info">
                            <div class="avatar">${initials}</div>
                            <div>
                                <div style="font-weight:600;">${this.escapeHtml(submission.name)}</div>
                                <div style="font-size:.8rem;color:#666">${this.escapeHtml(submission.email)}</div>
                            </div>
                        </div>
                        <span class="status status-${submission.status}">${this.formatStatus(submission.status)}</span>
                    </div>
                    <div style="font-weight:500;margin:8px 0;">${this.escapeHtml(submission.subject)}</div>
                    <div style="font-size:.8rem;color:#666">${this.formatDate(submission.date)}</div>
                    <div class="card-row" style="justify-content:flex-end;margin-top:8px;">
                        <button class="action-btn view-btn" data-id="${submission.id}" title="View">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn reply-btn" data-id="${submission.id}" title="Reply">
                            <i class="fas fa-reply"></i>
                        </button>
                        <button class="action-btn delete-btn" data-id="${submission.id}" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>`;
        }).join("");
    }

    openModal(id) {
        const submission = this.currentSubmissions.find(s => s.id === id);
        if (!submission) {
            this.showToast("Message not found");
            return;
        }

        this.currentSubmissionId = id;

        // Populate modal with submission data
        document.getElementById("detail-name").textContent = submission.name;
        document.getElementById("detail-email").textContent = submission.email;
        document.getElementById("detail-phone").textContent = submission.phone;
        document.getElementById("detail-subject").textContent = submission.subject;
        document.getElementById("detail-status").textContent = this.formatStatus(submission.status);
        document.getElementById("detail-message").textContent = submission.message;

        // Show modal
        document.getElementById("submission-modal").style.display = "flex";

        // Update status to "read" if it's new
        if (submission.status === "new") {
            this.updateStatus(id, "read");
        }
    }

    closeModal() {
        document.getElementById("submission-modal").style.display = "none";
        this.currentSubmissionId = null;
    }

    replyEmail() {
        if (!this.currentSubmissionId) return;
        this.replyEmailDirect(this.currentSubmissionId);
    }

    replyEmailDirect(id) {
        const submission = this.currentSubmissions.find(s => s.id === id);
        if (!submission) return;

        // Update status to "replied"
        this.updateStatus(id, "replied");

        // Create Gmail compose URL
        const subject = encodeURIComponent("Re: " + submission.subject);
        const body = encodeURIComponent(
            `Hello ${submission.name},\n\n` +
            `Thank you for contacting us regarding: "${submission.subject}"\n\n` +
            `We have received your message and will get back to you shortly.\n\n` +
            `Best regards,\nYour Team\n\n` +
            `--- Original Message ---\n` +
            `${submission.message}`
        );

        const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(submission.email)}&su=${subject}&body=${body}`;
        
        // Open Gmail in new tab
        window.open(gmailUrl, "_blank");
        this.showToast("Opening Gmail to reply...");
    }

    deleteSubmission(id) {
        if (!confirm("Are you sure you want to delete this message? This action cannot be undone.")) {
            return;
        }

        try {
            const db = firebase.firestore();
            
            db.collection("contactSubmissions").doc(id).delete()
                .then(() => {
                    // Remove from local arrays
                    this.currentSubmissions = this.currentSubmissions.filter(s => s.id !== id);
                    this.filteredSubmissions = this.filteredSubmissions.filter(s => s.id !== id);
                    
                    // Re-render
                    this.renderTable();
                    this.renderMobileCards();
                    
                    this.showToast("Message deleted successfully");
                })
                .catch((error) => {
                    console.error("Error deleting submission:", error);
                    this.showToast("Error deleting message: " + error.message);
                });
        } catch (error) {
            console.error("Error deleting submission:", error);
            this.showToast("Error deleting message: " + error.message);
        }
    }

    updateStatus(id, newStatus) {
        try {
            const db = firebase.firestore();
            
            db.collection("contactSubmissions").doc(id).update({
                status: newStatus,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                // Update local data
                const submission = this.currentSubmissions.find(s => s.id === id);
                if (submission) {
                    submission.status = newStatus;
                }
                
                const filteredSubmission = this.filteredSubmissions.find(s => s.id === id);
                if (filteredSubmission) {
                    filteredSubmission.status = newStatus;
                }
                
                // Re-render
                this.renderTable();
                this.renderMobileCards();
                
                this.showToast(`Status updated to ${this.formatStatus(newStatus)}`);
            })
            .catch((error) => {
                console.error("Error updating status:", error);
                this.showToast("Error updating status: " + error.message);
            });
        } catch (error) {
            console.error("Error updating status:", error);
            this.showToast("Error updating status: " + error.message);
        }
    }

    applyFilters() {
        const statusFilter = document.getElementById('status-filter');
        const dateFilter = document.getElementById('date-filter');
        
        const statusValue = statusFilter ? statusFilter.value : 'all';
        const dateValue = dateFilter ? dateFilter.value : 'all';

        let filtered = [...this.currentSubmissions];

        // Apply status filter
        if (statusValue !== 'all') {
            filtered = filtered.filter(s => s.status === statusValue);
        }

        // Apply date filter
        if (dateValue !== 'all') {
            const now = new Date();
            let startDate;

            switch (dateValue) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                    break;
                default:
                    startDate = null;
            }

            if (startDate) {
                filtered = filtered.filter(s => new Date(s.date) >= startDate);
            }
        }

        this.filteredSubmissions = filtered;
        this.renderTable();
        this.renderMobileCards();
    }

    addTestData() {
        if (typeof firebase === 'undefined' || !firebase.firestore) {
            this.showToast("Firebase not available");
            return;
        }

        try {
            const db = firebase.firestore();
            
            const testData = {
                name: "Test Customer",
                email: "test@example.com",
                phone: "+1234567890",
                subject: "Test Inquiry About Products",
                message: "Hello, I'm interested in learning more about your products. Could you please send me more information?",
                status: "new",
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection("contactSubmissions").add(testData)
                .then(() => {
                    this.showToast("Test message added successfully");
                    this.loadSubmissions(); // Reload to show the new message
                })
                .catch((error) => {
                    console.error("Error adding test data:", error);
                    this.showToast("Error adding test message: " + error.message);
                });
        } catch (error) {
            console.error("Error adding test data:", error);
            this.showToast("Error adding test message: " + error.message);
        }
    }

    // Utility functions
    getInitials(name) {
        return name.split(' ')
            .map(part => part.charAt(0))
            .join('')
            .toUpperCase()
            .substring(0, 2);
    }

    formatDate(dateString) {
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (error) {
            return 'Invalid date';
        }
    }

    formatStatus(status) {
        return status.charAt(0).toUpperCase() + status.slice(1);
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    showToast(message) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');

        if (toast && toastMessage) {
            toastMessage.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    }
}

// Initialize the contact manager when the page loads
let contactManager;

function initializeContactPage() {
    console.log('Initializing contact page...');
    contactManager = new ContactSubmissionsManager();
    window.contactManager = contactManager;
}

// Start the page when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeContactPage);
} else {
    initializeContactPage();
}
</script>
