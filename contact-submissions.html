<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --dark:#000;
  --light:#f5f5f5;
  --gray:#666;
  --border:#e0e0e0;
  --card-bg:rgba(255,255,255,0.95);
  --radius:12px;
  --shadow:0 4px 12px rgba(0,0,0,0.1);
}

*{box-sizing:border-box;margin:0;padding:0}

.page-container{
  max-width:1400px;
  margin:24px auto;
  padding:20px;
  width:100%;
  overflow-x:auto;
}

.page-title{
  font-family:'Outfit',sans-serif;
  font-size:1.9rem;
  font-weight:700
}

.page-subtitle{
  color:var(--gray);
  margin-bottom:18px
}

.filters-bar{
  background:var(--card-bg);
  box-shadow:var(--shadow);
  border-radius:var(--radius);
  padding:14px 16px;
  margin-bottom:20px;
  display:flex;
  flex-wrap:wrap;
  gap:16px
}

.filter-group{
  flex:1;
  min-width:180px;
  display:flex;
  flex-direction:column
}

.filter-label{
  font-size:.8rem;
  color:var(--gray);
  margin-bottom:6px;
  font-weight:600
}

.filter-select{
  padding:10px 12px;
  border-radius:8px;
  border:1px solid var(--border);
  background:var(--card-bg);
  font-size:.95rem;
  box-shadow:var(--shadow)
}

.table-container{
  background:var(--card-bg);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  overflow:hidden;
  margin-bottom:22px;
  overflow-x:auto;
}

table{
  width:100%;
  border-collapse:collapse;
  min-width:650px;
}

thead{
  background:rgba(0,0,0,0.04)
}

th{
  padding:14px 16px;
  text-align:left;
  font-weight:600;
  font-size:.95rem;
  border-bottom:1px solid var(--border)
}

td{
  padding:12px 16px;
  font-size:.95rem;
  border-bottom:1px solid var(--border);
  vertical-align:middle
}

tr:hover{
  background:rgba(0,0,0,0.03)
}

.user-info{
  display:flex;
  align-items:center;
  gap:12px
}

.avatar{
  width:40px;
  height:40px;
  border-radius:50%;
  background:#000;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700
}

.status{
  padding:6px 14px;
  border-radius:25px;
  font-size:.75rem;
  font-weight:700;
  display:inline-block
}

.status-new{background:#fff3f3;color:#b71c1c}
.status-read{background:#eaf4ff;color:#054a9b}
.status-replied{background:#e9fbef;color:#0f7a47}

.actions{
  display:flex;
  gap:8px
}

.action-btn{
  width:38px;
  height:38px;
  border-radius:10px;
  background:rgba(0,0,0,0.06);
  border:none;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition:all .14s
}

.action-btn:hover{
  transform:translateY(-3px);
  background:rgba(0,0,0,0.12)
}

.mobile-cards{
  display:none;
  flex-direction:column;
  gap:14px
}

.card{
  background:var(--card-bg);
  padding:16px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  display:flex;
  flex-direction:column;
  gap:10px
}

.card-row{
  display:flex;
  justify-content:space-between;
  align-items:center
}

.card .meta{
  color:var(--gray);
  font-size:.85rem
}

.modal{
  position:fixed;
  inset:0;
  display:none;
  background:rgba(0,0,0,0.45);
  backdrop-filter:blur(4px);
  align-items:center;
  justify-content:center;
  z-index:1200;
  padding:20px;
}

.modal-content{
  background:var(--card-bg);
  width:100%;
  max-width:520px;
  border-radius:var(--radius);
  overflow:hidden;
  box-shadow:var(--shadow);
  animation:pop .2s ease;
  max-height:90vh;
  overflow-y:auto;
}

@keyframes pop{
  from{opacity:0;transform:translateY(8px)}
  to{opacity:1;transform:none}
}

.modal-header{
  padding:16px;
  background:#000;
  color:#fff;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;
  top:0;
  z-index:10;
}

.modal-body{
  padding:18px
}

.detail-label{
  font-size:.8rem;
  color:var(--gray);
  margin-bottom:6px;
  font-weight:600
}

.detail-value{
  background:rgba(0,0,0,0.04);
  padding:12px;
  border-radius:10px;
  margin-bottom:12px;
  word-break:break-word;
}

.message-box{
  min-height:120px;
  max-height:200px;
  overflow:auto;
  white-space:pre-wrap;
  word-break:break-word;
}

.modal-footer{
  display:flex;
  gap:10px;
  justify-content:flex-end;
  padding:14px;
  border-top:1px solid var(--border);
  position:sticky;
  bottom:0;
  background:var(--card-bg);
}

.btn{
  padding:9px 16px;
  border-radius:10px;
  border:none;
  cursor:pointer;
  font-weight:700;
  font-size:14px;
}

.btn-primary{background:#000;color:#fff}
.btn-secondary{background:rgba(0,0,0,0.07)}

.toast{
  position:fixed;
  right:20px;
  bottom:20px;
  background:var(--card-bg);
  padding:12px 16px;
  border-radius:12px;
  box-shadow:var(--shadow);
  display:flex;
  gap:10px;
  align-items:center;
  transform:translateY(24px);
  opacity:0;
  transition:.25s;
  z-index:1300;
  max-width:300px;
  word-break:break-word;
}

.toast.show{
  transform:none;
  opacity:1
}

/* RESPONSIVE DESIGN */
@media(max-width:1024px){
  .table-container{
    display:none !important;
  }

  .mobile-cards{
    display:flex;
  }
  
  .filters-bar{
    flex-direction:column;
  }
  
  .filter-group{
    min-width:100%;
  }
}

@media(max-width:768px){
  .page-container{
    padding:12px;
    margin:16px auto;
  }
  
  .page-title{
    font-size:1.6rem;
  }
  
  .modal{
    padding:10px;
  }
  
  .modal-content{
    max-height:95vh;
  }
  
  .modal-body{
    padding:14px;
  }
  
  .modal-footer{
    flex-direction:column;
  }
  
  .btn{
    width:100%;
    text-align:center;
  }
  
  .filters-bar{
    padding:12px;
  }
}

@media(max-width:480px){
  .page-container{
    padding:8px;
    margin:12px auto;
  }
  
  .page-title{
    font-size:1.4rem;
  }
  
  .page-subtitle{
    font-size:0.9rem;
  }
  
  .card{
    padding:12px;
  }
  
  .user-info{
    gap:8px;
  }
  
  .avatar{
    width:32px;
    height:32px;
    font-size:0.8rem;
  }
  
  .actions{
    gap:6px;
  }
  
  .action-btn{
    width:32px;
    height:32px;
    font-size:0.8rem;
  }
  
  .modal{
    padding:5px;
  }
  
  .modal-header{
    padding:12px;
    font-size:0.9rem;
  }
  
  .modal-body{
    padding:12px;
  }
  
  .detail-value{
    padding:10px;
    font-size:0.9rem;
  }
  
  .message-box{
    max-height:150px;
    font-size:0.9rem;
  }
  
  .toast{
    right:10px;
    left:10px;
    bottom:10px;
    max-width:none;
  }
}

/* Fix for mobile cards duplicate issue */
.mobile-cards .card {
  display: flex !important;
}

.table-container table {
  display: table !important;
}

/* Ensure proper hiding on different screens */
@media(max-width:1024px){
  .table-container{
    display:none;
  }
  
  .mobile-cards{
    display:flex;
  }
}

@media(min-width:1025px){
  .table-container{
    display:block;
  }
  
  .mobile-cards{
    display:none;
  }
}
</style>

<div class="page-container fade-in">
  <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;">
    <div style="flex:1;min-width:250px;">
      <div class="page-title">Contact Submissions</div>
      <div class="page-subtitle">Manage and respond to customer inquiries</div>
    </div>
    <div style="display:flex;gap:10px;">
      <button id="manual-refresh" style="padding:8px 16px;background:#f5f5f5;color:#333;border:1px solid #ddd;border-radius:5px;cursor:pointer;font-size:14px;white-space:nowrap;">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
      <button id="testDataBtn" style="padding:8px 16px;background:#000;color:white;border:none;border-radius:5px;cursor:pointer;font-size:14px;white-space:nowrap;">
        Add Test Data
      </button>
    </div>
  </div>

  <div class="filters-bar">
    <div class="filter-group">
      <div class="filter-label">Status</div>
      <select id="status-filter" class="filter-select">
        <option value="all">All</option>
        <option value="new">New</option>
        <option value="read">Read</option>
        <option value="replied">Replied</option>
      </select>
    </div>
    <div class="filter-group">
      <div class="filter-label">Date Range</div>
      <select id="date-filter" class="filter-select">
        <option value="all">All Time</option>
        <option value="today">Today</option>
        <option value="week">This Week</option>
        <option value="month">This Month</option>
      </select>
    </div>
  </div>

  <!-- Desktop Table -->
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Contact</th>
          <th>Subject</th>
          <th>Date</th>
          <th>Status</th>
          <th style="width:140px">Actions</th>
        </tr>
      </thead>
      <tbody id="submissions-table-body">
        <tr>
          <td colspan="5" style="text-align:center;padding:40px;color:#666;">
            <i class="fas fa-spinner fa-spin" style="font-size:24px;margin-bottom:10px;"></i>
            <p>Loading messages...</p>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Mobile Cards -->
  <div id="mobile-cards" class="mobile-cards">
    <div class="card" style="text-align:center;padding:30px;">
      <i class="fas fa-spinner fa-spin" style="font-size:24px;margin-bottom:10px;"></i>
      <p>Loading messages...</p>
    </div>
  </div>
</div>

<!-- MODAL -->
<div id="submission-modal" class="modal" role="dialog" aria-modal="true">
  <div class="modal-content">
    <div class="modal-header">
      <div style="font-weight:600;">Message Details</div>
      <button id="close-modal" class="btn-secondary btn" style="min-width:auto;padding:8px;">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="detail-label">Name</div>
      <div id="detail-name" class="detail-value">-</div>

      <div class="detail-label">Email</div>
      <div id="detail-email" class="detail-value">-</div>

      <div class="detail-label">Phone</div>
      <div id="detail-phone" class="detail-value">-</div>

      <div class="detail-label">Subject</div>
      <div id="detail-subject" class="detail-value">-</div>

      <div class="detail-label">Status</div>
      <div id="detail-status" class="detail-value">-</div>

      <div class="detail-label">Message</div>
      <div id="detail-message" class="detail-value message-box">-</div>
    </div>

    <div class="modal-footer">
      <button id="close-modal-2" class="btn-secondary btn">Close</button>
      <button id="gmail-reply-btn" class="btn btn-secondary">Reply via Gmail</button>
    </div>
  </div>
</div>

<div id="toast" class="toast">
  <i class="fas fa-check-circle"></i>
  <div id="toast-message">Updated</div>
</div>

<script src="activityLogger.js?v=1"></script>


<script>
(function () {
  // Prevent double-binding if this script is injected multiple times
  if (window.__CONTACT_SUBMISSIONS_SCRIPT_LOADED__) return;
  window.__CONTACT_SUBMISSIONS_SCRIPT_LOADED__ = true;

  const enquiryActivityCache = new Set();

  function escapeHtml(s) {
    return String(s || "").replace(/[&<>"']/g, c => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;"
    }[c]));
  }

  function logEnquiryActivity(type, message, refId = null) {
    try {
      if (!window.db || !window.db.collection) return;
      const key = `${type}_${refId || ""}`;
      if (enquiryActivityCache.has(key)) return;
      enquiryActivityCache.add(key);
      window.db.collection("activities").add({
        type,
        message,
        refId,
        time: firebase.firestore.FieldValue.serverTimestamp()
      }).catch(() => {});
    } catch (e) {
      // Silent fail â€“ activity logging is non-critical
    }
  }

  function parseTs(x) {
    if (!x) return null;
    if (typeof x.toDate === "function") return x.toDate();
    if (x.seconds) return new Date(x.seconds * 1000);
    if (x instanceof Date) return x;
    if (typeof x === "number") return new Date(x);
    try {
      return new Date(x);
    } catch (e) {
      return null;
    }
  }

  function initial(name) {
    const s = String(name || "").trim();
    return s ? s[0].toUpperCase() : "?";
  }

  function cap(s) {
    if (!s) return "";
    const str = String(s);
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  function shortText(t) {
    if (!t) return "";
    return t.length > 50 ? t.slice(0, 50) + "..." : t;
  }

  function fmt(d) {
    if (!d) return "-";
    try {
      return new Date(d).toLocaleString("en-IN");
    } catch (e) {
      return "-";
    }
  }

  function start() {
    const T = document.getElementById("submissions-table-body");
    const C = document.getElementById("mobile-cards");
    const M = document.getElementById("submission-modal");

    if (!T || !C || !M) return;

    const manualRefresh = document.getElementById("manual-refresh");
    const testDataBtn = document.getElementById("testDataBtn");
    const statusFilter = document.getElementById("status-filter");
    const dateFilter = document.getElementById("date-filter");
    const closeModalBtn = document.getElementById("close-modal");
    const closeModalBtn2 = document.getElementById("close-modal-2");
    const gmailReplyBtn = document.getElementById("gmail-reply-btn");

    let data = [];
    let currentMessageId = null;

    function renderLoading() {
      T.innerHTML = `
        <tr>
          <td colspan="5" style="text-align:center;padding:40px;">
            <i class="fas fa-spinner fa-spin"></i>
          </td>
        </tr>`;
      C.innerHTML = `
        <div class="card" style="text-align:center;padding:30px;">
          <i class="fas fa-spinner fa-spin"></i>
        </div>`;
    }

    function renderEmpty() {
      T.innerHTML = `
        <tr>
          <td colspan="5" style="text-align:center;padding:40px;">
            No messages
          </td>
        </tr>`;
      C.innerHTML = `
        <div class="card" style="text-align:center;padding:30px;">
          No messages
        </div>`;
    }

    function renderError(msg) {
      T.innerHTML = `
        <tr>
          <td colspan="5" style="text-align:center;padding:40px;color:red;">
            ${escapeHtml(msg)}
          </td>
        </tr>`;
      C.innerHTML = `
        <div class="card" style="text-align:center;padding:30px;color:red;">
          ${escapeHtml(msg)}
        </div>`;
    }

    function load() {
      renderLoading();

      const db = window.db || (window.firebase && firebase.firestore && firebase.firestore());
      if (!db || !db.collection) {
        renderError("Firestore unavailable");
        return;
      }

      db.collection("contactSubmissions")
        .orderBy("timestamp", "desc")
        .get()
        .then((snap) => {
          const now = Date.now();

          data = snap.docs.map((d) => {
            const v = d.data() || {};
            const ts = parseTs(v.timestamp);

            if (!v.activityLogged) {
              logEnquiryActivity(
                "ENQUIRY_NEW",
                `New message received from ${v.name || "Unknown"} (${v.email || "-"})`,
                d.id
              );
              db.collection("contactSubmissions").doc(d.id)
                .update({ activityLogged: true })
                .catch(() => {});
            }

            const item = {
              id: d.id,
              name: v.name || "",
              email: v.email || "",
              phone: v.phone || "",
              subject: v.subject || "",
              message: v.message || "",
              status: v.status || "new",
              timestamp: ts,
              missedAlertSent: !!v.missedAlertSent
            };

            if (item.status === "new" && item.timestamp && !item.missedAlertSent) {
              const ageHours = (now - item.timestamp.getTime()) / (1000 * 60 * 60);
              if (ageHours >= 24) {
                logEnquiryActivity(
                  "ENQUIRY_MISSED",
                  `Unread message for 24 hours from ${item.name} (${item.email})`,
                  item.id
                );
                db.collection("contactSubmissions").doc(item.id)
                  .update({ missedAlertSent: true })
                  .catch(() => {});
                item.missedAlertSent = true;
              }
            }

            return item;
          });

          applyFilters();
        })
        .catch((err) => {
          renderError(err && err.message ? err.message : "Failed to load messages");
        });
    }

    function render(list) {
      if (!list || !list.length) {
        renderEmpty();
        return;
      }

      T.innerHTML = list
        .map((x) => `
          <tr>
            <td>
              <div class="user-info">
                <div class="avatar">${initial(x.name)}</div>
                <div>
                  <div style="font-weight:600">${escapeHtml(x.name)}</div>
                  <div style="font-size:.8rem;color:#666">${escapeHtml(x.email)}</div>
                </div>
              </div>
            </td>
            <td>${escapeHtml(shortText(x.subject))}</td>
            <td>${fmt(x.timestamp)}</td>
            <td>
              <span class="status status-${escapeHtml(x.status)}">${cap(x.status)}</span>
            </td>
            <td>
              <div class="actions">
                <button class="action-btn v" data-id="${escapeHtml(x.id)}">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="action-btn r" data-id="${escapeHtml(x.id)}">
                  <i class="fas fa-reply"></i>
                </button>
                <button class="action-btn d" data-id="${escapeHtml(x.id)}">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `)
        .join("");

      C.innerHTML = list
        .map((x) => `
          <div class="card">
            <div class="card-row">
              <div class="user-info">
                <div class="avatar">${initial(x.name)}</div>
                <div>
                  <div style="font-weight:600">${escapeHtml(x.name)}</div>
                  <div style="font-size:.8rem;color:#666">${escapeHtml(x.email)}</div>
                </div>
              </div>
              <span class="status status-${escapeHtml(x.status)}">${cap(x.status)}</span>
            </div>
            <div style="font-weight:500;margin:8px 0;">
              ${escapeHtml(x.subject)}
            </div>
            <div style="font-size:.8rem;color:#666">
              ${fmt(x.timestamp)}
            </div>
            <div class="card-row" style="justify-content:flex-end;margin-top:10px;">
              <button class="action-btn v" data-id="${escapeHtml(x.id)}">
                <i class="fas fa-eye"></i>
              </button>
              <button class="action-btn r" data-id="${escapeHtml(x.id)}">
                <i class="fas fa-reply"></i>
              </button>
              <button class="action-btn d" data-id="${escapeHtml(x.id)}">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `)
        .join("");
    }

    function applyFilters() {
      let list = [...data];

      const st = statusFilter ? statusFilter.value : "all";
      const dv = dateFilter ? dateFilter.value : "all";

      if (st !== "all") {
        list = list.filter((x) => x.status === st);
      }

      if (dv !== "all") {
        const now = new Date();
        let start = null;

        if (dv === "today") {
          start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        } else if (dv === "week") {
          start = new Date(now.getTime() - 7 * 86400000);
        } else if (dv === "month") {
          start = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
        }

        if (start) {
          list = list.filter((o) => o.timestamp && o.timestamp >= start);
        }
      }

      render(list);
    }

    function openMessage(id) {
      const x = data.find((z) => z.id === id);
      if (!x) return;

      currentMessageId = id;

      fill("detail-name", x.name || "-");
      fill("detail-email", x.email || "-");
      fill("detail-phone", x.phone || "-");
      fill("detail-subject", x.subject || "-");
      fill("detail-status", cap(x.status || ""));
      fill("detail-message", x.message || "-");

      M.style.display = "flex";

      if (x.status === "new") {
        logEnquiryActivity(
          "ENQUIRY_READ",
          `Message opened from ${x.name} (${x.email})`,
          id
        );
        setStatus(id, "read");
      }
    }

    function setStatus(id, st) {
      const db = window.db || (window.firebase && firebase.firestore && firebase.firestore());
      if (!db || !db.collection) return;

      db.collection("contactSubmissions")
        .doc(id)
        .update({
          status: st,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
          // Reload to reflect changes
          load();
        })
        .catch(() => {});
    }

    function replyMessage(id) {
      const x = data.find((z) => z.id === id);
      if (!x || !x.email) return;

      setStatus(id, "replied");
      logEnquiryActivity(
        "ENQUIRY_REPLIED",
        `Replied to message from ${x.name} (${x.email})`,
        id
      );

      const subject = `Re: ${x.subject || ""}`;
      const bodyLines = [
        `Hi ${x.name || ""},`,
        "",
        `Thanks for reaching out regarding "${x.subject || ""}".`,
        "",
        "Original message:",
        x.message || "",
        "",
        "Best regards,",
        "Hexahoney Team"
      ];
      const body = bodyLines.join("\n");

      const url =
        "https://mail.google.com/mail/?view=cm&fs=1" +
        `&to=${encodeURIComponent(x.email)}` +
        `&su=${encodeURIComponent(subject)}` +
        `&body=${encodeURIComponent(body)}`;

      window.open(url, "_blank", "noopener");
    }

    function deleteMessage(id) {
      const x = data.find((z) => z.id === id);
      if (!x) return;

      if (!confirm("Delete this message?")) return;

      logEnquiryActivity(
        "ENQUIRY_DELETED",
        `Deleted message from ${x.name || "Unknown"} (${x.email || "-"})`,
        id
      );

      const db = window.db || (window.firebase && firebase.firestore && firebase.firestore());
      if (!db || !db.collection) return;

      db.collection("contactSubmissions")
        .doc(id)
        .delete()
        .then(() => {
          load();
        })
        .catch((err) => {
          renderError(err && err.message ? err.message : "Delete failed");
        });
    }

    function addTest() {
      const db = window.db || (window.firebase && firebase.firestore && firebase.firestore());
      if (!db || !db.collection) return;

      db.collection("contactSubmissions")
        .add({
          name: "Demo User",
          email: "demo@example.com",
          phone: "1234567890",
          subject: "Test message",
          message: "This is a test.",
          status: "new",
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => load())
        .catch(() => {});
    }

    function fill(id, v) {
      const el = document.getElementById(id);
      if (el) el.textContent = v;
    }

    // Event wiring (NO duplicate global handlers)
    if (manualRefresh) {
      manualRefresh.addEventListener("click", function () {
        load();
      });
    }

    if (testDataBtn) {
      testDataBtn.addEventListener("click", function () {
        addTest();
      });
    }

    if (statusFilter) {
      statusFilter.addEventListener("change", applyFilters);
    }

    if (dateFilter) {
      dateFilter.addEventListener("change", applyFilters);
    }

    if (closeModalBtn) {
      closeModalBtn.addEventListener("click", function () {
        M.style.display = "none";
      });
    }

    if (closeModalBtn2) {
      closeModalBtn2.addEventListener("click", function () {
        M.style.display = "none";
      });
    }

    // Close modal on backdrop click
    M.addEventListener("click", function (e) {
      if (e.target === M) {
        M.style.display = "none";
      }
    });

    // Gmail reply from inside modal (uses last opened message)
    if (gmailReplyBtn) {
      gmailReplyBtn.addEventListener("click", function () {
        if (currentMessageId) {
          replyMessage(currentMessageId);
        }
      });
    }

    // Delegate clicks from table (desktop)
    T.addEventListener("click", function (e) {
      const viewBtn = e.target.closest(".v");
      const replyBtn = e.target.closest(".r");
      const delBtn = e.target.closest(".d");

      if (viewBtn) {
        openMessage(viewBtn.dataset.id);
        return;
      }
      if (replyBtn) {
        replyMessage(replyBtn.dataset.id);
        return;
      }
      if (delBtn) {
        deleteMessage(delBtn.dataset.id);
        return;
      }
    });

    // Delegate clicks from mobile cards
    C.addEventListener("click", function (e) {
      const viewBtn = e.target.closest(".v");
      const replyBtn = e.target.closest(".r");
      const delBtn = e.target.closest(".d");

      if (viewBtn) {
        openMessage(viewBtn.dataset.id);
        return;
      }
      if (replyBtn) {
        replyMessage(replyBtn.dataset.id);
        return;
      }
      if (delBtn) {
        deleteMessage(delBtn.dataset.id);
        return;
      }
    });

    // Initial load
    load();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", start);
  } else {
    start();
  }
})();
</script>

</script>
