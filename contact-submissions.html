<!-- CONTACT SUBMISSIONS PAGE (for dynamic loading) -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --dark:#000;
  --light:#f5f5f5;
  --gray:#666;
  --border:#e0e0e0;
  --card-bg:rgba(255,255,255,0.95);
  --radius:12px;
  --shadow:0 4px 12px rgba(0,0,0,0.1);
}
*{box-sizing:border-box;margin:0;padding:0}

.page-container{max-width:1400px;margin:24px auto;padding:20px}
.page-title{font-family:'Outfit',sans-serif;font-size:1.9rem;font-weight:700}
.page-subtitle{color:var(--gray);margin-bottom:18px}

.filters-bar{
  background:var(--card-bg);box-shadow:var(--shadow);border-radius:var(--radius);
  padding:14px 16px;margin-bottom:20px;display:flex;flex-wrap:wrap;gap:16px
}
.filter-group{flex:1;min-width:180px;display:flex;flex-direction:column}
.filter-label{font-size:.8rem;color:var(--gray);margin-bottom:6px;font-weight:600}
.filter-select{
  padding:10px 12px;border-radius:8px;border:1px solid var(--border);
  background:var(--card-bg);font-size:.95rem;box-shadow:var(--shadow)
}

.table-container{
  background:var(--card-bg);border-radius:var(--radius);box-shadow:var(--shadow);
  overflow:hidden;margin-bottom:22px
}
table{width:100%;border-collapse:collapse;min-width:900px}
thead{background:rgba(0,0,0,0.04)}
th{padding:14px 16px;text-align:left;font-weight:600;font-size:.95rem;border-bottom:1px solid var(--border)}
td{padding:12px 16px;font-size:.95rem;border-bottom:1px solid var(--border);vertical-align:middle}
tr:hover{background:rgba(0,0,0,0.03)}

.user-info{display:flex;align-items:center;gap:12px}
.avatar{
  width:40px;height:40px;border-radius:50%;background:#000;color:#fff;
  display:flex;align-items:center;justify-content:center;font-weight:700
}

.status{padding:6px 14px;border-radius:25px;font-size:.75rem;font-weight:700;display:inline-block}
.status-new{background:#fff3f3;color:#b71c1c}
.status-read{background:#eaf4ff;color:#054a9b}
.status-replied{background:#e9fbef;color:#0f7a47}

.actions{display:flex;gap:8px}
.action-btn{
  width:38px;height:38px;border-radius:10px;background:rgba(0,0,0,0.06);
  border:none;display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:all .14s
}
.action-btn:hover{transform:translateY(-3px);background:rgba(0,0,0,0.12)}

.mobile-cards{display:none;flex-direction:column;gap:14px}
.card{
  background:var(--card-bg);padding:16px;border-radius:var(--radius);
  box-shadow:var(--shadow);display:flex;flex-direction:column;gap:10px
}
.card-row{display:flex;justify-content:space-between;align-items:center}
.card .meta{color:var(--gray);font-size:.85rem}

.modal{
  position:fixed;inset:0;display:none;background:rgba(0,0,0,0.45);
  backdrop-filter:blur(4px);align-items:center;justify-content:center;z-index:1200
}
.modal-content{
  background:var(--card-bg);width:100%;max-width:520px;border-radius:var(--radius);
  overflow:hidden;box-shadow:var(--shadow);animation:pop .2s ease
}

@keyframes pop{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

.modal-header{
  padding:16px;background:#000;color:#fff;display:flex;
  justify-content:space-between;align-items:center
}
.modal-body{padding:18px}

.detail-label{font-size:.8rem;color:var(--gray);margin-bottom:6px;font-weight:600}
.detail-value{
  background:rgba(0,0,0,0.04);padding:12px;border-radius:10px;margin-bottom:12px
}
.message-box{min-height:120px;max-height:300px;overflow:auto;white-space:pre-wrap}

.modal-footer{display:flex;gap:10px;justify-content:flex-end;padding:14px;border-top:1px solid var(--border)}

.btn{padding:9px 16px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
.btn-primary{background:#000;color:#fff}
.btn-secondary{background:rgba(0,0,0,0.07)}

.toast{
  position:fixed;right:20px;bottom:20px;background:var(--card-bg);
  padding:12px 16px;border-radius:12px;box-shadow:var(--shadow);
  display:flex;gap:10px;align-items:center;transform:translateY(24px);
  opacity:0;transition:.25s;z-index:1300
}
.toast.show{transform:none;opacity:1}

@media(max-width:1024px){.table-container{display:none}.mobile-cards{display:flex}}
@media(max-width:600px){.filters-bar{gap:10px}.filter-group{min-width:140px}}
</style>

<div class="page-container fade-in">

  <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
    <div>
      <div class="page-title">Contact Submissions</div>
      <div class="page-subtitle">Manage and respond to customer inquiries</div>
    </div>
  </div>

  <div class="filters-bar">
    <div class="filter-group">
      <div class="filter-label">Status</div>
      <select id="status-filter" class="filter-select">
        <option value="all">All</option>
        <option value="new">New</option>
        <option value="read">Read</option>
        <option value="replied">Replied</option>
      </select>
    </div>
    <div class="filter-group">
      <div class="filter-label">Date Range</div>
      <select id="date-filter" class="filter-select">
        <option value="all">All Time</option>
        <option value="today">Today</option>
        <option value="week">This Week</option>
        <option value="month">This Month</option>
      </select>
    </div>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Contact</th>
          <th>Subject</th>
          <th>Date</th>
          <th>Status</th>
          <th style="width:140px">Actions</th>
        </tr>
      </thead>
      <tbody id="submissions-table-body">
        <tr>
          <td colspan="5" style="text-align:center;padding:36px;color:var(--gray)">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div id="mobile-cards" class="mobile-cards"></div>
</div>

<!-- MODAL -->
<div id="submission-modal" class="modal" role="dialog" aria-modal="true">
  <div class="modal-content">
    <div class="modal-header">
      <div>Message Details</div>
      <button id="close-modal" class="btn-secondary btn"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">

      <div class="detail-label">Name</div>
      <div id="detail-name" class="detail-value">-</div>

      <div class="detail-label">Email</div>
      <div id="detail-email" class="detail-value">-</div>

      <div class="detail-label">Phone</div>
      <div id="detail-phone" class="detail-value">-</div>

      <div class="detail-label">Subject</div>
      <div id="detail-subject" class="detail-value">-</div>

      <div class="detail-label">Status</div>
      <div id="detail-status" class="detail-value">-</div>

      <div class="detail-label">Message</div>
      <div id="detail-message" class="detail-value message-box">-</div>

    </div>

    <div class="modal-footer">
      <button id="close-modal-2" class="btn-secondary btn">Close</button>
      <button id="gmail-reply-btn" class="btn btn-secondary">Reply via Gmail</button>
    </div>
  </div>
</div>

<div id="toast" class="toast">
  <i class="fas fa-check-circle"></i>
  <div id="toast-message">Updated</div>
</div>

<!-- FIREBASE + SCRIPT -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyDuF6bdqprddsE871GuOablXPYqXI_HJxc",
    authDomain: "hexahoney-96aed.firebaseapp.com",
    projectId: "hexahoney-96aed",
    storageBucket: "hexahoney-96aed.firebasestorage.app",
    messagingSenderId: "700458850837",
    appId: "1:700458850837:web:0eb4fca98a5f4acc2d0c1c",
    measurementId: "G-MQGKK9709H"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

const submissionsTableBody = document.getElementById("submissions-table-body");
const mobileCardsContainer = document.getElementById("mobile-cards");
const submissionModal = document.getElementById("submission-modal");

const closeModalBtn = document.getElementById("close-modal");
const closeModalBtn2 = document.getElementById("close-modal-2");

const gmailReplyBtn = document.getElementById("gmail-reply-btn");
const statusFilter = document.getElementById("status-filter");
const dateFilter = document.getElementById("date-filter");

const toast = document.getElementById("toast");
const toastMessage = document.getElementById("toast-message");

let currentSubmissions = [];
let filteredSubmissions = [];
let currentSubmissionId = null;

document.addEventListener("DOMContentLoaded", () => {
    loadSubmissions();
    setupListeners();
});


function loadSubmissions() {
    db.collection("contactSubmissions")
        .orderBy("timestamp", "desc")
        .get()
        .then((snapshot) => {
            currentSubmissions = [];

            snapshot.forEach((doc) => {
                const item = doc.data();
                item.id = doc.id;
                item.date = item.timestamp?.toDate
                    ? item.timestamp.toDate().toISOString()
                    : new Date().toISOString();

                if (!item.status) item.status = "new";
                currentSubmissions.push(item);
            });

            filteredSubmissions = [...currentSubmissions];

            renderTable();
            renderMobileCards();
        });
}

function renderTable() {
    if (filteredSubmissions.length === 0) {
        submissionsTableBody.innerHTML = `
            <tr><td colspan="5" style="text-align:center;padding:40px;color:#666;">
                <i class="fas fa-inbox" style="font-size:50px;color:#ccc;"></i>
                <p>No messages</p>
            </td></tr>
        `;
        return;
    }

    submissionsTableBody.innerHTML = filteredSubmissions.map((s) => {
        const initials = s.name ? s.name.split(" ").map(n => n[0]).join("") : "?";

        return `
        <tr>
            <td>
                <div class="user-info">
                    <div class="avatar">${initials}</div>
                    <div>
                        <div>${s.name}</div>
                        <div style="font-size:.8rem;color:#666">${s.email}</div>
                    </div>
                </div>
            </td>
            <td>${s.subject}</td>
            <td>${formatDate(s.date)}</td>
            <td><span class="status status-${s.status}">${formatStatus(s.status)}</span></td>
            <td>
                <div class="actions">
                    <button class="action-btn view-btn" data-id="${s.id}"><i class="fas fa-eye"></i></button>
                    <button class="action-btn reply-btn" data-id="${s.id}"><i class="fas fa-reply"></i></button>
                    <button class="action-btn delete-btn" data-id="${s.id}"><i class="fas fa-trash"></i></button>
                </div>
            </td>
        </tr>`;
    }).join("");
}

function renderMobileCards() {
    if (filteredSubmissions.length === 0) {
        mobileCardsContainer.innerHTML = `
            <div class="card" style="text-align:center;">
                <i class="fas fa-inbox" style="font-size:50px;color:#ccc;"></i>
                <p>No messages</p>
            </div>
        `;
        return;
    }

    mobileCardsContainer.innerHTML = filteredSubmissions.map((s) => {
        const initials = s.name ? s.name.split(" ").map(n => n[0]).join("") : "?";

        return `
        <div class="card">
            <div class="card-row">
                <div class="user-info">
                    <div class="avatar">${initials}</div>
                    <div>
                        <div>${s.name}</div>
                        <div style="font-size:.8rem;color:#666">${s.email}</div>
                    </div>
                </div>
                <span class="status status-${s.status}">${formatStatus(s.status)}</span>
            </div>

            <div>${s.subject}</div>
            <div style="font-size:.8rem;color:#666">${formatDate(s.date)}</div>

            <div class="card-row" style="justify-content:flex-end;">
                <button class="action-btn view-btn" data-id="${s.id}"><i class="fas fa-eye"></i></button>
                <button class="action-btn reply-btn" data-id="${s.id}"><i class="fas fa-reply"></i></button>
                <button class="action-btn delete-btn" data-id="${s.id}"><i class="fas fa-trash"></i></button>
            </div>
        </div>`;
    }).join("");
}

function setupListeners() {
    submissionsTableBody.addEventListener("click", handleActions);
    mobileCardsContainer.addEventListener("click", handleActions);

    closeModalBtn.addEventListener("click", closeModal);
    closeModalBtn2.addEventListener("click", closeModal);

    submissionModal.addEventListener("click", function (e) {
        if (e.target === submissionModal) closeModal();
    });

    document.querySelector(".modal-content").addEventListener("click", function (e) {
        e.stopPropagation();
    });

    gmailReplyBtn.addEventListener("click", replyEmail);

    statusFilter.addEventListener("change", applyFilters);
    dateFilter.addEventListener("change", applyFilters);
}

function handleActions(e) {
    const view = e.target.closest(".view-btn");
    const reply = e.target.closest(".reply-btn");
    const del = e.target.closest(".delete-btn");

    if (view) openModal(view.dataset.id);
    if (reply) replyEmailDirect(reply.dataset.id);
    if (del) deleteSubmission(reply?.dataset.id || del.dataset.id);
}

function openModal(id) {
    const s = currentSubmissions.find(x => x.id === id);
    if (!s) return;

    currentSubmissionId = id;

    document.getElementById("detail-name").textContent = s.name;
    document.getElementById("detail-email").textContent = s.email;
    document.getElementById("detail-phone").textContent = s.phone || "Not provided";
    document.getElementById("detail-subject").textContent = s.subject;
    document.getElementById("detail-status").textContent = formatStatus(s.status);
    document.getElementById("detail-message").textContent = s.message;

    submissionModal.style.display = "flex";

    if (s.status === "new") updateStatus(id, "read");
}

function closeModal() {
    submissionModal.style.display = "none";
    currentSubmissionId = null;
}

function replyEmail() {
    if (!currentSubmissionId) return;
    replyEmailDirect(currentSubmissionId);
}

function replyEmailDirect(id) {
    const s = currentSubmissions.find(x => x.id === id);
    if (!s) return;

    updateStatus(id, "replied");

    const sub = encodeURIComponent("Re: " + s.subject);
    const body = encodeURIComponent(
        "\n\n--- Original Message ---\n" +
        "From: " + s.name + " <" + s.email + ">\n" +
        "Subject: " + s.subject + "\n" +
        "Date: " + formatDate(s.date) + "\n\n" +
        s.message
    );

    const url =
        `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(s.email)}&su=${sub}&body=${body}`;

    window.open(url, "_blank");
}

function deleteSubmission(id) {
    if (!confirm("Delete this message?")) return;

    db.collection("contactSubmissions").doc(id).delete().then(() => {
        currentSubmissions = currentSubmissions.filter(s => s.id !== id);
        filteredSubmissions = filteredSubmissions.filter(s => s.id !== id);

        renderTable();
        renderMobileCards();
        showToast("Message deleted.");
    });
}

function applyFilters() {
    let list = [...currentSubmissions];

    if (statusFilter.value !== "all")
        list = list.filter(s => s.status === statusFilter.value);

    if (dateFilter.value !== "all") {
        const now = new Date();
        let start;

        if (dateFilter.value === "today")
            start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        else if (dateFilter.value === "week")
            start = new Date(now - 7 * 86400000);
        else if (dateFilter.value === "month")
            start = new Date(now - 30 * 86400000);

        list = list.filter(s => new Date(s.date) >= start);
    }

    filteredSubmissions = list;

    renderTable();
    renderMobileCards();
}

function updateStatus(id, status) {
    db.collection("contactSubmissions").doc(id).update({
        status,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    const idx = currentSubmissions.findIndex(s => s.id === id);
    if (idx !== -1) currentSubmissions[idx].status = status;

    const idx2 = filteredSubmissions.findIndex(s => s.id === id);
    if (idx2 !== -1) filteredSubmissions[idx2].status = status;

    renderTable();
    renderMobileCards();
}

function formatDate(d) {
    return new Date(d).toLocaleString("en-US", {
        month: "short", day: "numeric", year: "numeric",
        hour: "2-digit", minute: "2-digit"
    });
}

function formatStatus(s) {
    return s.charAt(0).toUpperCase() + s.slice(1);
}

function showToast(msg) {
    toastMessage.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 2500);
}
</script>
