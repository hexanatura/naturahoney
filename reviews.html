<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

.reviews-view {
  padding: 22px;
  background: #fff;
  min-height: 100vh;
}

.reviews-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  margin-bottom: 18px;
  flex-wrap: wrap;
}

.reviews-title {
  font-family: 'Outfit', sans-serif;
  font-size: 1.2rem;
  font-weight: 700;
  color: var(--dark);
}

.reviews-sub {
  font-size: 0.9rem;
  color: var(--muted);
  margin-top: 4px;
}

.reviews-controls {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.reviews-card {
  background: #fff;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 14px;
  border: 1px solid var(--border);
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.filter-select,
.search-box {
  padding: 10px 14px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: #fff;
  font-size: 0.95rem;
  min-width: 160px;
}

.search-box {
  display: flex;
  gap: 8px;
  align-items: center;
  min-width: 260px;
  max-width: 420px;
}

.search-box input {
  border: 0;
  outline: none;
  background: transparent;
  width: 100%;
  font-size: 0.95rem;
}

.btn-primary {
  background: var(--dark);
  color: var(--secondary);
  border-radius: 10px;
  padding: 9px 14px;
  border: none;
  cursor: pointer;
  font-weight: 700;
}

.btn-ghost {
  background: transparent;
  border: 1px solid var(--border);
  padding: 8px 12px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
}

.btn-success {
  background: var(--success);
  color: white;
  border-radius: 10px;
  padding: 9px 14px;
  border: none;
  cursor: pointer;
  font-weight: 700;
}

.btn-danger {
  background: var(--danger);
  color: white;
  border-radius: 10px;
  padding: 9px 14px;
  border: none;
  cursor: pointer;
  font-weight: 700;
}

.table-card {
  margin-top: 16px;
  background: #fff;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 16px;
  border: 1px solid var(--border);
}

.table-wrapper {
  overflow: auto;
  background: #fff;
}

.reviews-table {
  width: 100%;
  border-collapse: collapse;
  min-width: 900px;
  font-size: 0.95rem;
  background: #fff;
}

.reviews-table thead th {
  text-align: left;
  padding: 12px 16px;
  font-weight: 700;
  color: var(--dark);
  border-bottom: 1px solid var(--border);
  background: #fff;
}

.reviews-table td {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  vertical-align: middle;
  color: var(--dark);
  background: #fff;
}

.status-pill {
  display: inline-block;
  padding: 6px 10px;
  border-radius: 999px;
  font-weight: 700;
  font-size: 0.75rem;
}

.status-pending { background: rgba(245,158,11,0.08); color:#f59e0b; border:1px solid rgba(245,158,11,0.12); }
.status-approved { background: rgba(16,185,129,0.08); color:#10b981; border:1px solid rgba(16,185,129,0.12); }
.status-rejected { background: rgba(239,68,68,0.08); color:#ef4444; border:1px solid rgba(239,68,68,0.12); }

.rating-stars {
  display: flex;
  gap: 2px;
  color: #facc15;
}

.action-btn {
  border-radius: 8px;
  border: 0;
  padding: 8px;
  background: transparent;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-size: 0.95rem;
}

.action-btn .fa-check { color: var(--success); }
.action-btn .fa-times { color: var(--danger); }
.action-btn .fa-eye { color: var(--dark); }
.action-btn .fa-trash { color: var(--danger); }

.mobile-cards {
  display: none;
  gap: 12px;
  margin-top: 12px;
}

.review-card {
  background: #fff;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 14px;
  border: 1px solid var(--border);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.customer-name {
  font-weight: 600;
  color: var(--dark);
}

.card-meta {
  color: var(--muted);
  font-size: 0.85rem;
}

.review-content {
  margin: 8px 0;
  line-height: 1.4;
}

.review-modal-bg {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(6,8,15,0.6);
  z-index: 1200;
  padding: 20px;
}

.review-modal-bg.show {
  display: flex;
}

.review-modal {
  width: 100%;
  max-width: 600px;
  border-radius: 12px;
  overflow: hidden;
  background: #fff;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
}

.review-modal .modal-header,
.review-modal .modal-body,
.review-modal .modal-footer {
  padding: 14px 16px;
  background: #fff;
}

.empty-state {
  text-align: center;
  padding: 36px 12px;
  color: var(--muted);
}

.rv-toast {
  position: fixed;
  right: 22px;
  bottom: 22px;
  padding: 12px 16px;
  background: #fff;
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  border-left: 4px solid var(--success);
  z-index: 1400;
  display: flex;
  gap: 10px;
  align-items: center;
  transform: translateY(10px);
  opacity: 0;
  transition: all .2s ease;
}

.rv-toast.show {
  opacity: 1;
  transform: translateY(0);
}

.review-text {
  max-width: 300px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

@media (max-width:1023px) {
  .table-wrapper { display: none; }
  .mobile-cards { display: flex; flex-direction: column; }
  .reviews-controls { width: 100%; flex-direction: column; }
  .reviews-card { width: 100%; flex-direction: column; }
  .search-box, .filter-select {
    width: 100%;
    max-width: 100%;
  }
  .review-text {
    max-width: 200px;
  }
}

@media (max-width:768px) {
  .reviews-title { font-size: 1.1rem; }
  .reviews-sub { font-size: 0.85rem; }
  .reviews-card { padding: 12px; }
  .review-modal { width: 100%; max-width: 90%; }
  .review-text {
    max-width: 150px;
  }
}

@media (max-width:480px) {
  .reviews-view { padding: 14px; }
  .reviews-card { padding: 10px; }
  .reviews-table td,
  .reviews-table th {
    padding: 8px 10px;
  }
  .review-modal {
    width: calc(100% - 20px);
  }
  .review-text {
    max-width: 120px;
  }
}
</style>

</head>
<body>
  <div class="page-container">
    <div class="reviews-view fade-in">

      <div class="reviews-top">
        <div>
          <div class="reviews-title">Review Management</div>
          <div class="reviews-sub muted">Manage and moderate customer reviews</div>
        </div>

        <div class="reviews-controls">
          <div class="reviews-card filters-row">
            <select id="rv-status" class="filter-select" title="Filter by status">
              <option value="all">All Reviews</option>
              <option value="pending">Pending</option>
              <option value="approved">Approved</option>
              <option value="rejected">Rejected</option>
            </select>

            <select id="rv-rating" class="filter-select" title="Filter by rating">
              <option value="all">All Ratings</option>
              <option value="5">5 Stars</option>
              <option value="4">4+ Stars</option>
              <option value="3">3+ Stars</option>
              <option value="2">2+ Stars</option>
              <option value="1">1 Star</option>
            </select>

            <div class="search-box">
              <i class="fas fa-search muted"></i>
              <input id="rv-search" placeholder="Search customer, product, review text">
            </div>
          </div>

          <button id="rv-refresh" class="btn-ghost" title="Refresh"><i class="fas fa-sync-alt"></i></button>
          <button id="rv-export" class="btn-primary" title="Export reviews"><i class="fas fa-download" style="margin-right:8px"></i> Export</button>
        </div>
      </div>

      <div class="table-card">
        <div class="table-wrapper">
          <table class="reviews-table" aria-label="Reviews table">
            <thead>
              <tr>
                <th>Customer</th>
                <th>Product</th>
                <th>Rating</th>
                <th>Review</th>
                <th>Date</th>
                <th>Status</th>
                <th style="text-align:right">Actions</th>
              </tr>
            </thead>
            <tbody id="rv-tbody">
              <tr><td colspan="7" class="muted">Loading reviews…</td></tr>
            </tbody>
          </table>
        </div>

        <div class="mobile-cards" id="rv-cards" aria-hidden="true"></div>
      </div>

      <div class="review-modal-bg" id="rv-modal-bg" role="dialog" aria-hidden="true">
        <div class="review-modal" role="document" aria-modal="true">
          <div class="modal-header">
            <div style="font-weight:700" id="rv-modal-title">Review Details</div>
            <button id="rv-modal-close" class="btn-ghost" aria-label="Close"><i class="fas fa-times"></i></button>
          </div>

          <div class="modal-body" id="rv-modal-body"></div>

          <div class="modal-footer">
            <button id="rv-modal-reject" class="btn-danger"><i class="fas fa-times" style="margin-right:8px"></i> Reject</button>
            <button id="rv-modal-approve" class="btn-success"><i class="fas fa-check" style="margin-right:8px"></i> Approve</button>
            <button id="rv-modal-cancel" class="btn-ghost">Close</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div id="rv-toast" class="rv-toast" role="status" aria-live="polite">
    <i class="fas fa-check-circle" style="color:var(--success)"></i>
    <div id="rv-toast-text">Saved</div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
(function () {
  const config = {
    apiKey: "AIzaSyDuF6bdqprddsE871GuOablXPYqXI_HJxc",
    authDomain: "hexahoney-96aed.firebaseapp.com",
    projectId: "hexahoney-96aed",
    storageBucket: "hexahoney-96aed.firebasestorage.app",
    messagingSenderId: "700458850837",
    appId: "1:700458850837:web:0eb4fca98a5f4acc2d0c1c",
    measurementId: "G-MQGKK9709H",
  };

  if (window.firebase) {
    if (!firebase.apps.length) firebase.initializeApp(config);
  }

  const db = firebase.firestore();

  const t = document.getElementById("rv-tbody"),
    c = document.getElementById("rv-cards"),
    m = document.getElementById("rv-modal-bg"),
    mc = document.getElementById("rv-modal-close"),
    mca = document.getElementById("rv-modal-cancel"),
    mreject = document.getElementById("rv-modal-reject"),
    mapprove = document.getElementById("rv-modal-approve"),
    mb = document.getElementById("rv-modal-body"),
    fs = document.getElementById("rv-status"),
    fr = document.getElementById("rv-rating"),
    si = document.getElementById("rv-search"),
    rb = document.getElementById("rv-refresh"),
    xb = document.getElementById("rv-export"),
    tw = document.getElementById("rv-toast"),
    tt = document.getElementById("rv-toast-text");

  let reviews = [],
    filtered = [],
    editing = null;

  // Product data from your common.js
  const products = [
    { id: 1, name: "Natura Agmark Honey", weight: "1Kg" },
    { id: 2, name: "Natura Agmark Honey", weight: "500g" },
    { id: 3, name: "Natura Agmark Honey", weight: "100g" },
    { id: 4, name: "Natura Agmark Honey", weight: "50g" },
    { id: 5, name: "Natura Agmark Honey", weight: "1Kg" },
    { id: 6, name: "Natura Agmark Honey - Premium Pet", weight: "500g" }
  ];

  function toast(m, type = "success") {
    tt.textContent = m;
    tw.style.borderLeftColor = type === "success" ? "var(--success)" : "var(--danger)";
    tw.classList.add("show");
    setTimeout(() => tw.classList.remove("show"), 2600);
  }

  function esc(s) {
    return String(s || "").replace(/[&<>"']/g, (a) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;",
    }[a]));
  }

  function fdn(d) {
    if (!d) return "—";
    const x = d.toDate ? d.toDate() : new Date(d);
    return x.toLocaleDateString("en-IN");
  }

  function sc(s) {
    return "status-" + s;
  }

  function generateStars(rating) {
    let stars = '';
    for (let i = 1; i <= 5; i++) {
      if (i <= rating) {
        stars += '<i class="fas fa-star"></i>';
      } else if (i - 0.5 === rating) {
        stars += '<i class="fas fa-star-half-alt"></i>';
      } else {
        stars += '<i class="far fa-star"></i>';
      }
    }
    return stars;
  }

  function getProductName(productId) {
    const product = products.find(p => p.id === productId);
    return product ? `${product.name} - ${product.weight}` : `Product #${productId}`;
  }

  function load() {
    t.innerHTML = `<tr><td colspan="7" class="muted">Loading reviews…</td></tr>`;
    c.innerHTML = "";

    db.collection("reviews")
      .orderBy("createdAt", "desc")
      .onSnapshot((q) => {
        reviews = q.docs.map((d) => {
          const r = d.data();
          return {
            ...r,
            id: d.id,
            _customer: (r.userName || "").toLowerCase(),
            _product: getProductName(r.productId).toLowerCase(),
            _review: (r.reviewText || "").toLowerCase(),
            _created: r.createdAt?.toDate ? r.createdAt.toDate().getTime() : 0,
          };
        });
        apply();
      }, (err) => {
        empty();
        toast("Error loading reviews", "error");
      });
  }

  function empty() {
    t.innerHTML = `<tr><td colspan="7"><div class="empty-state">No Reviews Found</div></td></tr>`;
    c.innerHTML = `<div class="review-card muted">No reviews</div>`;
  }

  function list(x) {
    if (!x.length) {
      empty();
      return;
    }

    t.innerHTML = x
      .map((r) => {
        const productName = getProductName(r.productId);
        const reviewText = r.reviewText || "No review text";
        
        return `
          <tr data-id="${esc(r.id)}">
            <td>
              <div style="display:flex;gap:10px;align-items:center">
                <div style="width:36px;height:36px;border-radius:8px;background:#000;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600">
                  ${esc((r.userName || "C").slice(0, 2).toUpperCase())}
                </div>
                <div>
                  <div style="font-weight:600">${esc(r.userName || "Customer")}</div>
                  <div class="muted">${esc(r.userLocation || "—")}</div>
                </div>
              </div>
            </td>
            <td class="muted">${esc(productName)}</td>
            <td>
              <div class="rating-stars">
                ${generateStars(r.rating || 0)}
              </div>
            </td>
            <td>
              <div class="review-text" title="${esc(reviewText)}">${esc(reviewText)}</div>
            </td>
            <td class="muted">${fdn(r.createdAt)}</td>
            <td>
              <span class="status-pill ${sc(r.status)}">${esc(r.status || "pending")}</span>
            </td>
            <td style="text-align:right">
              <button class="action-btn view-btn" data-id="${r.id}">
                <i class="fas fa-eye"></i>
              </button>
              ${r.status === "pending" ? `
                <button class="action-btn approve-btn" data-id="${r.id}">
                  <i class="fas fa-check"></i>
                </button>
                <button class="action-btn reject-btn" data-id="${r.id}">
                  <i class="fas fa-times"></i>
                </button>
              ` : ""}
              <button class="action-btn delete-btn" data-id="${r.id}">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      })
      .join("");

    bind();
  }

  function bind() {
    document.querySelectorAll(".view-btn").forEach((b) => {
      b.onclick = (e) => open(e.currentTarget.dataset.id);
    });

    document.querySelectorAll(".approve-btn").forEach((b) => {
      b.onclick = (e) => approveReview(e.currentTarget.dataset.id);
    });

    document.querySelectorAll(".reject-btn").forEach((b) => {
      b.onclick = (e) => rejectReview(e.currentTarget.dataset.id);
    });

    document.querySelectorAll(".delete-btn").forEach((b) => {
      b.onclick = (e) => deleteReview(e.currentTarget.dataset.id);
    });
  }

  function open(id) {
    const r = reviews.find((x) => x.id === id);
    if (!r) return;

    editing = id;

    const productName = getProductName(r.productId);

    mb.innerHTML = `
      <div style="display:grid;gap:16px">
        <div>
          <div class="muted">Review ID</div>
          <div style="font-weight:700">#${esc(id.substring(0, 8))}</div>
        </div>

        <div style="display:flex;gap:12px">
          <div style="flex:1">
            <div class="muted">Customer</div>
            <div style="font-weight:600">${esc(r.userName || "Customer")}</div>
            <div class="muted">${esc(r.userLocation || "No location")}</div>
          </div>
          <div style="flex:1">
            <div class="muted">Product</div>
            <div>${esc(productName)}</div>
          </div>
        </div>

        <div style="display:flex;gap:12px">
          <div style="flex:1">
            <div class="muted">Rating</div>
            <div class="rating-stars" style="font-size:1.2rem">
              ${generateStars(r.rating || 0)}
            </div>
          </div>
          <div style="flex:1">
            <div class="muted">Date</div>
            <div>${fdn(r.createdAt)}</div>
          </div>
        </div>

        <div>
          <div class="muted">Status</div>
          <div>
            <span class="status-pill ${sc(r.status)}">${esc(r.status || "pending")}</span>
          </div>
        </div>

        <div>
          <div class="muted">Review Content</div>
          <div style="background:#f8f9fa;padding:12px;border-radius:8px;border:1px solid var(--border);margin-top:8px">
            ${esc(r.reviewText || "No review text provided")}
          </div>
        </div>
      </div>
    `;

    m.classList.add("show");
  }

  function close() {
    m.classList.remove("show");
    editing = null;
  }

  function approveReview(id) {
    if (!confirm("Approve this review? It will be visible on the website.")) return;
    
    db.collection("reviews").doc(id).update({
      status: "approved",
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      moderatedBy: firebase.auth().currentUser?.uid || "admin"
    })
    .then(() => {
      toast("Review approved and published");
    })
    .catch((err) => {
      console.error(err);
      toast("Failed to approve review", "error");
    });
  }

  function rejectReview(id) {
    if (!confirm("Reject this review? It will be hidden from the website.")) return;
    
    db.collection("reviews").doc(id).update({
      status: "rejected",
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      moderatedBy: firebase.auth().currentUser?.uid || "admin"
    })
    .then(() => {
      toast("Review rejected");
    })
    .catch((err) => {
      console.error(err);
      toast("Failed to reject review", "error");
    });
  }

  function deleteReview(id) {
    if (!confirm("Delete this review permanently? This action cannot be undone.")) return;
    
    db.collection("reviews").doc(id).delete()
    .then(() => {
      toast("Review deleted");
    })
    .catch((err) => {
      console.error(err);
      toast("Failed to delete review", "error");
    });
  }

  function apply() {
    let x = [...reviews];
    const st = fs.value;
    const rating = fr.value;
    const q = si.value.toLowerCase();

    // STATUS filter
    if (st !== "all") {
      x = x.filter(r => (r.status || "").toLowerCase() === st);
    }

    // RATING filter
    if (rating !== "all") {
      const minRating = parseInt(rating);
      x = x.filter(r => (r.rating || 0) >= minRating);
    }

    // SEARCH filter
    if (q) {
      x = x.filter(r => 
        r._customer.includes(q) ||
        r._product.includes(q) ||
        r._review.includes(q) ||
        r.id.toLowerCase().includes(q)
      );
    }

    filtered = x;
    list(x);
  }

  function csv(x) {
    if (!x.length) {
      toast("No reviews to export", "info");
      return;
    }

    const rows = [["Customer", "Location", "Product", "Rating", "Review", "Status", "Date"]];

    x.forEach((r) => {
      const productName = getProductName(r.productId);
      
      rows.push([
        r.userName || "Customer",
        r.userLocation || "",
        productName,
        r.rating || 0,
        r.reviewText || "",
        r.status || "pending",
        fdn(r.createdAt)
      ]);
    });

    const out = rows
      .map((r) => r.map((c) => `"${String(c).replace(/"/g, '""')}"`).join(","))
      .join("\n");

    const B = new Blob([out], { type: "text/csv" }),
      u = URL.createObjectURL(B),
      a = document.createElement("a");

    a.href = u;
    a.download = "reviews.csv";
    a.click();

    URL.revokeObjectURL(u);
    toast("Export started");
  }

  document.addEventListener("click", (e) => {
    if (e.target === m) close();
  });

  mc.onclick = close;
  mca.onclick = close;
  mreject.onclick = () => {
    if (editing) rejectReview(editing);
  };
  mapprove.onclick = () => {
    if (editing) approveReview(editing);
  };
  
  fs.onchange = apply;
  fr.onchange = apply;
  si.oninput = () => setTimeout(apply, 300);
  rb.onclick = () => {
    load();
    toast("Refreshing...", "info");
  };
  xb.onclick = () => csv(filtered.length ? filtered : reviews);

  load();
})();
</script>
