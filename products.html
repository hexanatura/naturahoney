
    <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    @media (max-width: 1023px) {
      .table-wrapper {
        display: none;
      }
      
      .mobile-cards {
        display: flex !important; 
        flex-direction: column;
        gap: 12px;
        margin-top: 12px;
      }
      
      .products-controls {
        width: 100%;
      }
      
      .products-card.filters-row {
        width: 100%;
        flex-direction: column;
      }
      
      .search-box, .filter-select {
        width: 100%;
        max-width: 100%;
      }
    }

    @media (min-width: 1024px) {
      .table-wrapper {
        display: block;
      }
      
      .mobile-cards {
        display: none !important;
      }
    }

    .products-view {
      width: 100%;
      padding: 20px;
      background: transparent;
      min-height: calc(100vh - 40px);
      font-family: 'Inter', sans-serif;
    }

    .products-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .products-title {
      font-family: 'Outfit', sans-serif;
      font-size: 1.45rem;
      font-weight: 700;
      color: var(--primary);
    }

    .modal-title-bold {
      font-weight: 700 !important;
      color: var(--primary);
      margin-bottom: 4px;
      font-size: 0.95rem;
    }

    .product-image-small {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      object-fit: cover;
      border: 1px solid var(--border);
      background: #f5f5f5;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .product-image-small:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .product-image-large {
      max-width: 90vw;
      max-height: 90vh;
      object-fit: contain;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .products-sub {
      font-size: 0.9rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .products-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* Card shells (match dashboard cards) */
    .products-card {
      background: #ffffff;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      padding: 14px;
      border: 1px solid var(--border);
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .products-card.filters-row {
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
    }

    .filter-select,
    .search-box {
      font-size: 0.92rem;
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: #ffffff;
    }

    .filter-select {
      min-width: 160px;
    }

    .search-box {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 260px;
      max-width: 420px;
    }

    .search-box input {
      border: 0;
      outline: none;
      background: transparent;
      width: 100%;
      font-size: 0.92rem;
    }

    /* Buttons – same style logic as dashboard */
    .btn-ghost {
      background: #ffffff;
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 600;
      box-shadow: var(--shadow-sm);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-ghost:hover {
      background: rgba(34, 197, 94, 0.08);
    }

    .btn-primary {
      background: var(--accent);
      color: #ffffff;
      border-radius: var(--radius-sm);
      padding: 9px 14px;
      border: 1px solid rgba(22, 163, 74, 0.7);
      cursor: pointer;
      font-weight: 700;
      box-shadow: var(--shadow-sm);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary:hover {
      box-shadow: var(--shadow-md);
    }

    .btn-secondary {
      background: var(--primary);
      color: #ffffff;
      border-radius: var(--radius-sm);
      padding: 9px 14px;
      border: 1px solid rgba(15, 23, 42, 0.7);
      cursor: pointer;
      font-weight: 700;
      box-shadow: var(--shadow-sm);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-secondary:hover {
      box-shadow: var(--shadow-md);
    }

    .table-card {
      margin-top: 16px;
      background: #ffffff;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding: 16px;
      border: 1px solid var(--border);
    }

    .table-wrapper {
      overflow-x: auto;
      margin-top: 12px;
    }

    .products-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px;
      font-size: 0.9rem;
    }

    .products-table thead th {
      text-align: left;
      padding: 12px 16px;
      font-weight: 700;
      color: var(--primary);
      border-bottom: 1px solid var(--border);
    }

    .products-table tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }

    .products-table tbody tr:hover {
      background: rgba(148, 163, 184, 0.08);
    }

    .products-table td {
      padding: 12px 16px;
      vertical-align: middle;
      color: var(--primary);
    }

    /* Stock Status Colors */
    .status-pill {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .status-in-stock { 
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      color: #065f46;
      border: 1px solid #34d399;
    }

    .status-low-stock { 
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      color: #92400e;
      border: 1px solid #fbbf24;
    }

    .status-out-of-stock { 
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      color: #991b1b;
      border: 1px solid #f87171;
    }

    .status-discontinued { 
      background: linear-gradient(135deg, #e5e7eb, #d1d5db);
      color: #4b5563;
      border: 1px solid #9ca3af;
    }

    .action-btn {
      border-radius: var(--radius-sm);
      border: 0;
      padding: 8px;
      cursor: pointer;
      background: transparent;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
    }

    .action-btn .fa-eye { color: var(--primary); }
    .action-btn .fa-edit { color: var(--success); }
    .action-btn .fa-trash { color: var(--danger); }

    /* Fixed: Action buttons container */
    .actions-container {
      display: flex;
      justify-content: flex-end;
      gap: 4px;
      align-items: center;
      width: 100%;
    }

    .mobile-cards {
      display: none;
      gap: 12px;
      margin-top: 12px;
    }

    .product-card-mobile {
      background: #ffffff;
      border-radius: var(--radius-md);
      padding: 16px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
      transition: all 0.2s ease;
    }

    .product-card-mobile:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .product-name {
      font-weight: 600;
      color: var(--primary);
    }

    .card-meta {
      color: var(--muted);
      font-size: 0.85rem;
    }

    .card-content {
      margin-bottom: 12px;
    }

    .card-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }

    .card-row:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .card-label {
      font-size: 0.8rem;
      color: var(--muted);
      font-weight: 500;
    }

    .card-value {
      font-size: 0.85rem;
      font-weight: 500;
    }

    .card-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      padding-top: 12px;
      border-top: 1px solid rgba(148, 163, 184, 0.2);
    }

    /* Empty State Styles */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .empty-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 1rem;
      margin-bottom: 8px;
    }

    .empty-state .muted {
      font-size: 0.9rem;
    }

    /* Loading State */
    .loading-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }

    .loading-spinner {
      font-size: 2rem;
      margin-bottom: 16px;
      color: var(--accent);
    }

    /* Error State */
    .error-state {
      text-align: center;
      padding: 40px 20px;
      color: #dc2626;
    }

    .error-icon {
      font-size: 2rem;
      margin-bottom: 16px;
    }

    /* Image Zoom Modal */
    .image-zoom-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }

    .image-zoom-modal.show {
      display: flex;
    }

    .image-zoom-content {
      position: relative;
      max-width: 95%;
      max-height: 95%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .image-zoom-close {
      position: absolute;
      top: -40px;
      right: 0;
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.2rem;
      transition: background 0.2s ease;
    }

    .image-zoom-close:hover {
      background: rgba(255,255,255,0.2);
    }

    .image-zoom-caption {
      position: absolute;
      bottom: -40px;
      left: 0;
      right: 0;
      text-align: center;
      color: white;
      font-size: 0.95rem;
      padding: 8px;
      background: rgba(0,0,0,0.7);
      border-radius: 6px;
    }

    /* Product Modal */
    .product-modal-bg {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.6);
      z-index: 1400;
      padding: 20px;
    }

    .product-modal-bg.show {
      display: flex;
    }

    .product-modal {
      width: 100%;
      max-width: 760px;
      max-height: 90vh;
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: #ffffff;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }

    .product-modal .modal-header {
      padding: 14px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      background: #f9fafb;
    }

    .product-modal .modal-body {
      padding: 16px;
      font-size: 0.92rem;
      overflow-y: auto;
      flex: 1;
    }

    .product-modal .modal-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      background: #f9fafb;
    }

    .flex-center {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .flex-column {
      display: flex;
      flex-direction: column;
    }

    .muted {
      color: var(--muted);
      font-size: 0.9rem;
    }

    /* Toast */
    .product-toast {
      position: fixed;
      right: 22px;
      bottom: 22px;
      padding: 12px 16px;
      background: #fff;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      border-left: 4px solid var(--success);
      z-index: 1400;
      display: flex;
      gap: 10px;
      align-items: center;
      transform: translateY(10px);
      opacity: 0;
      transition: all .2s ease;
    }

    .product-toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--primary);
      font-size: 0.9rem;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.92rem;
      transition: border-color 0.2s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
    }

    .form-textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.92rem;
      resize: vertical;
      min-height: 100px;
      font-family: 'Inter', sans-serif;
    }

    .form-select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.92rem;
      background: white;
      cursor: pointer;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    .form-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .form-checkbox input {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .form-checkbox label {
      margin: 0;
      font-weight: normal;
      cursor: pointer;
    }

    /* Product Preview Card in Modal */
    .product-preview-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-top: 20px;
      background: #f9fafb;
    }

    .product-preview-title {
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 12px;
      font-size: 1rem;
    }

    .product-preview-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 12px;
      background: #fff;
      border: 1px solid var(--border);
    }

    .preview-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      font-size: 0.85rem;
    }

    .preview-label {
      color: var(--muted);
      font-weight: 500;
    }

    .preview-value {
      color: var(--primary);
      font-weight: 600;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @media (max-width: 1023px) {
      .table-wrapper {
        display: none;
      }
      
      .mobile-cards {
        display: flex;
        flex-direction: column;
      }
      
      .products-controls {
        width: 100%;
      }
      
      .products-card.filters-row {
        width: 100%;
        flex-direction: column;
      }
      
      .search-box, .filter-select {
        width: 100%;
        max-width: 100%;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    @media (min-width: 1024px) {
      .table-wrapper {
        display: block;
      }
      
      .mobile-cards {
        display: none !important;
      }
    }

    @media (max-width: 768px) {
      .products-top {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .products-controls {
        width: 100%;
      }
      
      .products-view {
        padding: 16px;
      }
      
      .product-modal {
        max-width: 90%;
        max-height: 85vh;
      }
    }

    @media (max-width: 480px) {
      .products-view {
        padding: 14px;
      }
      
      .products-card {
        padding: 12px;
      }
      
      .product-modal {
        max-width: calc(100% - 20px);
        max-height: 80vh;
      }
      
      .product-image-large {
        max-width: 100%;
        max-height: 80vh;
      }
    }
    </style>
</head>
<body>
<div class="page-container">
  <div class="products-view fade-in">

    <div class="products-top">
      <div>
        <div class="products-title">Product Management</div>
        <div class="products-sub muted">Manage your honey products inventory and details</div>
      </div>

      <div class="products-controls">
        <div class="products-card filters-row">
          <select id="pv-status" class="filter-select" title="Filter by status">
            <option value="all">All Products</option>
            <option value="in-stock">In Stock</option>
            <option value="low-stock">Low Stock</option>
            <option value="out-of-stock">Out of Stock</option>
            <option value="discontinued">Discontinued</option>
          </select>

          <select id="pv-category" class="filter-select" title="Filter by category">
            <option value="all">All Categories</option>
            <option value="crystal">Crystal Pack</option>
            <option value="premium">Premium Pet</option>
            <option value="raw">Raw Honey</option>
            <option value="flavored">Flavored Honey</option>
          </select>

          <div class="search-box">
            <i class="fas fa-search muted"></i>
            <input id="pv-search" placeholder="Search product name, SKU, description">
          </div>
        </div>

        <button id="pv-refresh" class="btn-ghost" title="Refresh"><i class="fas fa-sync-alt"></i></button>
        <button id="pv-add" class="btn-primary" title="Add new product"><i class="fas fa-plus" style="margin-right:8px"></i> Add Product</button>
      </div>
    </div>

    <div class="table-card">
      <div class="table-wrapper">
        <table class="products-table" aria-label="Products table">
          <thead>
            <tr>
              <th>Product</th>
              <th>SKU</th>
              <th>Category</th>
              <th>Price</th>
              <th>Stock</th>
              <th>Status</th>
              <th style="text-align:right">Actions</th>
            </tr>
          </thead>
          <tbody id="pv-tbody">
            <tr><td colspan="7" class="muted">Loading products…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="mobile-cards" id="pv-cards" aria-hidden="true"></div>
    </div>

    <!-- Product Image Zoom Modal -->
    <div class="image-zoom-modal" id="imageZoomModal">
      <div class="image-zoom-content">
        <button class="image-zoom-close" id="imageZoomClose" aria-label="Close zoom">
          <i class="fas fa-times"></i>
        </button>
        <img id="zoomedImage" class="product-image-large" alt="Product image" />
        <div id="imageCaption" class="image-zoom-caption"></div>
      </div>
    </div>

    <!-- Product Details/Edit Modal -->
    <div class="product-modal-bg" id="pv-modal-bg" role="dialog" aria-hidden="true">
      <div class="product-modal" role="document" aria-modal="true">
        <div class="modal-header">
          <div style="font-weight:700" id="pv-modal-title">Add New Product</div>
          <button id="pv-modal-close" class="btn-ghost" aria-label="Close"><i class="fas fa-times"></i></button>
        </div>

        <div class="modal-body" id="pv-modal-body">
          <!-- Form will be loaded here dynamically -->
        </div>

        <div class="modal-footer">
          <button id="pv-modal-cancel" class="btn-ghost">Cancel</button>
          <button id="pv-modal-save" class="btn-primary"><i class="fas fa-save" style="margin-right:8px"></i> Save Product</button>
        </div>
      </div>
    </div>

  </div>
</div>

<div id="product-toast" class="product-toast" role="status" aria-live="polite">
  <i class="fas fa-check-circle" style="color:var(--success)"></i>
  <div id="product-toast-text">Saved</div>
</div>

<script>
(function () {
  // Configuration
  const db = firebase.firestore();
  const PRODUCTS_COLLECTION = 'products';
  const DEFAULT_IMAGE = 'https://ik.imagekit.io/hexaanatura/Gemini_Generated_Image_gyalrfgyalrfgyal.jpg?updatedAt=1757217705022';
  
  let products = [];
  let filtered = [];
  let editingId = null;
  let productsListener = null;
  let isSubmitting = false;

  // DOM Elements
  const tbody = document.getElementById("pv-tbody");
  const cards = document.getElementById("pv-cards");
  const modal = document.getElementById("pv-modal-bg");
  const modalClose = document.getElementById("pv-modal-close");
  const modalCancel = document.getElementById("pv-modal-cancel");
  const modalSave = document.getElementById("pv-modal-save");
  const modalBody = document.getElementById("pv-modal-body");
  const modalTitle = document.getElementById("pv-modal-title");
  const statusFilter = document.getElementById("pv-status");
  const categoryFilter = document.getElementById("pv-category");
  const searchInput = document.getElementById("pv-search");
  const refreshBtn = document.getElementById("pv-refresh");
  const addBtn = document.getElementById("pv-add");
  const toast = document.getElementById("product-toast");
  const toastText = document.getElementById("product-toast-text");
  const imgZoomModal = document.getElementById("imageZoomModal");
  const imgZoomClose = document.getElementById("imageZoomClose");
  const zoomedImage = document.getElementById("zoomedImage");
  const imageCaption = document.getElementById("imageCaption");

  // Utility Functions
  function showToast(message, type = "success") {
    toastText.textContent = message;
    toast.style.borderLeftColor = type === "success" ? "var(--success)" : "var(--danger)";
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 3000);
  }

  function esc(text) {
    return String(text || "").replace(/[&<>"']/g, char => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;",
    }[char]));
  }

  function formatPrice(price) {
    return `₹${Number(price || 0).toFixed(2)}`;
  }

  function getStockStatusClass(stock) {
    if (stock === 0) return 'status-out-of-stock';
    if (stock <= 10) return 'status-low-stock';
    return 'status-in-stock';
  }

  function getStockStatusText(stock) {
    if (stock === 0) return 'Out of Stock';
    if (stock <= 10) return 'Low Stock';
    return 'In Stock';
  }

  function openImageZoom(imageSrc, altText) {
    zoomedImage.src = imageSrc;
    imageCaption.textContent = altText || "Product Image";
    imgZoomModal.classList.add("show");
    document.body.style.overflow = 'hidden';
  }

  function closeImageZoom() {
    imgZoomModal.classList.remove("show");
    document.body.style.overflow = 'auto';
  }

  // Image Zoom Event Listeners
  imgZoomModal.addEventListener('click', function (e) {
    if (e.target === imgZoomModal || e.target.closest('#imageZoomClose')) {
      closeImageZoom();
    }
  });

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && imgZoomModal.classList.contains('show')) {
      closeImageZoom();
    }
  });

  // Load Products
  function loadProducts() {
    tbody.innerHTML = `<tr><td colspan="7" class="muted">Loading products…</td></tr>`;
    cards.innerHTML = `<div class="loading-state">
      <i class="fas fa-spinner fa-spin loading-spinner"></i>
      <p>Loading products...</p>
    </div>`;

    // Set up real-time listener
    if (productsListener) {
      productsListener();
    }

    productsListener = db.collection(PRODUCTS_COLLECTION)
      .orderBy('createdAt', 'desc')
      .onSnapshot(snapshot => {
        if (snapshot.empty) {
          showEmptyState();
          return;
        }

        products = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data(),
          createdAt: doc.data().createdAt || firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: doc.data().updatedAt || firebase.firestore.FieldValue.serverTimestamp()
        }));

        applyFilters();
      }, error => {
        console.error("Error loading products:", error);
        showErrorState(error.message);
      });
  }

  function showEmptyState() {
    tbody.innerHTML = `<tr><td colspan="7">
      <div class="empty-state">
        <i class="fas fa-box-open empty-icon"></i>
        <p>No Products Found</p>
        <div class="muted">Click "Add Product" to create your first product</div>
      </div>
    </td></tr>`;
    
    cards.innerHTML = `<div class="empty-state">
      <i class="fas fa-box-open empty-icon"></i>
      <p>No Products Found</p>
      <div class="muted">Start by adding your first product</div>
    </div>`;
  }

  function showErrorState(message) {
    tbody.innerHTML = `<tr><td colspan="7">
      <div class="error-state">
        <i class="fas fa-exclamation-triangle error-icon"></i>
        <p>Error Loading Products</p>
        <div class="muted">${esc(message)}</div>
      </div>
    </td></tr>`;
    
    cards.innerHTML = `<div class="error-state">
      <i class="fas fa-exclamation-triangle error-icon"></i>
      <p>Error Loading Products</p>
      <div class="muted">Please try refreshing</div>
    </div>`;
  }

  // Filter Products
  function applyFilters() {
    let filteredProducts = [...products];
    
    const status = statusFilter.value;
    const category = categoryFilter.value;
    const search = searchInput.value.toLowerCase().trim();

    // Filter by status
    if (status !== 'all') {
      filteredProducts = filteredProducts.filter(product => {
        if (status === 'in-stock') return product.stock > 10;
        if (status === 'low-stock') return product.stock > 0 && product.stock <= 10;
        if (status === 'out-of-stock') return product.stock === 0;
        if (status === 'discontinued') return product.status === 'discontinued';
        return true;
      });
    }

    // Filter by category
    if (category !== 'all') {
      filteredProducts = filteredProducts.filter(product => 
        product.category === category
      );
    }

    // Filter by search
    if (search) {
      filteredProducts = filteredProducts.filter(product =>
        product.name.toLowerCase().includes(search) ||
        product.sku?.toLowerCase().includes(search) ||
        product.description?.toLowerCase().includes(search)
      );
    }

    filtered = filteredProducts;
    renderProducts(filteredProducts);
  }

  // Render Products
  function renderProducts(productsList) {
    if (productsList.length === 0) {
      showEmptyState();
      return;
    }

    // Render table view
    tbody.innerHTML = productsList.map(product => `
      <tr data-id="${esc(product.id)}">
        <td>
          <div class="flex-center">
            <img src="${esc(product.image || DEFAULT_IMAGE)}" 
                 alt="${esc(product.name)}"
                 class="product-image-small"
                 data-image="${esc(product.image || DEFAULT_IMAGE)}"
                 data-name="${esc(product.name)}"
                 onerror="this.onerror=null; this.src='${DEFAULT_IMAGE}'">
            <div>
              <div style="font-weight:700">${esc(product.name)}</div>
              <div class="muted" style="font-size:0.75rem">${esc(product.weight || '')}</div>
            </div>
          </div>
        </td>
        <td>
          <div style="font-family:monospace;font-weight:600">${esc(product.sku || 'N/A')}</div>
          <div class="muted" style="font-size:0.75rem">ID: ${esc(product.id.substring(0, 8))}</div>
        </td>
        <td>
          <div style="padding:4px 8px;background:#f3f4f6;border-radius:6px;font-size:0.8rem;font-weight:600;display:inline-block;text-transform:capitalize">
            ${esc(product.category || 'uncategorized')}
          </div>
        </td>
        <td style="font-weight:700">${formatPrice(product.price)}</td>
        <td>
          <div style="font-weight:600;margin-bottom:4px">${product.stock || 0} units</div>
          <span class="status-pill ${getStockStatusClass(product.stock)}">
            ${getStockStatusText(product.stock)}
          </span>
        </td>
        <td>
          <div style="padding:4px 8px;background:${product.featured ? '#fef3c7' : '#f3f4f6'};border-radius:6px;font-size:0.8rem;font-weight:600;display:inline-block">
            ${product.featured ? 'Featured ★' : 'Standard'}
          </div>
        </td>
        <td style="text-align:right">
          <div class="actions-container">
            <button class="action-btn view-btn" data-id="${product.id}" title="View Details">
              <i class="fas fa-eye"></i>
            </button>
            <button class="action-btn edit-btn" data-id="${product.id}" title="Edit Product">
              <i class="fas fa-edit"></i>
            </button>
            <button class="action-btn delete-btn" data-id="${product.id}" title="Delete Product">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
      </tr>
    `).join('');

    // Render mobile cards view
    cards.innerHTML = productsList.map(product => `
      <div class="product-card-mobile" data-id="${product.id}">
        <div class="card-header">
          <div>
            <div class="product-name">${esc(product.name)}</div>
            <div class="card-muted">${esc(product.sku || 'No SKU')} • ${esc(product.weight || '')}</div>
          </div>
          <span class="status-pill ${getStockStatusClass(product.stock)}">
            ${getStockStatusText(product.stock)}
          </span>
        </div>
        
        <div class="card-content">
          <div class="card-row">
            <span class="card-label">Category</span>
            <span class="card-value" style="text-transform:capitalize">${esc(product.category || 'uncategorized')}</span>
          </div>
          <div class="card-row">
            <span class="card-label">Price</span>
            <span class="card-value" style="font-weight:700">${formatPrice(product.price)}</span>
          </div>
          <div class="card-row">
            <span class="card-label">Stock</span>
            <span class="card-value">${product.stock || 0} units</span>
          </div>
          <div class="card-row">
            <span class="card-label">Status</span>
            <span class="card-value">${product.featured ? 'Featured ★' : 'Standard'}</span>
          </div>
        </div>
        
        <div class="card-actions">
          <button class="btn-ghost view-btn-mobile" data-id="${product.id}" style="font-size:0.85rem;padding:8px 12px;">
            <i class="fas fa-eye" style="margin-right:6px"></i>View
          </button>
          <button class="btn-primary edit-btn-mobile" data-id="${product.id}" style="font-size:0.85rem;padding:8px 12px;">
            <i class="fas fa-edit" style="margin-right:6px"></i>Edit
          </button>
        </div>
      </div>
    `).join('');

    // Bind event listeners
    bindEventListeners();
  }

  function bindEventListeners() {
    // Desktop view buttons
    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.onclick = (e) => {
        const productId = e.currentTarget.dataset.id;
        openProductModal(productId);
      };
    });

    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.onclick = (e) => {
        const productId = e.currentTarget.dataset.id;
        openProductModal(productId, true);
      };
    });

    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.onclick = (e) => {
        const productId = e.currentTarget.dataset.id;
        deleteProduct(productId);
      };
    });

    // Mobile view buttons
    document.querySelectorAll('.view-btn-mobile').forEach(btn => {
      btn.onclick = (e) => {
        e.stopPropagation();
        const productId = e.currentTarget.dataset.id;
        openProductModal(productId);
      };
    });

    document.querySelectorAll('.edit-btn-mobile').forEach(btn => {
      btn.onclick = (e) => {
        e.stopPropagation();
        const productId = e.currentTarget.dataset.id;
        openProductModal(productId, true);
      };
    });

    // Image click handlers
    document.querySelectorAll('.product-image-small[data-image]').forEach(img => {
      img.addEventListener('click', function(e) {
        e.stopPropagation();
        const imageSrc = this.getAttribute('data-image');
        const imageName = this.getAttribute('data-name');
        openImageZoom(imageSrc, imageName);
      });
    });

    // Make mobile cards clickable for view
    document.querySelectorAll('.product-card-mobile[data-id]').forEach(card => {
      card.addEventListener('click', function(e) {
        if (!e.target.closest('.btn-ghost') && 
            !e.target.closest('.btn-primary') && 
            !e.target.closest('.status-pill')) {
          const productId = this.dataset.id;
          openProductModal(productId);
        }
      });
    });
  }

  // Open Product Modal
  async function openProductModal(productId = null, isEdit = false) {
    editingId = productId;
    let productData = null;

    if (productId) {
      // Fetch existing product
      try {
        const doc = await db.collection(PRODUCTS_COLLECTION).doc(productId).get();
        if (doc.exists) {
          productData = doc.data();
          modalTitle.textContent = isEdit ? 'Edit Product' : 'Product Details';
        } else {
          showToast('Product not found', 'error');
          return;
        }
      } catch (error) {
        console.error('Error fetching product:', error);
        showToast('Error loading product', 'error');
        return;
      }
    } else {
      // New product
      modalTitle.textContent = 'Add New Product';
    }

    // Generate form HTML
    const formHtml = generateProductForm(productData, isEdit);
    modalBody.innerHTML = formHtml;

    // Show modal
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';

    // If view mode, disable all inputs
    if (productId && !isEdit) {
      modalBody.querySelectorAll('input, select, textarea').forEach(input => {
        input.disabled = true;
      });
      modalSave.style.display = 'none';
    } else {
      modalSave.style.display = 'block';
    }

    // Bind form preview
    bindFormPreview();
  }

  function generateProductForm(productData = null, isEdit = true) {
    const data = productData || {};
    const isNew = !productData;
    
    return `
      <div style="display:grid;gap:16px;">
        <!-- Basic Information -->
        <div>
          <div class="modal-title-bold">Basic Information</div>
          <div class="form-row">
            <div class="form-group">
              <label for="product-name">Product Name *</label>
              <input type="text" id="product-name" class="form-input" 
                     value="${esc(data.name || '')}" 
                     placeholder="e.g., Natura Agmark Honey - 1Kg" required>
            </div>
            <div class="form-group">
              <label for="product-sku">SKU (Stock Keeping Unit)</label>
              <input type="text" id="product-sku" class="form-input" 
                     value="${esc(data.sku || '')}" 
                     placeholder="e.g., NAT-HNY-001">
            </div>
          </div>
        </div>

        <!-- Pricing & Stock -->
        <div>
          <div class="modal-title-bold">Pricing & Stock</div>
          <div class="form-row">
            <div class="form-group">
              <label for="product-price">Price (₹) *</label>
              <input type="number" id="product-price" class="form-input" 
                     value="${data.price || ''}" 
                     placeholder="e.g., 420.00" step="0.01" min="0" required>
            </div>
            <div class="form-group">
              <label for="product-stock">Stock Quantity *</label>
              <input type="number" id="product-stock" class="form-input" 
                     value="${data.stock || 0}" 
                     placeholder="e.g., 100" min="0" required>
            </div>
          </div>
        </div>

        <!-- Category & Weight -->
        <div>
          <div class="modal-title-bold">Category & Details</div>
          <div class="form-row">
            <div class="form-group">
              <label for="product-category">Category *</label>
              <select id="product-category" class="form-select" required>
                <option value="">Select Category</option>
                <option value="crystal" ${data.category === 'crystal' ? 'selected' : ''}>Crystal Pack</option>
                <option value="premium" ${data.category === 'premium' ? 'selected' : ''}>Premium Pet</option>
                <option value="raw" ${data.category === 'raw' ? 'selected' : ''}>Raw Honey</option>
                <option value="flavored" ${data.category === 'flavored' ? 'selected' : ''}>Flavored Honey</option>
                <option value="other" ${data.category === 'other' ? 'selected' : ''}>Other</option>
              </select>
            </div>
            <div class="form-group">
              <label for="product-weight">Weight/Size</label>
              <input type="text" id="product-weight" class="form-input" 
                     value="${esc(data.weight || '')}" 
                     placeholder="e.g., 1Kg, 500g, 250g">
            </div>
          </div>
        </div>

        <!-- Product Image -->
        <div>
          <div class="modal-title-bold">Product Image</div>
          <div class="form-row">
            <div class="form-group">
              <label for="product-image">Image URL</label>
              <input type="url" id="product-image" class="form-input" 
                     value="${esc(data.image || '')}" 
                     placeholder="https://example.com/image.jpg">
              <div class="muted" style="margin-top:4px">Recommended: 800x800px or larger</div>
            </div>
            <div class="form-group">
              <label>Preview</label>
              <div style="margin-top:4px">
                <img id="image-preview" 
                     src="${data.image || DEFAULT_IMAGE}" 
                     alt="Preview" 
                     style="width:60px;height:60px;object-fit:cover;border-radius:8px;border:1px solid var(--border);cursor:pointer"
                     onerror="this.onerror=null; this.src='${DEFAULT_IMAGE}'">
              </div>
            </div>
          </div>
        </div>

        <!-- Product Description -->
        <div>
          <div class="modal-title-bold">Description</div>
          <div class="form-group">
            <label for="product-description">Product Description</label>
            <textarea id="product-description" class="form-textarea" 
                      placeholder="Describe your product...">${esc(data.description || '')}</textarea>
          </div>
        </div>

        <!-- Product Status -->
        <div>
          <div class="modal-title-bold">Status & Features</div>
          <div class="form-row">
            <div class="form-group">
              <div class="form-checkbox">
                <input type="checkbox" id="product-featured" ${data.featured ? 'checked' : ''}>
                <label for="product-featured">Featured Product</label>
              </div>
            </div>
            <div class="form-group">
              <div class="form-checkbox">
                <input type="checkbox" id="product-active" ${data.active === false ? '' : 'checked'}>
                <label for="product-active">Active (visible in shop)</label>
              </div>
            </div>
          </div>
        </div>

        <!-- Product Preview -->
        <div class="product-preview-card">
          <div class="product-preview-title">Preview</div>
          <img id="preview-image" 
               src="${data.image || DEFAULT_IMAGE}" 
               alt="Product Preview" 
               class="product-preview-image"
               onerror="this.onerror=null; this.src='${DEFAULT_IMAGE}'">
          
          <div class="preview-details">
            <div>
              <div class="preview-label">Name</div>
              <div class="preview-value" id="preview-name">${esc(data.name || 'New Product')}</div>
            </div>
            <div>
              <div class="preview-label">Price</div>
              <div class="preview-value" id="preview-price">${formatPrice(data.price || 0)}</div>
            </div>
            <div>
              <div class="preview-label">Stock</div>
              <div class="preview-value" id="preview-stock">${data.stock || 0} units</div>
            </div>
            <div>
              <div class="preview-label">Status</div>
              <div class="preview-value" id="preview-status">${data.featured ? 'Featured ★' : 'Standard'}</div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function bindFormPreview() {
    const formInputs = ['product-name', 'product-price', 'product-stock', 'product-image', 'product-featured'];
    
    formInputs.forEach(inputId => {
      const input = document.getElementById(inputId);
      if (input) {
        input.addEventListener('input', updatePreview);
        input.addEventListener('change', updatePreview);
      }
    });
    
    // Initial preview update
    updatePreview();
    
    // Image preview click
    const previewImage = document.getElementById('image-preview');
    if (previewImage) {
      previewImage.addEventListener('click', function() {
        openImageZoom(this.src, 'Product Image Preview');
      });
    }
  }

  function updatePreview() {
    const name = document.getElementById('product-name')?.value || 'New Product';
    const price = document.getElementById('product-price')?.value || 0;
    const stock = document.getElementById('product-stock')?.value || 0;
    const image = document.getElementById('product-image')?.value || DEFAULT_IMAGE;
    const featured = document.getElementById('product-featured')?.checked || false;

    // Update preview elements
    const previewName = document.getElementById('preview-name');
    const previewPrice = document.getElementById('preview-price');
    const previewStock = document.getElementById('preview-stock');
    const previewStatus = document.getElementById('preview-status');
    const previewImage = document.getElementById('preview-image');
    const imagePreview = document.getElementById('image-preview');

    if (previewName) previewName.textContent = esc(name);
    if (previewPrice) previewPrice.textContent = formatPrice(price);
    if (previewStock) previewStock.textContent = `${stock} units`;
    if (previewStatus) previewStatus.textContent = featured ? 'Featured ★' : 'Standard';
    if (previewImage) previewImage.src = image;
    if (imagePreview) imagePreview.src = image;
  }

  // Save Product
  async function saveProduct() {
    if (isSubmitting) return;
    
    const name = document.getElementById('product-name')?.value.trim();
    const price = parseFloat(document.getElementById('product-price')?.value);
    const stock = parseInt(document.getElementById('product-stock')?.value);
    
    // Basic validation
    if (!name) {
      showToast('Product name is required', 'error');
      return;
    }
    
    if (isNaN(price) || price < 0) {
      showToast('Valid price is required', 'error');
      return;
    }
    
    if (isNaN(stock) || stock < 0) {
      showToast('Valid stock quantity is required', 'error');
      return;
    }

    isSubmitting = true;
    const saveButton = modalSave;
    const originalText = saveButton.innerHTML;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right:8px"></i> Saving...';
    saveButton.disabled = true;

    try {
      const productData = {
        name: name,
        sku: document.getElementById('product-sku')?.value.trim() || '',
        price: price,
        stock: stock,
        category: document.getElementById('product-category')?.value || 'other',
        weight: document.getElementById('product-weight')?.value.trim() || '',
        image: document.getElementById('product-image')?.value.trim() || DEFAULT_IMAGE,
        description: document.getElementById('product-description')?.value.trim() || '',
        featured: document.getElementById('product-featured')?.checked || false,
        active: document.getElementById('product-active')?.checked !== false,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      if (editingId) {
        // Update existing product
        await db.collection(PRODUCTS_COLLECTION).doc(editingId).update(productData);
        showToast('Product updated successfully');
      } else {
        // Add new product
        productData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        await db.collection(PRODUCTS_COLLECTION).add(productData);
        showToast('Product added successfully');
      }

      closeModal();
      
    } catch (error) {
      console.error('Error saving product:', error);
      showToast('Error saving product: ' + error.message, 'error');
    } finally {
      isSubmitting = false;
      saveButton.innerHTML = originalText;
      saveButton.disabled = false;
    }
  }

  // Delete Product
  async function deleteProduct(productId) {
    if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
      return;
    }

    try {
      await db.collection(PRODUCTS_COLLECTION).doc(productId).delete();
      showToast('Product deleted successfully');
    } catch (error) {
      console.error('Error deleting product:', error);
      showToast('Error deleting product', 'error');
    }
  }

  function closeModal() {
    modal.classList.remove('show');
    document.body.style.overflow = 'auto';
    editingId = null;
    modalBody.innerHTML = '';
  }

  // Event Listeners Setup
  function setupEventListeners() {
    // Modal controls
    modalClose.onclick = closeModal;
    modalCancel.onclick = closeModal;
    modalSave.onclick = saveProduct;
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    // Filter controls
    statusFilter.onchange = applyFilters;
    categoryFilter.onchange = applyFilters;
    searchInput.oninput = debounce(applyFilters, 300);

    // Button controls
    refreshBtn.onclick = () => {
      loadProducts();
      showToast('Refreshing products...', 'info');
    };

    addBtn.onclick = () => openProductModal(null, true);
  }

  // Debounce function
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // Initialize
  function init() {
    setupEventListeners();
    loadProducts();
    
    // Make global functions available for inline handlers
    window.openImageZoom = openImageZoom;
  }

  // Start the application
  init();

})();
</script>
